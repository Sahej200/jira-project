{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13629404", "self": "https://issues.apache.org/jira/rest/api/2/issue/13629404", "key": "KAFKA-19724", "fields": {"summary": "Global stream thread ignores all exceptions", "description": "{{globalStreamThread}} in {{KafkaStreams}} class ignores all exceptions and fails to apply the user-provided {{StreamsUncaughtExceptionHandler}} in:\r\n{code:java}\r\npublic void setUncaughtExceptionHandler(final StreamsUncaughtExceptionHandler userStreamsUncaughtExceptionHandler)\r\n{code}\r\nThis can lead to streams being stuck in faulty state after an exception is thrown during their initialization phase (e.g. failure to load the RocksDB native library). The exception isn't logged, so debugging such problem is difficult.\r\n\r\nFrom my understanding of the\u00a0{{b62d8b97}} commit message, the following code is unnecessary as the {{globalStreamThread}} can't be replaced and the issue description from KAFKA-12699 doesn't apply to it. Removing it should help.\r\n{code:java}\r\nif (globalStreamThread != null) {\r\n    globalStreamThread.setUncaughtExceptionHandler((t, e) -> { }\r\n    );\r\n}\r\n{code}", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18021470", "id": "18021470", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Thanks for reporting the issue. \u2013 Not logging some exception is for sure a problem. This should be easy to fix.\r\n\r\nWhile I agree that `globalStreamThread.setUncaughtExceptionHandler((t, e) -> \\{ });` is not useful any longer, I don't think removing this code solves the problem. \u2013 In older version of KS, we use the Java uncaught exception handler, but we did move off it, in favor of a custom implementation. However, this custom implementation which allows to restart dying thread, only makes sense for `StreamsThreads`, but not for the `GlobalThread` \u2013 of the `GlobalThread` dies, we can only close KafkaStreams client with an ERROR state (what we do). [In AK 4.0, we remove the old code, and it seems we did not do a proper cleanup; that's all.]\r\n\r\nBut yes, we should fix the logging issue for sure.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-09-19T17:24:30.754+0000", "updated": "2025-09-19T17:24:30.754+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18021483", "id": "18021483", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "body": "You're right, now I see that the first call to {{setUncaughtExceptionHandler}} on {{globalStreamThread}} is using the new implementation and sets it right. I might have incorrectly pinpointed my issue.\r\n\r\nI've verified that the problem I've encountered happens when {{initialize()}} call in {{GlobalStreamThread:276}} throws an {{ExceptionInInitializerError}} due to RocksDB failing to load the library in static initializer of {{{}DBOptions{}}}. This exception was only caught inside the {{java.lang.Thread}} exception handler of the {{{}globalStreamThread{}}}.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "created": "2025-09-19T18:37:25.701+0000", "updated": "2025-09-20T20:15:13.844+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18021553", "id": "18021553", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "body": "[~mikkolaj] [~mjsax] I want to help Kafka development for the first time. I have the ticket but I don't know what to do exactly. Can you guide me on what to do about it?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-09-20T07:49:56.745+0000", "updated": "2025-09-20T07:51:58.279+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18021595", "id": "18021595", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "body": "Hi [~fatihcelik], thanks for your interest in solving the issue.\r\n\r\nThe problem I see is that {{GlobalStreamThread}} lacks handling for {{Error}} instances (e.g. {{ExceptionInInitializerError}} or {{{}UnsatisfiedLinkError{}}}). They aren't caught in {{streamsUncaughtExceptionHandler}} and propagate to {{{}Thread.UncaughtExceptionHandler{}}}, which might be a no-op. As a result the global thread can die silently.\r\n\r\nLet's wait for [~mjsax]'s opinion, but I think it would be possible to handle it by implementing a {{Thread.UncaughtExceptionHandler}} for {{{}globalStreamThread{}}}, which logs the error and calls {{{}closeToError(){}}}, so that the stream can transition to {{ERROR}} state.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "created": "2025-09-20T21:56:37.998+0000", "updated": "2025-09-20T21:56:37.998+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18021656", "id": "18021656", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "body": "Thank you for the explanation [~mikkolaj]. So, for now we're waiting to hear from [~mjsax].", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-09-21T13:10:20.237+0000", "updated": "2025-09-21T13:10:20.237+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18021744", "id": "18021744", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "While this might work, I am wondering if it's really how we want/need to do it? Where does \"UnsatisfiedLinkError\" happen, and how could we test it properly?\r\n\r\n[~mikkolaj] can you clarify if the problem is only missing logging, or also that KafkaStreams does not go into ERROR state?\r\n\r\nLooking into the code, `run()` first call `initialize()` which has a try-catch that covers the whole method, and would set `startupException`, and return `null`, what should actually transit the state into PENDING_SHUTDOWN and DEAD, and log an error:\r\n{code:java}\r\nlog.error(\"Error happened during initialization of the global state store; this thread has shutdown.\"); {code}\r\nOf course, if the error does not happen inside `initialize()` or we don't handle it properly (we catch `Exception` but not `Throwable`) this code won't work as expected... Could it be, that catching Throwable instead of Exception would be enough to fix the issue? We also catch Throwable in `StreamsThread#run()`...", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-09-22T06:34:43.693+0000", "updated": "2025-09-22T06:34:43.693+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18021835", "id": "18021835", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "body": "It is both missing logging and stream not going into {{ERROR}} state.\r\n\r\nReplication of {{UnsatisfiedLinkError}} hitting the no-op error handler:\r\n # Include {{kafka-streams-scala}} dependency in {{4.1.0}} version\r\n # Create a Scala app with a KafkaStreams topology which relies on RocksDB global state store, e.g:\r\n{code:scala}\r\n    val builder = new StreamsBuilder()\r\n    val input: KStream[String, String] = builder.stream[String, String](\"input-topic\")\r\n    val globalTable: GlobalKTable[String, Int] = builder.globalTable[String, Int](\"global-table-topic\")\r\n    val joinedStream: KStream[String, Int] = input.join(globalTable)((key, _) => key, (_, joinedValue) => joinedValue)\r\n    joinedStream.to(\"output-topic\")\r\n    val streams: KafkaStreams = new KafkaStreams(builder.build(), config)\r\n    streams.setUncaughtExceptionHandler { _ =>\r\n      // currently I won't be called\r\n      SHUTDOWN_APPLICATION\r\n    }\r\n    streams.start()\r\n{code}\r\n # Set up required topics\r\n # Run the app on Linux with {{/tmp}} directory mounted with {{noexec}} option (or set {{ROCKSDB_SHAREDLIB_DIR}} env variable to point to such directory)\r\n # No error logging present and {{globalStreamThread}} dies\r\n\r\nCatching {{Throwable}} as you suggested will fix my issue but I'm not sure if it's a good solution in general. Will it work in more serious cases, e.g. {{OutOfMemoryError}} being thrown? As per [Java docs|https://docs.oracle.com/javase/8/docs/api/java/lang/Error.html] in general {{Error}} shouldn't be caught (and in Scala I've usually seen [NonFatal|https://www.scala-lang.org/api/2.13.3/scala/util/control/NonFatal$.html] extractor being used instead of catching {{{}Throwable{}}}).", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "created": "2025-09-22T11:34:56.967+0000", "updated": "2025-09-22T12:22:24.989+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18021966", "id": "18021966", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "OutOfMemoryError is also a Throwable. \u2013 Yes, in general, Error / Throwable should not be caught. But if you just try to log, it should be ok?\r\n\r\nThe problem with the Java uncaught exception handler is, that the thread is already dead. So I think you can do even less? \u2013 I am also not objecting to use the Java uncaught exception handler as a last line of defense (but I am not sure if we need to do this, when we can also get it done by catching Throwable), but if we go this route, we should do it for all threads, including `StreamThread` and `StateUpdaterThread`?\r\n\r\nMaybe [~lucasbru] or [~cadonna] have an opinion?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-09-22T23:23:33.411+0000", "updated": "2025-09-22T23:23:33.411+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18022063", "id": "18022063", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "body": "I was wondering if maybe going a similar way to {{NonFatal}} would be a good approach \u2013 catch only these exceptions / errors that we know won't interrupt executing the regular cleanup code (e.g. {{UnsatisfiedLinkError}} in {{initialize()}} method) and propagate other ones to some {{UncaughtExceptionHandler}} defined in the user code, giving user the ability to forcefully shut down the application if something really bad happens.\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "created": "2025-09-23T07:05:47.469+0000", "updated": "2025-09-23T07:05:47.469+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18022105", "id": "18022105", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=cadonna", "name": "cadonna", "key": "cadonna", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=cadonna&avatarId=53276", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cadonna&avatarId=53276", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cadonna&avatarId=53276", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cadonna&avatarId=53276"}, "displayName": "Bruno Cadonna", "active": true, "timeZone": "Europe/Berlin"}, "body": "We specified the Streams uncaught exception handler to handle {{Throwable}}. If we want to keep that, we need to catch {{Throwable}}s. And we actually already do that for stream threads. \r\nThe Java uncaught exception handler also handles {{Throwable}}s and we wanted to have a custom uncaught exception handler for Streams.\r\nTo be fair, the global stream thread is a bit special since it cannot be replaced as the stream threads. So, I would either:\r\n* log the failure in the Java uncaught exception of the global stream thread and let the Kafka Streams instance just fail with the throwable, or\r\n* catch the {{Throwable}} and log (and let the Kafka Streams instance fail).\r\n", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=cadonna", "name": "cadonna", "key": "cadonna", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=cadonna&avatarId=53276", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cadonna&avatarId=53276", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cadonna&avatarId=53276", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cadonna&avatarId=53276"}, "displayName": "Bruno Cadonna", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-09-23T08:57:58.479+0000", "updated": "2025-09-23T08:58:47.734+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18022455", "id": "18022455", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "body": "I don't fully understand the situations mentioned. I might be misunderstanding, and I'd appreciate it if you could correct me. Currently, if a handler isn't set with \\{{setUncaughtExceptionHandler}}, I can already see the error in the logs. The error occurs when \\{{setUncaughtExceptionHandler()}} is called. Is the change here really to catch and log a \\{{Throwable}} object on the relevant line? It does this when setUncaughtExceptionHandler isn't called. (Also, the application doesn't shutdown despite receiving the error.)", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-09-24T14:53:16.254+0000", "updated": "2025-09-24T14:53:16.254+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18022529", "id": "18022529", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Not sure if I can follow [~mikkolaj]? All exception that go into the StreamsUncaughtExceptionHandler are fatal exception. Or course, there is still different \"classes\" of fatal ones, but not sure if it would really matter much? KS tries to call the handler in any case and let the user react to it.\r\n{quote}The error occurs when {{setUncaughtExceptionHandler()}}\u00a0is called\r\n{quote}\r\nYes, that's \"just\" a bug. By default, when you call `new KafkaStreams()` there is a default exception handler set (also on the GlobalThreadThread; for this case, via the constructor). When you call `KafkaStreams#setUncaughExceptionHandler()` the issue happens because we first set the user provided handler correctly ([https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L467-L471)] but later overwrite it incorrectly ([https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L475-L478)|https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L475-L478]\r\n\r\nNevertheless, the initialization phase is not covered: [https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L276-L292] and I would assume that `UnsatisfiedLinkError` would be thrown here, not invoking any handler. The regular processing-loop is covered though, and we call the handler (however, we don't catch Throwable): [https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L295-L343]\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-09-24T19:37:42.559+0000", "updated": "2025-09-24T19:37:42.559+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18022675", "id": "18022675", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "body": "My case can be fixed by catching the error\u00a0[here|https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L434] and it will get re-thrown by the thread calling {{streams.start()}} [here|https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L464].\r\n\r\nI was trying to advocate against catching {{Throwable}} because I've seen posts like [this|https://stackoverflow.com/a/352793], saying that when a {{VirtualMachineError}} is thrown there are no guarantees for executing any code reliably, including error handling or passing the error to a custom exception handler.\r\n\r\nJava's {{UncaughtExceptionHandler}} seems to me like the last line of defense, where user could try to detect these problems and take action like shutting down the app. Setting these handlers to no-op [here|https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L472-L478] looks like ignoring everything that's unexpected.\r\n\r\nI might be wrong though, so I'm not pushing for any specific solution. Catching {{Throwable}} should probably handle most of the cases just fine.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "created": "2025-09-25T08:08:42.169+0000", "updated": "2025-09-25T08:08:42.169+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18023029", "id": "18023029", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "body": "Thank you [~mjsax] , everything is much clearer now. However, we need to fix one issue. The {{UnsatisfiedLinkError}} does not appear in the lines specified here.\r\n\r\n[https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L295-L343]\r\n\r\nIt's appearing exactly here. [~mikkolaj]\u00a0 already mentioned this in their last comment:\r\n\r\n[https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L276]", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-09-26T08:15:58.802+0000", "updated": "2025-09-26T08:21:49.762+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18023224", "id": "18023224", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "[~mikkolaj], yes, this aligns to what I said earlier: https://issues.apache.org/jira/browse/KAFKA-19724?focusedCommentId=18021744&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-18021744 \u2013 catching Throwable instead of Exception should(*) address the issue.\r\n\r\n\u00a0(*) The concern about catching Throwable is totally valid; no disagreement. We do it in Kafka Streams basically as a \"best effort\" approach, and are well aware that it might not always work.\r\n{quote}Java's\u00a0{{UncaughtExceptionHandler}}\u00a0seems to me like the last line of defense, where user could try to detect these problems and take action like shutting down the app\r\n{quote}\r\nI am not deep enough into JVM details, but I am wondering if this is actually guaranteed? After a Throwable, the JVM is in \"very bad state\" from my understanding, and I am not sure what guarantees there are that the handler is invoked, and what code would be guaranteed to get executed inside the handler?\r\n\r\nThat we set the handler as a no-op, is clearly a bug (as said above already): We actually set the handler first [https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L467-L471] and incorrectly set it as no-op right afterwards.\r\n{quote}Catching\u00a0{{Throwable}}\u00a0should probably handle most of the cases just fine.\r\n{quote}\r\nYes, that's why we do is this way.\r\n\r\n\u00a0\r\n\r\n[~fatihcelik] \u2013 yes. But inside `initialize()` as also pointed out by [~mikkolaj], we would catch `Throwable` here: [https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L434] to address it.\r\n\r\n\u00a0\r\n\r\nSo easy fix: Change [https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L434] from `Exception` to `Throwable` and remove [https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L475-L478]\r\n\r\n\u00a0\r\n\r\nAdditionally, we could consider to also mess with `Thread#setUncaughtExceptionHandler()` (note, that both `StreamsThread` and `GlobalThread`, and neither the new `StateUpdatedThread` use this method \u2013 the methods we discussed above, are overload from KS which work with `StreamsUncaughtExceptionHandler`, not the Java `Thread.UncaughtExceptionHandler`), but I am not sure if this would buy us much? The tricky part would be, that `StreamsThreads`, `StateUpdaterThread` and `GlobalStreamThread` are background threads and are not exposed to the user, and we also would not want to add new public API to avoid confusion (having `KafkaStreams#setUncaughtExceptionHandler(StreamsUncaughtExceptionHandler)` and `KafkaStreams#setUncaughtExceptionHandler(Thread.UncaughExceptionHandler)` would be very weird). \u2013 But we could either register our own KS specific handler, or use `Thread.currentThread().getUncaughExceptionHandler` to get whatever handler is set on the main thread, and add it to background threads. But as said already, not sure if this would help much \u2013 but I also don't think it would cause any issues? \u2013 Also not sure if this is necessary as using `Thread.setDefaultUncaughtExceptionHandler()` should just do the trick?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-09-26T23:04:38.054+0000", "updated": "2025-09-26T23:04:38.054+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18028593", "id": "18028593", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "body": "For this issue, I created the following PR:\u00a0[https://github.com/apache/kafka/pull/20668 |https://github.com/apache/kafka/pull/20668]\r\n\r\nThis is my first contribution to an open source project :) Could you please let me know if there are any things I need to fix?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fatihcelik", "name": "fatihcelik", "key": "JIRAUSER311005", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "Fatih Celik", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-09T08:41:29.087+0000", "updated": "2025-10-09T08:41:29.087+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13629404/comment/18030008", "id": "18030008", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "body": "??I am not sure what guarantees there are that the handler is invoked??\r\n\r\n[~mjsax] I haven't found any specific guarantees being mentioned in the docs, so I would assume it's executed on a best efforts basis.\r\n\r\nI agree that exposing a separate API for setting the Java exception handler would be confusing and a KS specific handler seems like a difficult thing to implement (I'm not sure what would be a proper behavior that would suit all the cases). From my perspective not setting such handler and relying on user supplying his own default handler with {{Thread.setDefaultUncaughtExceptionHandler()}} seems like a reasonable solution.\r\n\r\n[~fatihcelik]'s PR looks good to me. Thanks guys for your help and cooperation here :)\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mikkolaj", "name": "mikkolaj", "key": "JIRAUSER310996", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34053", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"}, "displayName": "Miko\u0142aj Bul", "active": true, "timeZone": "Europe/Warsaw"}, "created": "2025-10-15T08:48:03.233+0000", "updated": "2025-10-15T08:48:03.233+0000"}], "maxResults": 17, "total": 17, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/5", "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png", "name": "Resolved", "id": "5", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}}}