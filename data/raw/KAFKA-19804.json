{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13631758", "self": "https://issues.apache.org/jira/rest/api/2/issue/13631758", "key": "KAFKA-19804", "fields": {"summary": "Improve heartbeat request manager initial HB interval ", "description": "With KIP-848, consumer HB interval config moved to the broker, so currently, the consumer HB request manager starts with a 0ms interval (mainly to send a first HB right away after the consumer subscribe + poll). Once a response is received, the consumer takes the interval from the response and starts using it.\u00a0\r\n\r\nThat 0ms initial interval makes that the HB mgr poll continuously executes logic on a tight loop that may not really be needed. It mostly has to wait for a response (or a failure).\r\n\r\nProbably worse than this, is the impact on the app thread, given that pollTimeout takes into account the maxTimeToWait from the network thread, that is directly impacted by the timeToNextHeartbeat\r\n * [https://github.com/apache/kafka/blob/388739f5d847d7a16e389d9891f806547f023476/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1764-L1766]\r\n * [https://github.com/apache/kafka/blob/781bc7a54b8c4f7c86f0d6bb9ef8399d86d0735e/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractHeartbeatRequestManager.java#L255]\r\n\r\nWe should review and consider setting a non-zero initial interval (while we wait for the actual interval from the broker). One option to consider would be using the request timeout maybe (just a first thought)\r\n\r\nHigh level goals here would be to:\r\n * maintain the behaviour of sending a first HB without delay\u00a0\r\n * ensure no unneeded activity on the HB mgr poll in the background, in tight loop, while we're just waiting for the first HB response with an interval\r\n * ensure the app thread poll timeout is not affected", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lianetm", "name": "lianetm", "key": "JIRAUSER300183", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER300183&avatarId=52523", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER300183&avatarId=52523", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER300183&avatarId=52523", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER300183&avatarId=52523"}, "displayName": "Lianet Magrans", "active": true, "timeZone": "America/Toronto"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13631758/comment/18030513", "id": "18030513", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "body": "[~lianetm], are you planning to work on this issue? If not, I\u2019d be happy to take it over. Thanks!", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "created": "2025-10-17T00:39:13.636+0000", "updated": "2025-10-17T00:39:13.636+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631758/comment/18030515", "id": "18030515", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lianetm", "name": "lianetm", "key": "JIRAUSER300183", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER300183&avatarId=52523", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER300183&avatarId=52523", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER300183&avatarId=52523", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER300183&avatarId=52523"}, "displayName": "Lianet Magrans", "active": true, "timeZone": "America/Toronto"}, "body": "Sure, feel free to take it and I can help with reviews. Thanks for your help!", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lianetm", "name": "lianetm", "key": "JIRAUSER300183", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER300183&avatarId=52523", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER300183&avatarId=52523", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER300183&avatarId=52523", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER300183&avatarId=52523"}, "displayName": "Lianet Magrans", "active": true, "timeZone": "America/Toronto"}, "created": "2025-10-17T00:48:55.852+0000", "updated": "2025-10-17T00:48:55.852+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631758/comment/18030540", "id": "18030540", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=goyarpit", "name": "goyarpit", "key": "JIRAUSER301926", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Arpit Goyal", "active": true, "timeZone": "Etc/UTC"}, "body": "[~brandboat]\u00a0 It seems you are already working on other issues .Can i take this up ? .It would be my first hand on the new consumer group protocol.\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=goyarpit", "name": "goyarpit", "key": "JIRAUSER301926", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Arpit Goyal", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-17T06:01:23.901+0000", "updated": "2025-10-17T06:01:23.901+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631758/comment/18030623", "id": "18030623", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "body": "[~goyarpit] Thanks for checking! I\u2019ve already started exploring this one. If you are interested, you can help review once I have a PR ready.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "created": "2025-10-17T12:13:49.079+0000", "updated": "2025-10-17T12:13:49.079+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631758/comment/18031215", "id": "18031215", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "body": "Hi [~lianetm],\r\nI took a closer look at this issue and wanted to share a few thoughts.\r\n{quote}That 0 ms initial interval causes the HB manager poll to run continuously in a tight loop, executing logic that may not really be needed\u2014it mostly just waits for a response or failure.\r\n{quote}\r\nThis actually shouldn\u2019t happen because we already check whether there\u2019s any in-flight heartbeat request before sending a new one:\r\n[https://github.com/apache/kafka/blob/1330870efbb4efd9fd394ec5cb8a0fecf8e69b24/clients/src/main/java/org/apache/kafka/clients/consumer/internals/HeartbeatRequestState.java#L96]\r\n[https://github.com/apache/kafka/blob/80f31224aad543dbfc892bce1ad73b6bb693855a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/RequestState.java#L79]\r\n{quote}We should review and consider setting a non-zero initial interval (while we wait for the actual interval from the broker). One option to consider would be using the request timeout maybe (just a first thought)\r\n{quote}\r\n-It\u2019s also worth noting that if we set a non-zero initial interval, the first poll() call will block until the timeout because no partitions are assigned yet. That means no Fetch requests are sent and the fetchBuffer remains empty until the poll timeout expires. This \"tight loop\" behavior on the application thread is actually intentional per PR [https://github.com/apache/kafka/pull/14835] to mitigate the case where Consumer.poll(Duration timeout) would otherwise block for the entire duration.-\r\n\r\n-I\u2019m thinking we could set a small non-zero initial heartbeat interval, what about 1s? to slightly loosen the tight loop. Of course, this means the first poll will still block for up to 1s. Using request.timeout.ms (default 30 s) with pollTimeout (e.g., 15 s) would make the first poll take too long before doing any useful work.-", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "created": "2025-10-20T16:51:25.807+0000", "updated": "2025-10-27T18:02:37.751+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631758/comment/18033265", "id": "18033265", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=shivsundar", "name": "shivsundar", "key": "JIRAUSER303745", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Shivsundar R", "active": true, "timeZone": "Etc/UTC"}, "body": "Hey [~brandboat] , thanks for the investigation.\u00a0\r\nI too faced this issue of pollTimer in {color:#0747a6}ShareConsumerImpl{color}\r\n\u00a0being 0 initially (the heartbeatInterval=0 makes the maximumTimeToWait=0).\r\n{quote}It\u2019s also worth noting that if we set a non-zero initial interval, the first poll() call will block until the timeout because no partitions are assigned yet.\r\n{quote}\r\nI am not sure here, the {color:#0747a6}pollTimeout{color} also is based on the timeout argument passed to poll(). We will take the minimum of the {color:#0747a6}applicationTimeout{color}\r\n(in this case would be 30 seconds as we set {color:#0747a6}heartbeatInterval{color} to 30s) and the pollTimeout(which the user passes in poll).\r\n\r\nAssuming the user passes in 30000ms in poll, the poll only blocks the application thread(until data is received), the request managers in the background thread meanwhile will still send the next heartbeat request and reconcile the assignment when the heartbeat response is received?\u00a0\r\n\r\nSo not sure if we would really block the operations by setting the value to 30s?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=shivsundar", "name": "shivsundar", "key": "JIRAUSER303745", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Shivsundar R", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-27T15:03:18.627+0000", "updated": "2025-10-27T15:14:13.999+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631758/comment/18033304", "id": "18033304", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "body": "Hi [~shivsundar], you're right \u2014 I misunderstood the code. I just ran a quick test to verify your explanation, and it matches what you said. So there\u2019s no blocking issue here.\r\n\r\nI originally noticed this \u201cblocking\u201d behavior during my implementation and found the test {{testAsyncConsumeUnsubscribeWithoutGroupPermission}} failed. I did some investigation at that time but ended up drawing the wrong conclusion. Based on your explanation, it seems that the issue in that test is actually unrelated. I\u2019ll take another look later.\r\n\r\nThanks again for the correction!", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "created": "2025-10-27T18:02:16.675+0000", "updated": "2025-10-27T18:02:16.675+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631758/comment/18034215", "id": "18034215", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "body": "Hi [~shivsundar],\r\n\r\nTurns out the blocking issue does exist \u2014 I spoke too soon last time, sorry for the confusion. Here\u2019s what I found:\r\n\r\nLet\u2019s say there are already some records in the topic, and we call {{poll(Duration.ofSeconds(10))}} with:\r\n * consumer heartbeat interval = 30s\r\n * broker heartbeat interval = 5s\r\n * auto-commit interval = 5s\r\n * auto.offset.reset = earliest\r\n\r\n*Behavior:*\r\n # {{subscribe}} + {{enable.auto.commit=true}} \u2192 first {{poll()}} blocks for around 5s, then return records\r\n # {{subscribe}} + {{enable.auto.commit=false}} \u2192 first {{poll()}} blocks for around 10s (poll timeout), then return records\r\n # {{assign}} \u2192 first {{poll()}} doesn\u2019t block and we get records immediately\r\n\r\n*Why it happens:*\r\nIn (1) and (2), during the first {{{}poll(){}}}, no Fetch request is send to broker because we haven\u2019t received any partition assignments yet, i.e. the heartbeat request hasn\u2019t returned. This causes {{pendingFetchRequestFuture}} completed\u00a0and set to null {^}[1]{^}{^}[2]{^}{^}[3]{^}, preventing FetchRequestManager from issuing further fetches {^}[4]{^}, which in turn makes the fetch buffer wait until it times out {^}[5]{^}.\r\n * For (1), since auto-commit is on, the wait time is basically\r\n{code:java}\r\n Math.min(applicationEventHandler.maximumTimeToWait(), timer.remainingMs()) {code}\r\nwhich ends up being the auto-commit interval (5s).\r\n\r\n * For (2), it just uses the {{{}pollTimeout{}}}.\r\n * For (3), since partitions are already assigned, {{AbstractFetch}} can start fetching records right away, so there\u2019s no blocking.\r\n\r\nNow I\u2019m looking into how to reduce or avoid this initial blocking on the first {{poll()}} call. Any suggestions or feedback is welcome :)\r\nI\u2019ve also submitted a draft PR if you\u2019d like to take a look.\r\n\r\n[1]: [https://github.com/apache/kafka/blob/5c49b48eb0732043400ec1ffb23022ebb3b47085/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractFetch.java#L438]\r\n[2]: [https://github.com/apache/kafka/blob/9e424755d4d236442847b13863580f44f27e22a6/clients/src/main/java/org/apache/kafka/clients/consumer/internals/FetchRequestManager.java#L162]\r\n[3]: [https://github.com/apache/kafka/blob/9e424755d4d236442847b13863580f44f27e22a6/clients/src/main/java/org/apache/kafka/clients/consumer/internals/FetchRequestManager.java#L171]\r\n[4]: [https://github.com/apache/kafka/blob/9e424755d4d236442847b13863580f44f27e22a6/clients/src/main/java/org/apache/kafka/clients/consumer/internals/FetchRequestManager.java#L142]\r\n[5]: [https://github.com/apache/kafka/blob/10f26c86297dd2770cd7c93e35b27d4c4ceb0e1c/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1797]", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=brandboat", "name": "brandboat", "key": "brandboat", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=brandboat&avatarId=29065", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brandboat&avatarId=29065", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brandboat&avatarId=29065", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brandboat&avatarId=29065"}, "displayName": "Kuan Po Tseng", "active": true, "timeZone": "Asia/Taipei"}, "created": "2025-10-30T16:20:40.427+0000", "updated": "2025-10-30T16:20:40.427+0000"}], "maxResults": 8, "total": 8, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}