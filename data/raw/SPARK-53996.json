{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13632260", "self": "https://issues.apache.org/jira/rest/api/2/issue/13632260", "key": "SPARK-53996", "fields": {"summary": "InferFiltersFromConstraints rule does not infer filter conditions for complex join expressions", "description": "The Spark optimizer's {{InferFiltersFromConstraints}} rule is currently unable to infer filter conditions when join constraints involve complex expressions. While it works for simple attribute equalities ({{{}a = b{}}}), it can't infer constraint from anything more complex than that.\r\n\r\n*Example (works as expected):*\r\n{code:sql}\r\nSELECT *\r\nFROM t1\r\nJOIN t2 ON t1.a = t2.b\r\nWHERE t2.b = 1\r\n{code}\r\nIn this case, the optimizer correctly infers the additional constraint {{{}t1.a = 1{}}}.\r\n\r\n*Example (does not work):*\r\n{code:sql}\r\nSELECT *\r\nFROM t1\r\nJOIN right ON t1.a = t2.b + 2\r\nWHERE t2.b = 1\r\n{code}\r\nIn this case, it is clear that {{t1.a = 3}} (since {{b = 1}} and {{{}a = b + 2{}}}), but the optimizer does not infer this constraint.\r\n\r\n*How to Reproduce:*\r\n{code:scala}\r\nspark.sql(\"CREATE TABLE t1(a INT)\")\r\nspark.sql(\"CREATE TABLE t2(b INT)\")\r\n\r\nspark.sql(\"\"\"\r\nSELECT * \r\nFROM t1 \r\nINNER JOIN t2 ON t2.b = t1.a + 2 \r\nWHERE t1.a = 1\r\n\"\"\").explain\r\n{code}\r\n{code:java}\r\n== Physical Plan ==\r\nAdaptiveSparkPlan\r\n+- BroadcastHashJoin [(a#2 + 2)], [b#3], Inner, BuildRight, false\r\n   :- Filter (isnotnull(a#2) AND (a#2 = 1))\r\n   :  +- FileScan spark_catalog.default.t1[a#2]\r\n      +- Filter isnotnull(b#3)\r\n         +- FileScan spark_catalog.default.t2[b#3]\r\n{code}\r\n*Expected Behavior:*\r\nThe optimizer should be able to statically evaluate and infer that {{t2.b = 3}} given the join condition and the filter on {{{}t1.a{}}}.\r\n\r\n*Impact:*\r\nThis limits the optimizer's ability to push down filters and optimize query execution plans for queries with complex join conditions.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=vanekjar", "name": "vanekjar", "key": "vanekjar", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Jaromir Vanek", "active": true, "timeZone": "America/Vancouver"}, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}