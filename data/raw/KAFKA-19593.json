{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13626026", "self": "https://issues.apache.org/jira/rest/api/2/issue/13626026", "key": "KAFKA-19593", "fields": {"summary": "Stuck __consumer_offsets partition (kafka streams app)", "description": "h3. Problem Summary\r\n\r\nMy Kafka Streams application cannot move its {{state_store}} from {{STARTING}} to {{{}RUNNING{}}}.\r\n\r\nI'm using a *Strimzi Kafka cluster* with:\r\n * 3 *controller nodes*\r\n\r\n * 4 *broker nodes*\r\n\r\nh3. Observations\r\nh4. Partition {{__consumer_offsets-35}} is {*}stuck{*}.\r\n\r\nFrom AKHQ, partition details:\r\n * *Broker 10* is the *leader* of {{__consumer_offsets-35}}\r\n\r\n * There are *no interesting logs* on broker 10\r\n\r\n * However, logs are *spamming every 10ms* from broker 11 (a {*}replica{*}):\r\n\r\n2025-08-11 04:05:50 INFO  [TxnMarkerSenderThread-11] TransactionMarkerRequestCompletionHandler:66 \r\n[Transaction Marker Request Completion Handler 10]: Sending irm_r_sbm2_web-backend-web-1-6cad35c7-2be9-4ed2-9849-9c059cc8c409-4's transaction marker for partition __consumer_offsets-35 has failed with error org.apache.kafka.common.errors.NotLeaderOrFollowerException, retrying with current coordinator epoch 38\r\nh4. Brokers 20 and 21 \u2014 neither leaders nor replicas \u2014 also spamming the same error:\r\n\r\n*Broker 20:*\r\n2025-08-11 04:39:45 INFO  [TxnMarkerSenderThread-20] TransactionMarkerRequestCompletionHandler:66 \r\nSending irm_r_sbm2_web-backend-web-1-6cad35c7-2be9-4ed2-9849-9c059cc8c409-3's transaction marker for partition __consumer_offsets-35 has failed with error org.apache.kafka.common.errors.NotLeaderOrFollowerException, retrying with current coordinator epoch 54\r\n\u00a0\r\n*Broker 21:*\r\n2025-08-11 04:39:58 INFO  [TxnMarkerSenderThread-21] TransactionMarkerRequestCompletionHandler:66 \r\nSending irm_r_sbm2_web-backend-web-1-6cad35c7-2be9-4ed2-9849-9c059cc8c409-2's transaction marker for partition __consumer_offsets-35 has failed with error org.apache.kafka.common.errors.NotLeaderOrFollowerException, retrying with current coordinator epoch 28\r\n\u00a0\r\n----\r\nh3. Kafka Streams App Behavior\r\n\r\nLogs from the Kafka Streams app (at debug level) repeat continuously. The {{state_store}} *never transitions* from {{STARTING}} to {{{}RUNNING{}}}.\r\n\r\nKey repeated logs (debug log level):\r\n * Polling main consumer repeatedly\r\n\r\n * SASL/SCRAM authentication succeeds\r\n\r\n * 0 records fetched\r\n\r\n * 0 records processed\r\n\r\n * Punctuators run, but nothing gets committed\r\n\r\n * Fails to commit due to {*}rebalance in progress{*}, retrying\u2026\r\n\r\n{{}}\r\n----\r\nh3. Workarounds Considered\r\n\r\nThe *only thing that temporarily resolves the issue* is:\r\n * Physically deleting the partition files for {{__consumer_offsets-35}} from both the leader and replica brokers\r\n\r\nOther drastic options:\r\n * Deleting the entire {{__consumer_offsets}} topic\r\n\r\n * Re-creating the entire Kafka cluster\r\n\r\n----\r\nh3. Additional Info\r\n * I cannot reproduce this in a *clean git project*\r\n\r\n * The issue is isolated to a {*}\"corrupt\" cluster{*}, which is still available for inspection\r\n\r\n * This problem has occurred *4 times* in the *past month*\r\n\r\n * It *started happening after upgrading from Strimzi 3.9 to 4.0*\r\n\r\n * I'm using quarkus (kafka-stream version is 4.0.0) with default configuration, the only config worth mentioning is that I'm using exactly_once_v2 processing guarantee.\r\n\r\n----\r\nh3. Help Needed\r\n\r\nI'm hoping someone can {*}make sense of this issue{*}.\r\n\r\nPlease feel free to *reach out.*", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mapuci", "name": "mapuci", "key": "JIRAUSER310227", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Matej Pucihar", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}