{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13631450", "self": "https://issues.apache.org/jira/rest/api/2/issue/13631450", "key": "KAFKA-19787", "fields": {"summary": "kafka server ClusterAuthorization don't support acks=-1 for kafka-client version>3.1.0", "description": "* \u00a0kafka server version is 2.5.1\r\n * \u00a0kafka-client version bigger than 3.1.1\u00a0\r\n\r\n\u00a0\r\n{code:java}\r\nimport org.apache.kafka.clients.producer.KafkaProducer;\r\nimport org.apache.kafka.clients.producer.Producer;\r\nimport org.apache.kafka.clients.producer.ProducerRecord;\r\n\r\nimport java.util.Properties;\r\n\r\n\r\npublic class KafkaSendTest {\r\n\r\n  public static void main(String[] args) {\r\n    Properties props = new Properties();\r\n    props.put(\"bootstrap.servers\", \"xxx:9092,xxxx:9092\");\r\n    props.put(\"key.serializer\", \"org.apache.kafka.common.serialization.ByteArraySerializer\");\r\n    props.put(\"value.serializer\", \"org.apache.kafka.common.serialization.ByteArraySerializer\");\r\n    props.put(\"transaction.timeout.ms\", \"300000\");\r\n    props.put(\"acks\", \"-1\"); // If acks=1 or acks=0 it will send successfully\r\n    props.put(\"compression.type\", \"lz4\");\r\n    props.put(\"security.protocol\", \"SASL_PLAINTEXT\");\r\n    props.put(\"sasl.mechanism\", \"SCRAM-SHA-256\");\r\n    props.put(\"sasl.jaas.config\", \"org.apache.kafka.common.security.scram.ScramLoginModule required username=\\\"xxx\\\" password=\\\"xxxx\\\";\");\r\n\r\n    Producer<byte[], byte[]> producer = new KafkaProducer<>(props);\r\n\r\n    try {\r\n      String topic = \"topic1\";\r\n      byte[] value = new byte[]{1,2}; \r\n      ProducerRecord<byte[], byte[]> record = new ProducerRecord<>(topic, null, value);\r\n      producer.send(record, (metadata, exception) -> {\r\n        if (exception == null) {\r\n          System.out.printf(\"Sent record(key=%s value=%s) meta(partition=%d, offset=%d)\\n\",\r\n                  record.key(), new String(record.value()), metadata.partition(), metadata.offset());\r\n        } else {\r\n          exception.printStackTrace();\r\n        }\r\n      });\r\n      producer.close();\r\n    } catch (Exception e) {\r\n      e.printStackTrace();\r\n    }\r\n  }\r\n} {code}\r\npom.xml config\r\n\r\n\u00a0\r\n{code:java}\r\n<dependency>\r\n  <groupId>org.apache.kafka</groupId>\r\n  <artifactId>kafka-clients</artifactId>\r\n  <version>3.4.0</version>\r\n</dependency> {code}\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0When kafka producer acks=-1, It will throw exception.\r\n\r\n\u00a0\r\n{code:java}\r\norg.apache.kafka.common.KafkaException: Cannot execute transactional method because we are in an error state\tat org.apache.kafka.clients.producer.internals.TransactionManager.maybeFailWithError(TransactionManager.java:1010)\tat org.apache.kafka.clients.producer.internals.TransactionManager.maybeAddPartition(TransactionManager.java:328)\tat org.apache.kafka.clients.producer.KafkaProducer.doSend(KafkaProducer.java:1061)\tat org.apache.kafka.clients.producer.KafkaProducer.send(KafkaProducer.java:962)\tat com.mvad.realtime.show.converter.DataEntryToRTLogConverterTest.main(DataEntryToRTLogConverterTest.java:34)Caused by: org.apache.kafka.common.errors.ClusterAuthorizationException: Cluster authorization failed. {code}\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 If acks=1 or acks=0 it will send successfully\r\n{code:java}\r\nSent record(key=null ) meta(partition=6, offset=321496) {code}\r\n\u00a0 \u00a0 acks=-1 is just a param, How it effects ClusterAuthorization of kafka producer.\r\n\u00a0 \u00a0 Is this a bug or a mechanism in itself?\r\n\u00a0\r\n\u00a0", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=zhumingustc", "name": "zhumingustc", "key": "JIRAUSER303290", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34043", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34043", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34043", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34043"}, "displayName": "zhuming", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/6", "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png", "name": "Closed", "id": "6", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}}}