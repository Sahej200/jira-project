{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13627642", "self": "https://issues.apache.org/jira/rest/api/2/issue/13627642", "key": "KAFKA-19652", "fields": {"summary": "Consumer throughput drops by 10 times with Kafka v3.9.0 in ZK mode", "description": "Kafka consumer throughput in best-case drops by ~10 times after upgrading to kafka v3.9.0 from v3.5.1. Note that this is in ZK mode and KRAFT migration is not done yet.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=gargsha", "name": "gargsha", "key": "JIRAUSER287979", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34059", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34059", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34059", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34059"}, "displayName": "Sharad Garg", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13627642/comment/18017565", "id": "18017565", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kirktrue", "name": "kirktrue", "key": "kirktrue", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kirktrue&avatarId=49354", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kirktrue&avatarId=49354", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kirktrue&avatarId=49354", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kirktrue&avatarId=49354"}, "displayName": "Kirk True", "active": true, "timeZone": "America/Los_Angeles"}, "body": "[~gargsha]\u2014Can you share the consumer configuration? Thanks!", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=kirktrue", "name": "kirktrue", "key": "kirktrue", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=kirktrue&avatarId=49354", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kirktrue&avatarId=49354", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kirktrue&avatarId=49354", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kirktrue&avatarId=49354"}, "displayName": "Kirk True", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-09-02T00:29:25.449+0000", "updated": "2025-09-02T00:29:25.449+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13627642/comment/18018722", "id": "18018722", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ritvikgupta", "name": "ritvikgupta", "key": "JIRAUSER302370", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Ritvik Gupta", "active": true, "timeZone": "Asia/Kolkata"}, "body": "Hi,\r\n\r\nUpdating here on behalf of [~gargsha] -\r\n\r\n\u00a0\r\n\r\n*Topic configs :*\r\n\r\n{{cleanup.policy=compact,delete; retention.ms=1200000; min.insync.replicas=2}}\r\n\r\n*Consumer configs :*\r\n\r\n{{fetch.min.bytes=131072,fetch.max.wait.ms=500}}\r\n\r\n( acks=1 for the Producer )\r\n\r\n\u00a0\r\n\r\nI have generally observed this case for when the topic has a high throughput producer(s) running on it with upwards of *590\u00a0MB/sec* ( *600 K msgs/sec* with *1000 b* message size each ). Can also simulate this case with running multiple producers on the topic to achieve close to 600 MB/sec.\r\n\r\n\u00a0\r\n\r\nIn the above test scenario, the consumer throughput drops down to {*}< 90MB/sec{*}. This is for a 1 Producer + 1 Consumer test, which should be the ideal test scenario and was getting me upto *250+ MB/sec* consumer throughput in the old {*}v3.5.1 Kafka cluster{*}.\r\n\r\n\u00a0\r\n\r\nMy best guess is some form of loss in *insync replicas* ( with the high throughput producers as *acks=1* ), as only the leader replica would stay in-sync in case of a high throughput on the topic. And if this can have a performance impact on the consumer in some way ??\u00a0\r\n\r\nTo reason on this I had conducted the below test ( *min.insync.replicas=2* vs *min.insync.replicas=1* ) -\r\n\r\n\u00a0\r\n\u00a0\r\n|*test*|*Test Name*|*Observed message rate (K msgs/sec*|*Test description*|\r\n|1|\u00a0|\u00a0|\u00a0|\r\n|Consumer|Throughput test run ( Java client ) - Min ISR = 2 - 1 producer & 1 consumer|*{color:#de350b}89.21{color}*|Test Configs = acks:1, partitions:1, rf:3, min-isr:2, producers:1, consumers:1, batch_size:256KB|\r\n|Producer|Throughput test run ( Java client ) - Min ISR = 2 - 1 producer & 1 consumer|617.20|Test Configs = acks:1, partitions:1, rf:3, min-isr:2, producers:1, consumers:1, batch_size:256KB|\r\n|2|\u00a0|\u00a0|\u00a0|\r\n|Consumer|Throughput test run ( Java client ) - Min ISR = 1 - 1 producer & 1 consumer|*{color:#00875a}298.99{color}*|Test Configs = acks:1, partitions:1, rf:3, min-isr:1, producers:1, consumers:1, batch_size:256KB|\r\n|Producer|Throughput test run ( Java client ) - Min ISR = 1 - 1 producer & 1 consumer|597.20|Test Configs = acks:1, partitions:1, rf:3, min-isr:1, producers:1, consumers:1, batch_size:256KB|\r\n\r\n\u00a0\r\n\r\nJust to note I have also observed this heavy drop in consumer throughput in a *KRaft mode cluster ( v3.9.0 ).*\r\n\r\nLet me know if to share more details regarding the tests I conducted or any other configs, for getting to debug this.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ritvikgupta", "name": "ritvikgupta", "key": "JIRAUSER302370", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Ritvik Gupta", "active": true, "timeZone": "Asia/Kolkata"}, "created": "2025-09-08T04:20:24.144+0000", "updated": "2025-09-08T05:40:12.919+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13627642/comment/18024066", "id": "18024066", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ancjainil", "name": "ancjainil", "key": "JIRAUSER310849", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Jainil Rana", "active": true, "timeZone": "Etc/UTC"}, "body": "Hi [~gargsha] , [~mjsax] , I tried reproducing this,\u00a0 in 3.9.0 the consumer throughput drops a lot (~250MB/s \u2192 ~90MB/s) when {{{}min.insync.replicas=2{}}}.\r\n\r\nI noticed {{findPreferredReadReplica}} only picks from ISR. When followers drop out, consumers end up reading only from the leader, which seems to cause the slowdown.\r\n\r\nWould it be safe to let consumers read from out-of-ISR followers if they have the data (with HW checks), or is that too risky?\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ancjainil", "name": "ancjainil", "key": "JIRAUSER310849", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Jainil Rana", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-01T14:59:14.041+0000", "updated": "2025-10-01T23:47:09.412+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13627642/comment/18024209", "id": "18024209", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=gargsha", "name": "gargsha", "key": "JIRAUSER287979", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34059", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34059", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34059", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34059"}, "displayName": "Sharad Garg", "active": true, "timeZone": "Etc/UTC"}, "body": "[~ancjainil] I believe that would be risky and undesirable.\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=gargsha", "name": "gargsha", "key": "JIRAUSER287979", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34059", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34059", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34059", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34059"}, "displayName": "Sharad Garg", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-02T04:15:57.020+0000", "updated": "2025-10-02T04:15:57.020+0000"}], "maxResults": 4, "total": 4, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/1", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/blocker.svg", "name": "Blocker", "id": "1"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}