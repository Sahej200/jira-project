{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13625276", "self": "https://issues.apache.org/jira/rest/api/2/issue/13625276", "key": "KAFKA-19571", "fields": {"summary": "Race condition between log segment flush and file deletion causing log dir to go offline", "description": "h1. Context\r\n\r\nWe are using Kafka v3.7.1 with Zookeeper, our brokers are configured with multiple disks in a JBOD setup, routine intra-broker data rebalancing is performed using Cruise Control to manage disk utilization. During these rebalance operations, a race condition between a log segment flush operation and the file deletion that is part of the replica's directory move. This race leads to a `NoSuchFileException` when the flush operation targets a file path that has just been deleted by the rebalance process. This exception incorrectly forces the broker to take the entire log directory offline.\r\nh1. Logs / Stack trace\r\n{code:java}\r\n2025-07-23 19:03:30,114 WARN Failed to flush file /var/lib/kafka-08/topic_01-12/00000000024420850595.snapshot (org.apache.kafka.\r\ncommon.utils.Utils)\r\njava.nio.file.NoSuchFileException: /var/lib/kafka-08/topic_01-12/00000000024420850595.snapshot\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/sun.nio.fs.UnixException.translateToIOException(UnixException.java:92)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:116)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/sun.nio.fs.UnixFileSystemProvider.newFileChannel(UnixFileSystemProvider.java:182)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.nio.channels.FileChannel.open(FileChannel.java:292)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.nio.channels.FileChannel.open(FileChannel.java:345)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.common.utils.Utils.flushFileIfExists(Utils.java:1029)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.$anonfun$flushProducerStateSnapshot$2(UnifiedLog.scala:1766)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.flushProducerStateSnapshot(UnifiedLog.scala:1915)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.$anonfun$roll$2(UnifiedLog.scala:1679)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.Optional.ifPresent(Optional.java:183)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.$anonfun$roll$1(UnifiedLog.scala:1679)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.server.util.KafkaScheduler.lambda$schedule$1(KafkaScheduler.java:150)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.lang.Thread.run(Thread.java:829)\r\n\u00a0 \u00a0 \u00a0 \u00a0\u00a0\r\n2025-07-23 19:03:30,114 ERROR Error while flushing log for topic_01-12 in dir /var/lib/kafka-08 with offset 24420850595 (exclusi\r\nve) and recovery point 24420850595 (org.apache.kafka.storage.internals.log.LogDirFailureChannel)\r\njava.nio.channels.ClosedChannelException\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/sun.nio.ch.FileChannelImpl.ensureOpen(FileChannelImpl.java:150)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/sun.nio.ch.FileChannelImpl.force(FileChannelImpl.java:452)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.common.record.FileRecords.flush(FileRecords.java:197)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.storage.internals.log.LogSegment$2.call(LogSegment.java:631)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.storage.internals.log.LogSegment$2.call(LogSegment.java:627)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at com.yammer.metrics.core.Timer.time(Timer.java:91)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.storage.internals.log.LogSegment.flush(LogSegment.java:627)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.LocalLog.$anonfun$flush$1(LocalLog.scala:176)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.lang.Iterable.forEach(Iterable.java:75)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.LocalLog.flush(LocalLog.scala:176)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.$anonfun$flush$2(UnifiedLog.scala:1719)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.flush(UnifiedLog.scala:1915)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.flushUptoOffsetExclusive(UnifiedLog.scala:1700)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.$anonfun$roll$1(UnifiedLog.scala:1680)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.server.util.KafkaScheduler.lambda$schedule$1(KafkaScheduler.java:150)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.lang.Thread.run(Thread.java:829)\r\n\u00a0 \u00a0 \u00a0 \u00a0\u00a0\r\n2025-07-23 19:03:30,115 ERROR Uncaught exception in scheduled task 'flush-log' (org.apache.kafka.server.util.KafkaScheduler)\r\norg.apache.kafka.common.errors.KafkaStorageException: Error while flushing log for topic_01-12 in dir /var/lib/kafka-08 with off\r\nset 24420850595 (exclusive) and recovery point 24420850595\r\nCaused by: java.nio.channels.ClosedChannelException\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/sun.nio.ch.FileChannelImpl.ensureOpen(FileChannelImpl.java:150)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/sun.nio.ch.FileChannelImpl.force(FileChannelImpl.java:452)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.common.record.FileRecords.flush(FileRecords.java:197)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.storage.internals.log.LogSegment$2.call(LogSegment.java:631)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.storage.internals.log.LogSegment$2.call(LogSegment.java:627)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at com.yammer.metrics.core.Timer.time(Timer.java:91)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.storage.internals.log.LogSegment.flush(LogSegment.java:627)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.LocalLog.$anonfun$flush$1(LocalLog.scala:176)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.lang.Iterable.forEach(Iterable.java:75)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.LocalLog.flush(LocalLog.scala:176)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.$anonfun$flush$2(UnifiedLog.scala:1719)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.flush(UnifiedLog.scala:1915)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.flushUptoOffsetExclusive(UnifiedLog.scala:1700)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at kafka.log.UnifiedLog.$anonfun$roll$1(UnifiedLog.scala:1680)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.kafka.server.util.KafkaScheduler.lambda$schedule$1(KafkaScheduler.java:150)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\u00a0 \u00a0 \u00a0 \u00a0 at java.base/java.lang.Thread.run(Thread.java:829)\r\n\u00a0 \u00a0 \u00a0 \u00a0\u00a0\r\n2025-07-23 19:03:30,117 WARN [ReplicaManager broker=32] Stopping serving replicas in dir /var/lib/kafka-08 (kafka.server.ReplicaManager) {code}\r\nStack Trace Analysis\r\n\r\nThe failure begins with a benign `{{{}WARN`{}}} when a scheduled task tries to flush a producer state snapshot that was moved during a disk rebalance; this {{`NoSuchFileException`}} is anticipated and handled gracefully by the code. As implemented in https://issues.apache.org/jira/browse/KAFKA-13403 to swallow the exception. \r\nHowever, the same task then attempts to flush the actual log segment, which fails with a critical, unhandled\u00a0 `{{{}ClosedChannelException{}}}` because the file handles were invalidated by the directory's move. This unhandled I/O error propagates up and terminates the background task, causing the `{{{}KafkaScheduler{}}}` to log it as an uncaught {{{}`{}}}{{{}KafkaStorageException`{}}}. As a direct consequence, the `{{{}ReplicaManager{}}}` detects this fatal storage error and triggers its safety mechanism, taking the entire log directory offline to prevent potential data corruption.\r\nh1. Expected Behavior\r\n\r\nA {{`NoSuchFileException`}} in this context should not cause the entire log directory to be marked as offline.\r\nh1. Workaround\r\n\r\nThe current workaround is to manually restart the affected Kafka broker. The restart clears the in-memory state, and upon re-scanning the log directories, the broker marks the disk as healthy again.\r\nh1. Proposed fix\r\n\r\nThe proposed solution is to address the race condition at the lowest possible level: the *{{LogSegment.flush()}}* method. The goal is to catch the {{ClosedChannelException}} that occurs during the race and intelligently differentiate it from a legitimate I/O error.\r\n\r\nThe fix should be implemented within the {{catch}} block for {{ClosedChannelException}} in {{{}LogSegment.java{}}}. The logic would be as follows:\r\n # When a {{ClosedChannelException}} is caught, perform a check to see if the underlying log segment file still exists ({{{}log.file().exists(){}}}).\r\n\r\n # {*}If the file does not exist{*}, it confirms our race condition hypothesis: the replica has been moved or deleted by a rebalance operation. The exception is benign and should be ignored, with a {{WARN}} message logged for visibility.\r\n\r\n # {*}If the file does still exist{*}, the {{ClosedChannelException}} is unexpected and could signal a real hardware or filesystem issue. In this case, the exception should be re-thrown to trigger Kafka's standard log directory failure-handling mechanism.\r\n\r\nThis targeted fix would resolve the bug by gracefully handling the known race condition without masking other potentially critical storage errors.\r\nh2. Related issues\r\n * https://issues.apache.org/jira/browse/KAFKA-13403 was fixed to swallow the first `{{{}NoSuchFileException{}}}` WARN in the above stacktrace, but not the underlying exception.\r\n * https://issues.apache.org/jira/browse/KAFKA-15391 is similar but different, it swallows `NoSuchFileException` for race condition on log directory move/delete, but not on the segment file level.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=itoumlilt", "name": "itoumlilt", "key": "JIRAUSER310614", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER310614&avatarId=54450", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER310614&avatarId=54450", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER310614&avatarId=54450", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER310614&avatarId=54450"}, "displayName": "Ilyas Toumlilt", "active": true, "timeZone": "Europe/Paris"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13625276/comment/18012531", "id": "18012531", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=itoumlilt", "name": "itoumlilt", "key": "JIRAUSER310614", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER310614&avatarId=54450", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER310614&avatarId=54450", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER310614&avatarId=54450", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER310614&avatarId=54450"}, "displayName": "Ilyas Toumlilt", "active": true, "timeZone": "Europe/Paris"}, "body": "(https://issues.apache.org/jira/browse/KAFKA-13403) was fixed to swallow the first ``NoSuchFileException`` WARN in the above stacktrace, but not the underlying exception.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=itoumlilt", "name": "itoumlilt", "key": "JIRAUSER310614", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER310614&avatarId=54450", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER310614&avatarId=54450", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER310614&avatarId=54450", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER310614&avatarId=54450"}, "displayName": "Ilyas Toumlilt", "active": true, "timeZone": "Europe/Paris"}, "created": "2025-08-07T09:29:37.703+0000", "updated": "2025-08-07T09:29:37.703+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13625276/comment/18012532", "id": "18012532", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=itoumlilt", "name": "itoumlilt", "key": "JIRAUSER310614", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER310614&avatarId=54450", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER310614&avatarId=54450", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER310614&avatarId=54450", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER310614&avatarId=54450"}, "displayName": "Ilyas Toumlilt", "active": true, "timeZone": "Europe/Paris"}, "body": "(https://issues.apache.org/jira/browse/KAFKA-15391) is similar but different, it swallows `NoSuchFileException` for race condition on log directory move/delete, but not on the segment file level.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=itoumlilt", "name": "itoumlilt", "key": "JIRAUSER310614", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER310614&avatarId=54450", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER310614&avatarId=54450", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER310614&avatarId=54450", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER310614&avatarId=54450"}, "displayName": "Ilyas Toumlilt", "active": true, "timeZone": "Europe/Paris"}, "created": "2025-08-07T09:29:57.825+0000", "updated": "2025-08-07T09:29:57.825+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}