{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13624741", "self": "https://issues.apache.org/jira/rest/api/2/issue/13624741", "key": "KAFKA-19554", "fields": {"summary": "Add a Kafka client parameter to limit number of messages fetched", "description": "h3. Description\r\n\r\nCurrently, Kafka fetch requests only support limiting the total size of messages fetched ({{{}fetch.max.bytes{}}}) and the size per partition ({{{}max.partition.fetch.bytes{}}}). However, there is no way to limit the *number of messages* fetched per request\u2014neither globally nor on a per-partition basis.\r\n\r\nWhile Kafka was originally designed as a high-throughput distributed messaging platform and has traditionally focused more on throughput than individual message control, its role has since evolved. Kafka is now not only a leading message queue but also a core component in modern {*}data pipelines and stream processing frameworks{*}.\r\n\r\nIn these newer use cases, especially for downstream services and streaming applications, *rate-limiting by message count* is a common requirement.\r\n\r\nCurrently, the workaround is for clients to {*}fetch a batch of messages, manually truncate them based on count, and then adjust offsets manually{*}, which is inefficient, error-prone, and significantly reduces throughput. In practice, this forces developers to use external tools such as Redis to implement additional buffering or rate control mechanisms\u2014adding complexity and overhead.\r\n\r\nAdding *native support* for a message count limit in fetch requests would offer the following benefits:\r\nh3. Benefits\r\n # {*}Make Kafka a more mature and production-ready stream processing platform{*}, by supporting more granular rate-limiting use cases.\r\n\r\n # *Improve overall system throughput* for consumers that need to limit by message count, by eliminating inefficient post-processing workarounds.\r\n\r\n----\r\nh3. Potential Challenges\r\n # Due to compression and batching, Kafka consumers do not always have direct access to message counts in a fetch response. This means any solution would need to {*}estimate or calculate message counts indirectly{*}\u2014possibly based on batch metadata.\r\n\r\n # Implementation must ensure that {*}Kafka\u2019s high-performance characteristics are preserved{*}. Any support for message-count limits must avoid excessive decompression or deserialization on the broker side.\r\n\r\nMoreover, from what I\u2019ve observed, {*}many capable companies have already implemented their own internal forks or wrappers of Kafka to support this feature{*}, highlighting the demand and practical importance of this functionality. Therefore, it would be highly beneficial for Kafka to provide a {*}unified and officially supported solution{*}.\r\n\r\n\u00a0\r\nThe parameter reference from our internal version.\r\n\u00a0\r\n\u00a0\r\n\u00a0\r\n{code:java}\r\n...\r\n\"validVersions\": \"4-18\",\r\n\"flexibleVersions\": \"12+\",\r\n\"fields\": [\r\n  { \"name\": \"ClusterId\", \"type\": \"string\", \"versions\": \"12+\", \"nullableVersions\": \"12+\", \"default\": \"null\",\r\n    \"taggedVersions\": \"12+\", \"tag\": 0, \"ignorable\": true,\r\n    \"about\": \"The clusterId if known. This is used to validate metadata fetches prior to broker registration.\" },\r\n  { \"name\": \"ReplicaId\", \"type\": \"int32\", \"versions\": \"0-14\", \"default\": \"-1\", \"entityType\": \"brokerId\",\r\n    \"about\": \"The broker ID of the follower, of -1 if this request is from a consumer.\" },\r\n  { \"name\": \"ReplicaState\", \"type\": \"ReplicaState\", \"versions\": \"15+\", \"taggedVersions\": \"15+\", \"tag\": 1,\r\n    \"about\": \"The state of the replica in the follower.\", \"fields\": [\r\n    { \"name\": \"ReplicaId\", \"type\": \"int32\", \"versions\": \"15+\", \"default\": \"-1\", \"entityType\": \"brokerId\",\r\n      \"about\": \"The replica ID of the follower, or -1 if this request is from a consumer.\" },\r\n    { \"name\": \"ReplicaEpoch\", \"type\": \"int64\", \"versions\": \"15+\", \"default\": \"-1\",\r\n      \"about\": \"The epoch of this follower, or -1 if not available.\" }\r\n  ]},\r\n  { \"name\": \"MaxWaitMs\", \"type\": \"int32\", \"versions\": \"0+\",\r\n    \"about\": \"The maximum time in milliseconds to wait for the response.\" },\r\n  { \"name\": \"MinBytes\", \"type\": \"int32\", \"versions\": \"0+\",\r\n    \"about\": \"The minimum bytes to accumulate in the response.\" },\r\n  { \"name\": \"MaxBytes\", \"type\": \"int32\", \"versions\": \"3+\", \"default\": \"0x7fffffff\", \"ignorable\": true,\r\n    \"about\": \"The maximum bytes to fetch.  See KIP-74 for cases where this limit may not be honored.\" },\r\n  { \"name\": \"MaxNum\", \"type\": \"int32\", \"versions\": \"18+\", \"default\": \"-1\", \"ignorable\": true,\r\n    \"about\": \"The maximum number of messages to fetch. -1 means no limit.\" },\r\n  { \"name\": \"IsolationLevel\", \"type\": \"int8\", \"versions\": \"4+\", \"default\": \"0\", \"ignorable\": true,\r\n    \"about\": \"This setting controls the visibility of transactional records. Using READ_UNCOMMITTED (isolation_level = 0) makes all records visible. With READ_COMMITTED (isolation_level = 1), non-transactional and COMMITTED transactional records are visible. To be more concrete, READ_COMMITTED returns all data from offsets smaller than the current LSO (last stable offset), and enables the inclusion of the list of aborted transactions in the result, which allows consumers to discard ABORTED transactional records.\" },\r\n  { \"name\": \"SessionId\", \"type\": \"int32\", \"versions\": \"7+\", \"default\": \"0\", \"ignorable\": true,\r\n    \"about\": \"The fetch session ID.\" },\r\n  { \"name\": \"SessionEpoch\", \"type\": \"int32\", \"versions\": \"7+\", \"default\": \"-1\", \"ignorable\": true,\r\n    \"about\": \"The fetch session epoch, which is used for ordering requests in a session.\" },\r\n  { \"name\": \"Topics\", \"type\": \"[]FetchTopic\", \"versions\": \"0+\",\r\n    \"about\": \"The topics to fetch.\", \"fields\": [\r\n    { \"name\": \"Topic\", \"type\": \"string\", \"versions\": \"0-12\", \"entityType\": \"topicName\", \"ignorable\": true,\r\n      \"about\": \"The name of the topic to fetch.\" },\r\n    { \"name\": \"TopicId\", \"type\": \"uuid\", \"versions\": \"13+\", \"ignorable\": true, \"about\": \"The unique topic ID.\"},\r\n    { \"name\": \"Partitions\", \"type\": \"[]FetchPartition\", \"versions\": \"0+\",\r\n      \"about\": \"The partitions to fetch.\", \"fields\": [\r\n      { \"name\": \"Partition\", \"type\": \"int32\", \"versions\": \"0+\",\r\n        \"about\": \"The partition index.\" },\r\n      { \"name\": \"CurrentLeaderEpoch\", \"type\": \"int32\", \"versions\": \"9+\", \"default\": \"-1\", \"ignorable\": true,\r\n        \"about\": \"The current leader epoch of the partition.\" },\r\n      { \"name\": \"FetchOffset\", \"type\": \"int64\", \"versions\": \"0+\",\r\n        \"about\": \"The message offset.\" },\r\n      { \"name\": \"LastFetchedEpoch\", \"type\": \"int32\", \"versions\": \"12+\", \"default\": \"-1\", \"ignorable\": false,\r\n        \"about\": \"The epoch of the last fetched record or -1 if there is none.\"},\r\n      { \"name\": \"LogStartOffset\", \"type\": \"int64\", \"versions\": \"5+\", \"default\": \"-1\", \"ignorable\": true,\r\n        \"about\": \"The earliest available offset of the follower replica.  The field is only used when the request is sent by the follower.\"},\r\n      { \"name\": \"PartitionMaxBytes\", \"type\": \"int32\", \"versions\": \"0+\",\r\n        \"about\": \"The maximum bytes to fetch from this partition.  See KIP-74 for cases where this limit may not be honored.\" },\r\n      { \"name\": \"PartitionMaxNum\", \"type\": \"int32\", \"versions\": \"18+\", \"default\": \"-1\", \"ignorable\": true,\r\n        \"about\": \"The maximum number of messages to fetch from this partition. -1 means no limit.\" },\r\n      { \"name\": \"ReplicaDirectoryId\", \"type\": \"uuid\", \"versions\": \"17+\", \"taggedVersions\": \"17+\", \"tag\": 0, \"ignorable\": true,\r\n        \"about\": \"The directory id of the follower fetching.\" }\r\n    ]}\r\n  ]}, \r\n\r\n...{code}\r\n\u00a0\r\n----\r\n\r\n\u00a0", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=corkitse", "name": "corkitse", "key": "JIRAUSER310029", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER310029&avatarId=54294", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER310029&avatarId=54294", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER310029&avatarId=54294", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER310029&avatarId=54294"}, "displayName": "corkitse", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13624741/comment/18010332", "id": "18010332", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fvaleri", "name": "fvaleri", "key": "fvaleri", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Federico Valeri", "active": true, "timeZone": "Europe/Rome"}, "body": "Hello, this requires a KIP, are you going to create one?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=fvaleri", "name": "fvaleri", "key": "fvaleri", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Federico Valeri", "active": true, "timeZone": "Europe/Rome"}, "created": "2025-07-28T09:59:53.419+0000", "updated": "2025-07-28T09:59:53.419+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13624741/comment/18010371", "id": "18010371", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=corkitse", "name": "corkitse", "key": "JIRAUSER310029", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER310029&avatarId=54294", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER310029&avatarId=54294", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER310029&avatarId=54294", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER310029&avatarId=54294"}, "displayName": "corkitse", "active": true, "timeZone": "Etc/UTC"}, "body": "To Federico Valeri: Thanks for the feedback. Yes, I will start drafting a KIP for this proposal.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=corkitse", "name": "corkitse", "key": "JIRAUSER310029", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER310029&avatarId=54294", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER310029&avatarId=54294", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER310029&avatarId=54294", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER310029&avatarId=54294"}, "displayName": "corkitse", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-07-28T11:46:52.578+0000", "updated": "2025-07-28T11:46:52.578+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13624741/comment/18010378", "id": "18010378", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=apoorvmittal10", "name": "apoorvmittal10", "key": "apoorvmittal10", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=apoorvmittal10&avatarId=52944", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=apoorvmittal10&avatarId=52944", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=apoorvmittal10&avatarId=52944", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=apoorvmittal10&avatarId=52944"}, "displayName": "Apoorv Mittal", "active": true, "timeZone": "Etc/UTC"}, "body": "[~corkitse] Thanks for the proposal. I will review the KIP once drafted. However, just highlighting so you can reference, ShareGroups/QueuesForKafka already have that in request spec - [MaxRecords|https://github.com/apache/kafka/blob/abbb6b3c13f0b87b8e905f853b7b94282f8d355c/clients/src/main/resources/common/message/ShareFetchRequest.json#L39].", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=apoorvmittal10", "name": "apoorvmittal10", "key": "apoorvmittal10", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=apoorvmittal10&avatarId=52944", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=apoorvmittal10&avatarId=52944", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=apoorvmittal10&avatarId=52944", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=apoorvmittal10&avatarId=52944"}, "displayName": "Apoorv Mittal", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-07-28T12:12:37.779+0000", "updated": "2025-07-28T12:12:37.779+0000"}], "maxResults": 3, "total": 3, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}