{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13632655", "self": "https://issues.apache.org/jira/rest/api/2/issue/13632655", "key": "SPARK-54055", "fields": {"summary": "Spark Connect sessions leak pyspark UDF daemon processes and threads", "description": "Each Spark Connect session that uses Python UDFs seems to leak one PySpark `daemon` process. Over time, these can accumulate in the 100s until the corresponding node or container goes OOM (although it can take a while as each process doesn't use a lot of memory and some of those pages are shared).\r\n{code:java}\r\nspark \u00a0 \u00a0 \u00a0 \u00a0263 \u00a00.0 \u00a00.0 121424 59504 ? \u00a0 \u00a0 \u00a0 \u00a0S \u00a0 \u00a005:00 \u00a0 0:01 \u00a0\\_ /opt/spark/.venv/bin/python3 -m pyspark.daemon\r\nspark \u00a0 \u00a0 \u00a0 1515 \u00a00.0 \u00a00.0 121324 60148 ? \u00a0 \u00a0 \u00a0 \u00a0S \u00a0 \u00a005:04 \u00a0 0:01 \u00a0\\_ /opt/spark/.venv/bin/python3 -m pyspark.daemon\r\nspark \u00a0 \u00a0 \u00a0 1525 \u00a00.0 \u00a00.0 121324 60400 ? \u00a0 \u00a0 \u00a0 \u00a0S \u00a0 \u00a005:04 \u00a0 0:01 \u00a0\\_ /opt/spark/.venv/bin/python3 -m pyspark.daemon\r\nspark \u00a0 \u00a0 \u00a0 1568 \u00a00.0 \u00a00.0 121324 60280 ? \u00a0 \u00a0 \u00a0 \u00a0S \u00a0 \u00a005:04 \u00a0 0:01 \u00a0\\_ /opt/spark/.venv/bin/python3 -m pyspark.daemon{code}\r\nIn addition there are also threads leaking - e.g., here is a thread dump histogram from a sample executor with 200+ leaked daemon processes:\r\n{code:java}\r\n# These threads seem to be leaking\r\n226 threads   Idle Worker Monitor for /opt/spark/.venv/bin/python3\r\n226 threads \u00a0 process reaper\r\n226 threads \u00a0 stderr reader for /opt/spark/.venv/bin/python3\r\n226 threads   stdout reader for /opt/spark/.venv/bin/python3\r\n250 threads \u00a0 Worker Monitor for /opt/spark/.venv/bin/python3\r\n\r\n# These threads seem fine, Spark is configured with 24 cores/executor\r\n21 threads \u00a0  stdout writer for /opt/spark/.venv/bin/python3\r\n21 threads \u00a0  Writer Monitor for /opt/spark/.venv/bin/python3{code}\r\nWith Spark Connect, each session always has a `SPARK_JOB_ARTIFACT_UUID`, even if there are no artifacts, so the UDF environment built by `BasePythonRunner.compute` is always different, and each session ends up with its own `PythonWorkerFactory` and hence its own daemon process.\r\n\r\n`PythonWorkerFactory` has a `stop` method that stops the daemon, but there does not seem to be anyone that calls `PythonWorkerFactory.stop`, except at shutdown in `SparkEnv.stop`.\r\n\r\n\u00a0\r\n\r\nThis can be reproduced by running a bunch of Spark Connect sessions:\r\n{code:java}\r\nparallel -n0 .venv/bin/python3 dummy.py ::: {1..200} {code}\r\nwith `dummy.py`:\r\n{code:java}\r\nfrom collections.abc import Iterable\r\n\r\nimport pandas as pd\r\nfrom pyspark.sql import SparkSession\r\n\r\n\r\ndef _udf(iterator: Iterable[pd.DataFrame]) -> Iterable[pd.DataFrame]:\r\n    yield from iterator\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    spark = SparkSession.builder.remote(\"...\").getOrCreate()\r\n\r\n    df = spark.range(128)\r\n    df.mapInPandas(_udf, df.schema).count()\r\n {code}\r\n\u00a0", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=peay2", "name": "peay2", "key": "JIRAUSER307514", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Peter Andrew", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}