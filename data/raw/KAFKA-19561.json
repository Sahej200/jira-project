{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13624941", "self": "https://issues.apache.org/jira/rest/api/2/issue/13624941", "key": "KAFKA-19561", "fields": {"summary": "Request Timeout During SASL Reauthentication Due to Missed OP_WRITE  interest set ", "description": "We've observed request timeouts occurring during SASL reauthentication, and analysis suggests the issue is caused by a race condition between request handling and SASL reauthentication on the broker side. Here\u2019s the sequence:\r\n # Client sends a request (Req1) to the broker.\r\n # Client initiates SASL reauthentication.\r\n # Broker receives Req1.\r\n # Broker also begins SASL reauthentication.\r\n # While reauth is in progress:\r\n ** Broker completes processing of Req1 and prepares a response (Res1).\r\n ** Res1 is queued via KafkaChannel.send().\r\n ** Broker sets SelectionKey.OP_WRITE to indicate write readiness.\r\n ** However, Selector.attemptWrite() does not proceed because:\r\n *** channel.hasSend() is true, but\r\n *** channel.ready() is false (reauth is still in progress).\r\n # Once reauthentication completes: Broker removes SelectionKey.OP_WRITE.\r\n # At this point:\r\n ** channel.hasSend() and channel.ready() are now true,\r\n ** But key.isWritable() is false, so the response (Res1) is never sent.\r\n # The response remains stuck in the send buffer. Client eventually hits a request timeout.\r\n\r\nThe fix is to set write readiness using SelectionKey.OP_WRITE at the end of Step 6. This is similar to [what we do on client side|https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/security/authenticator/SaslClientAuthenticator.java#L422].", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=omkreddy", "name": "omkreddy", "key": "omkreddy", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Manikumar", "active": true, "timeZone": "Asia/Kolkata"}, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}