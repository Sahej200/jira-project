{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13623378", "self": "https://issues.apache.org/jira/rest/api/2/issue/13623378", "key": "HADOOP-19620", "fields": {"summary": "[ABFS] AzureADAuthenticator should be able to retry on UnknownHostException", "description": "When Hadoop is requested to perform operations against ADLS Gen2 storage, *AbfsRestOperation* attempts to obtain an access token from Microsoft. Underneath the hood, it uses a simple *java.net.HttpURLConnection* HTTP client.\r\n\r\nOccasionally, environments may run into network intermittent issues, including DNS-related {*}UnknownHostException{*}. Technically, the HTTP client throws *IOException* whose cause is {*}UnknownHostException{*}. *AzureADAuthenticator* in its turn catches {*}IOException{*}, sets *httperror = -1* and then checks whether the error is recoverable and can be retried. However, it's neither an instance of {*}MalformedURLException{*}, nor an instance of {*}FileNotFoundException{*}, nor a recoverable status code ({*}< 100 || == 408 || >= 500 && != 501 && != 505{*}), hence a retry never occurs which is sensitive for our project causing problems with state recovery.\r\n\r\nThe final exception stack trace on the client side looks as follows (Apache Spark application, tenant ID is redacted):\r\n{code:java}\r\nJob aborted due to stage failure: Task 14 in stage 384.0 failed 4 times, most recent failure: Lost task 14.3 in stage 384.0 TID 3087 10.244.91.7 executor 29 : Status code: -1 error code: null error message: Auth failure: HTTP Error -1; url='https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/token' AzureADAuthenticator.getTokenCall threw java.net.UnknownHostException: login.microsoftonline.com\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation.executeHttpOperation AbfsRestOperation.java:321\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation.completeExecute AbfsRestOperation.java:263\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation.lambda$execute$0 AbfsRestOperation.java:235\r\nat org.apache.hadoop.fs.statistics.impl.IOStatisticsBinding.measureDurationOfInvocation IOStatisticsBinding.java:494\r\nat org.apache.hadoop.fs.statistics.impl.IOStatisticsBinding.trackDurationOfInvocation IOStatisticsBinding.java:465\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation.execute AbfsRestOperation.java:233\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsClient.getPathStatus AbfsClient.java:1099\r\nat org.apache.hadoop.fs.azurebfs.AzureBlobFileSystemStore.getFileStatus AzureBlobFileSystemStore.java:1164\r\nat org.apache.hadoop.fs.azurebfs.Azure BlobFileSystem.getFileStatus AzureBlobFileSystem.java:766\r\nat org.apache.hadoop.fs.azurebfs.AzureBlobFileSystem.getFileStatus AzureBlobFileSystem.java:756\r\nat org.apache.parquet.hadoop.util.HadoopInputFile.fromPath HadoopInputFile.java:39\r\nat org.apache.spark.sql.execution.datasources.parquet.ParquetFooterReader.readFooter ParquetFooterReader.java:39\r\nat org.apache.spark.sql.execution.datasources.parquet.ParquetFileFormat.footerFileMetaData$lzycompute$1 ParquetFileFormat.scala:211\r\nat org.apache.spark.sql.execution.datasources.parquet.ParquetFileFormat.footerFileMetaData$1 ParquetFile Format.scala:210\r\nat org.apache.spark.sql.execution.datasources.parquet.ParquetFileFormat.$anonfun$buildReaderWithPartitionValues$2\r\nParquetFileFormat.scala:213\r\n...{code}\r\nI can see this exception is recovered in other parts of the Hadoop project (e.g., {*}DefaultAMSProcessor{*})\r\n\r\nWe would like to have similar retry mechanisms for fetching tokens. Moreover, *AbfsRestOperation* already handles and retries *UnknownHostException* but that part seems to be applicable only to storage communication, not token retrieval. I suppose the solution would be simple - just match the cause's class name of *IOException* if it is an instance of *UnknownHostException*\u00a0and apply retry policies as for other types of recoverable errors.\r\n\r\nThe link to the code where I believe *UnknownHostException* would be checked for:\r\n\r\n[https://github.com/apache/hadoop/blob/61096793f6368d16a21cde8b1c8f8dce41a4c102/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java#L354]", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=Serhii+Nesterov", "name": "Serhii Nesterov", "key": "JIRAUSER298214", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298214&avatarId=52153", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298214&avatarId=52153", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298214&avatarId=52153", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298214&avatarId=52153"}, "displayName": "Serhii Nesterov", "active": true, "timeZone": "Europe/Kiev"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13623378/comment/18007719", "id": "18007719", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=anujmodi", "name": "anujmodi", "key": "JIRAUSER307456", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"}, "displayName": "Anuj Modi", "active": true, "timeZone": "Asia/Kolkata"}, "body": "Hi [~Serhii Nesterov]\u00a0\r\nThanks for reporting.\r\nHowever I do see UnknownHostException getting retried.\u00a0\r\nTo confirm on this, I ingested an UnknownHostException [here just after token fetch|https://github.com/apache/hadoop/blob/d3690f07377e792b2a5d4a78b082d38e80497d44/hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/AzureADAuthenticator.java#L349] and saw request getting retried in debug logs.\r\n\r\nCan you please check once again.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=anujmodi", "name": "anujmodi", "key": "JIRAUSER307456", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"}, "displayName": "Anuj Modi", "active": true, "timeZone": "Asia/Kolkata"}, "created": "2025-07-17T06:11:46.958+0000", "updated": "2025-07-17T06:11:46.958+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13623378/comment/18007723", "id": "18007723", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=anujmodi", "name": "anujmodi", "key": "JIRAUSER307456", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"}, "displayName": "Anuj Modi", "active": true, "timeZone": "Asia/Kolkata"}, "body": "services.AbfsClient (AbfsRestOperation.java:signRequest(565)) - Authenticating request with OAuth2 access token\r\noauth2.AzureADAuthenticator (AzureADAuthenticator.java:getTokenUsingClientCreds(112)) - AADToken: starting to fetch token using client creds for client ID\u00a0\r\noauth2.AzureADAuthenticator (AzureADAuthenticator.java:getTokenCall(367)) - Retrying getTokenSingleCall. RetryCount = 1\r\noauth2.AzureADAuthenticator (AzureADAuthenticator.java:getTokenCall(367)) - Retrying getTokenSingleCall. RetryCount = 2\r\noauth2.AzureADAuthenticator (AzureADAuthenticator.java:getTokenCall(367)) - Retrying getTokenSingleCall. RetryCount = 3\r\noauth2.AzureADAuthenticator (AzureADAuthenticator.java:getTokenCall(367)) - Retrying getTokenSingleCall. RetryCount = 4\r\noauth2.AzureADAuthenticator (AzureADAuthenticator.java:getTokenCall(367)) - Retrying getTokenSingleCall. RetryCount = 5\r\n\r\nThe exception which you shared above is thrown outside retry loop as follows\r\n\r\nAuth failure: HTTP Error -1; url='' AzureADAuthenticator.getTokenCall threw java.net.UnknownHostException : login.microsoftonline.com\r\norg.apache.hadoop.fs.azurebfs.oauth2.AzureADAuthenticator$HttpException: HTTP Error -1; url='' AzureADAuthenticator.getTokenCall threw java.net.UnknownHostException : login.microsoftonline.com\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation.executeHttpOperation(AbfsRestOperation.java:410)\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation.completeExecute(AbfsRestOperation.java:323)\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation.lambda$execute$0(AbfsRestOperation.java:289)\r\nat org.apache.hadoop.fs.statistics.impl.IOStatisticsBinding.measureDurationOfInvocation(IOStatisticsBinding.java:494)\r\nat org.apache.hadoop.fs.statistics.impl.IOStatisticsBinding.trackDurationOfInvocation(IOStatisticsBinding.java:465)", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=anujmodi", "name": "anujmodi", "key": "JIRAUSER307456", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"}, "displayName": "Anuj Modi", "active": true, "timeZone": "Asia/Kolkata"}, "created": "2025-07-17T06:25:30.574+0000", "updated": "2025-07-18T04:31:06.997+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13623378/comment/18007766", "id": "18007766", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=Serhii+Nesterov", "name": "Serhii Nesterov", "key": "JIRAUSER298214", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298214&avatarId=52153", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298214&avatarId=52153", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298214&avatarId=52153", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298214&avatarId=52153"}, "displayName": "Serhii Nesterov", "active": true, "timeZone": "Europe/Kiev"}, "body": "[~anujmodi] Looks like you're right. Our retry just got exhausted obviously. The delay between retries is too small. I think we need to override *fs.azure.oauth.token.fetch.retry.delta.backoff* or f{*}s.azure.oauth.token.fetch.retry.min.backoff.interval{*} to a bigger value to increase intervals. I'm aslo seeing that higher level classes are also attempting to retry. Those *Retrying getTokenSingleCall* logs were printed 8 x 5 times which is a little inconvenient to configure. It's like retry over retry. Are there any suggestions how to properly set this up?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=Serhii+Nesterov", "name": "Serhii Nesterov", "key": "JIRAUSER298214", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298214&avatarId=52153", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298214&avatarId=52153", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298214&avatarId=52153", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298214&avatarId=52153"}, "displayName": "Serhii Nesterov", "active": true, "timeZone": "Europe/Kiev"}, "created": "2025-07-17T09:59:04.153+0000", "updated": "2025-07-17T10:24:08.288+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13623378/comment/18007978", "id": "18007978", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=anujmodi", "name": "anujmodi", "key": "JIRAUSER307456", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"}, "displayName": "Anuj Modi", "active": true, "timeZone": "Asia/Kolkata"}, "body": "Yes, that is true, we have to fetch the token for all the requests, even for the requests that are retried due to some server error.\r\nBut the retryloops are not completely nested.\r\n\r\nFor every request, we first try to fetch the token and if all the retries for token fetch are exhausted, we simple fail the whole request and that request is not retried by AbfsRestOperation.\r\n\r\nWhat you might be observing is the case where the token fetch for the original request failed with UnknownHostException for a few reties but eventually was able to fetch the token, then the request for which token was fetched failed with some retriable error and wnet for the retry. For this retried request we will again try to fetch the token. This time also if all the retries of token fetch requests fail, we won't further retry the original request and we will fail the operation.\r\n\r\nI can see how this can be confusing but that's the way network errors are handled today.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=anujmodi", "name": "anujmodi", "key": "JIRAUSER307456", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"}, "displayName": "Anuj Modi", "active": true, "timeZone": "Asia/Kolkata"}, "created": "2025-07-18T05:11:06.581+0000", "updated": "2025-07-18T05:11:06.581+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13623378/comment/18008080", "id": "18008080", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=Serhii+Nesterov", "name": "Serhii Nesterov", "key": "JIRAUSER298214", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298214&avatarId=52153", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298214&avatarId=52153", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298214&avatarId=52153", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298214&avatarId=52153"}, "displayName": "Serhii Nesterov", "active": true, "timeZone": "Europe/Kiev"}, "body": "[~anujmodi] Thank you for the explanation and devoting time to testing it! Sorry for false alarm. Please feel free to close this ticket", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=Serhii+Nesterov", "name": "Serhii Nesterov", "key": "JIRAUSER298214", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER298214&avatarId=52153", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER298214&avatarId=52153", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER298214&avatarId=52153", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER298214&avatarId=52153"}, "displayName": "Serhii Nesterov", "active": true, "timeZone": "Europe/Kiev"}, "created": "2025-07-18T13:53:09.232+0000", "updated": "2025-07-18T13:53:09.232+0000"}], "maxResults": 5, "total": 5, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/5", "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png", "name": "Resolved", "id": "5", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}}}