{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13627551", "self": "https://issues.apache.org/jira/rest/api/2/issue/13627551", "key": "KAFKA-19650", "fields": {"summary": "Add message key to org.apache.kafka.clients.producer.RecordMetadata", "description": "Although the message key is not really {_}metadata{_}, it may be useful to include it in the _org.apache.kafka.clients.producer.RecordMetadata_ class so that metdata can be tied back to a specific message.\r\nWhen using a standard Kafka producer it is easy to tie back the metadata to a specific message by using the callback mechanism.\r\nHowever, when using Kafka streams, the only way to access the metadata and log the details is to register a stream-level _org.apache.kafka.clients.producer.ProducerInterceptor_ instance.\r\nThis mechanism has a drawback in that it is impossible to tie the RecordMetadata instance back to a particular message. \r\nIncluding the message key in the metadata would solve this problem.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=schubertf", "name": "schubertf", "key": "schubertf", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=39936", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=39936", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=39936", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=39936"}, "displayName": "Schubert Fernandes", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13627551/comment/18017101", "id": "18017101", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Not sure if adding the key to RecordMetadata would be the right thing to do. As you already pointed out, is not really metadata.\r\n\r\nCan you elaborate on your use case, and what you try to accomplish in more details? It might be better to solve this issue at the KS layer?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-08-29T18:23:22.153+0000", "updated": "2025-08-29T18:23:22.153+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13627551/comment/18017368", "id": "18017368", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=schubertf", "name": "schubertf", "key": "schubertf", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=39936", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=39936", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=39936", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=39936"}, "displayName": "Schubert Fernandes", "active": true, "timeZone": "Etc/UTC"}, "body": "I have a Kafka Streams application that is part of a pipeline of applications which process messages off a series of Kafka topics.\r\nOne input message results in related messages on the different topics. The related messages on the downstream topics use the same message key as the input message.\r\nAs each application in the pipeline processes messages, the logging uses the Kafka message key on the logging context\u00a0 The message key can thus be used to trace processing across the entire application pipeline via the application logging.\r\n\r\nThe Kafka Streams application has a registered _org.apache.kafka.clients.producer.ProducerInterceptor_ instance which is used to log any exceptions that occur during message publishing, or, on success, to log the partition and offset of the output message{_}.{_}\r\nThe problem is that _org.apache.kafka.clients.producer.ProducerInterceptor.onAcknowledgement(RecordMetadata, Exception)_ is called from the producer thread created by the Kafka clients library and it doesn't have the details of the producer record, so there is no way for my application to put the message key into the logging context for any logging to pick up.\r\nIn hindsight, suggesting adding the key to the metadata was a bad idea.\r\nA better solution would be to add an overloaded variant of the\u00a0_onAcknowledgement_ method to _org.apache.kafka.clients.producer.ProducerInterceptor_ which takes the _org.apache.kafka.clients.producer.ProducerRecord<K, V>_ instance as an additional parameter.\r\nFrom browsing through the Kafka clients code, this looks doable, but I'll leave that decision up to you guys.\r\nThanks for your time.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=schubertf", "name": "schubertf", "key": "schubertf", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=39936", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=39936", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=39936", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=39936"}, "displayName": "Schubert Fernandes", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-09-01T06:54:24.822+0000", "updated": "2025-09-01T10:22:52.541+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}