{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13630876", "self": "https://issues.apache.org/jira/rest/api/2/issue/13630876", "key": "HADOOP-19718", "fields": {"summary": "[ABFS]: Throw HTTPException when AAD token fetch fails ", "description": "Reported by [~enigma25] :\r\nIn [this code snippet](https://github.com/Azure/azure-data-lake-store-java/blob/26eca936da60286aa70b0dd7823ff5e627987bc4/src/main/java/com/microsoft/azure/datalake/store/oauth2/AzureADAuthenticator.java#L252-L293) from AzureADAuthenticator, the `conn` is being returned as null due to a (possibly) corrupted connection between Azure Data Lake Store Client and AAD while fetching AAD token. The code snippet linked, runs into an NPE. I wanted to know from the maintainers and community if this bug/symptom has been seen by them earlier and what might be the best way to handle this? Secondly, I wanted to know the right place for the fix too - whether it should be the application code or the SDK code itself should handle such NPEs and fail more gracefully?\r\nOpen to thoughts and comments.\r\nCheers,\r\nNikhil\r\n\u00a0\r\n\u00a0\r\n```\r\njava.util.concurrent.ExecutionException: java.lang.NullPointerException: Cannot invoke \"java.io.InputStream.read(byte[], int, int)\" because \"inStream\" is null\r\nat org.apache.kafka.connect.util.ConvertingFutureCallback.result(ConvertingFutureCallback.java:135)\r\nat org.apache.kafka.connect.util.ConvertingFutureCallback.get(ConvertingFutureCallback.java:122)\r\nat org.apache.kafka.connect.runtime.rest.resources.ConnectorPluginsResource.validateConfigs(ConnectorPluginsResource.java:129)\r\nat java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)\r\nat java.base/java.lang.reflect.Method.invoke(Method.java:580)\r\nat org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:52)\r\nat org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:134)\r\nat org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:177)\r\nat org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$TypeOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:219)\r\nat org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:81)\r\nat org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:478)\r\nat org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:400)\r\nat org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:81)\r\nat org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:256)\r\nat org.glassfish.jersey.internal.Errors$1.call(Errors.java:248)\r\nat org.glassfish.jersey.internal.Errors$1.call(Errors.java:244)\r\nat org.glassfish.jersey.internal.Errors.process(Errors.java:292)\r\nat org.glassfish.jersey.internal.Errors.process(Errors.java:274)\r\nat org.glassfish.jersey.internal.Errors.process(Errors.java:244)\r\nat org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:265)\r\nat org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:235)\r\nat org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:684)\r\nat org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:394)\r\nat org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:346)\r\nat org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:358)\r\nat org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:311)\r\nat org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:205)\r\nat org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:799)\r\nat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:554)\r\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:233)\r\nat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1624)\r\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:233)\r\nat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1440)\r\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:188)\r\nat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:505)\r\nat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1594)\r\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:186)\r\nat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1355)\r\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\r\nat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:234)\r\nat org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:181)\r\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127)\r\nat org.eclipse.jetty.server.Server.handle(Server.java:516)\r\nat org.eclipse.jetty.server.HttpChannel.lambda$handle$1(HttpChannel.java:487)\r\nat org.eclipse.jetty.server.HttpChannel.dispatch(HttpChannel.java:732)\r\nat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:479)\r\nat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:277)\r\nat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:311)\r\nat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:105)\r\nat org.eclipse.jetty.io.ChannelEndPoint$1.run(ChannelEndPoint.java:104)\r\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:338)\r\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:315)\r\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:173)\r\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:131)\r\nat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:409)\r\nat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:883)\r\nat org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:1034)\r\nat java.base/java.lang.Thread.run(Thread.java:1583)\r\nCaused by: java.lang.NullPointerException: Cannot invoke \"java.io.InputStream.read(byte[], int, int)\" because \"inStream\" is null\r\nat org.apache.hadoop.fs.azurebfs.oauth2.AzureADAuthenticator.consumeInputStream(AzureADAuthenticator.java:345)\r\nat org.apache.hadoop.fs.azurebfs.oauth2.AzureADAuthenticator.getTokenSingleCall(AzureADAuthenticator.java:275)\r\nat org.apache.hadoop.fs.azurebfs.oauth2.AzureADAuthenticator.getTokenCall(AzureADAuthenticator.java:216)\r\nat org.apache.hadoop.fs.azurebfs.oauth2.AzureADAuthenticator.getTokenUsingClientCreds(AzureADAuthenticator.java:95)\r\nat org.apache.hadoop.fs.azurebfs.oauth2.ClientCredsTokenProvider.refreshToken(ClientCredsTokenProvider.java:58)\r\nat org.apache.hadoop.fs.azurebfs.oauth2.AccessTokenProvider.getToken(AccessTokenProvider.java:50)\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsClient.getAccessToken(AbfsClient.java:583)\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation.executeHttpOperation(AbfsRestOperation.java:162)\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation.execute(AbfsRestOperation.java:134)\r\nat org.apache.hadoop.fs.azurebfs.services.AbfsClient.getFilesystemProperties(AbfsClient.java:205)\r\nat io.confluent.connect.azure.datalake.gen2.validation.Validations.verifyClient(Validations.java:175)\r\nat io.confluent.connect.azure.datalake.gen2.validation.Validations.createAndValidateClient(Validations.java:395)\r\nat io.confluent.connect.azure.datalake.gen2.validation.Validations.validateAll(Validations.java:131)\r\nat io.confluent.connect.utils.validators.all.ConfigValidation.lambda$callValidators$0(ConfigValidation.java:222)\r\nat java.base/java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:1024)\r\nat java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:762)\r\nat io.confluent.connect.utils.validators.all.ConfigValidation.callValidators(ConfigValidation.java:222)\r\nat io.confluent.connect.utils.validators.all.ConfigValidation.validate(ConfigValidation.java:182)\r\nat io.confluent.connect.azure.datalake.gen2.AzureDataLakeGen2SinkConnector.validate(AzureDataLakeGen2SinkConnector.java:97)\r\nat org.apache.kafka.connect.runtime.AbstractHerder.validateConnectorConfig(AbstractHerder.java:641)\r\nat org.apache.kafka.connect.runtime.AbstractHerder.lambda$validateConnectorConfig$7(AbstractHerder.java:493)\r\nat java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:572)\r\nat java.base/java.util.concurrent.FutureTask.run(FutureTask.java:317)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)\r\n... 1 more\r\n```", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=snvijaya", "name": "snvijaya", "key": "snvijaya", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Sneha Vijayarajan", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}