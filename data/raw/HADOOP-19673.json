{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13627890", "self": "https://issues.apache.org/jira/rest/api/2/issue/13627890", "key": "HADOOP-19673", "fields": {"summary": "BloomMapFile: invalid io.mapfile.bloom.error.rate (\u22640 or \u22651) causes NaN/zero vector size and writer construction failure", "description": "{{BloomMapFile.Writer#initBloomFilter(Configuration)}} computes the Bloom filter vector size as:\r\n{code:java}\r\nint numKeys = conf.getInt(IO_MAPFILE_BLOOM_SIZE_KEY, IO_MAPFILE_BLOOM_SIZE_DEFAULT);\r\nfloat errorRate = conf.getFloat(IO_MAPFILE_BLOOM_ERROR_RATE_KEY, IO_MAPFILE_BLOOM_ERROR_RATE_DEFAULT);\r\nint vectorSize = (int) Math.ceil(\r\n\u00a0 (double)(-HASH_COUNT * numKeys) /\r\n\u00a0 Math.log(1.0 - Math.pow(errorRate, 1.0 / HASH_COUNT))\r\n); {code}\r\nWhen {{io.mapfile.bloom.error.rate}} is *\u2264 0*\u00a0or {*}\u2265 1{*}:\r\n * {{Math.pow(errorRate, 1/k)}} produces *NaN* (negative base with non-integer exponent) or an invalid value;\r\n * {{Math.log(1 - NaN)}} becomes {*}NaN{*};\r\n * {{Math.ceil(NaN)}} cast to {{int}} yields {*}0{*}, so {{{}vectorSize == 0{}}};\r\n * constructing {{DynamicBloomFilter}} subsequently fails, and {{BloomMapFile.Writer}} construction fails (observed as assertion failure in tests).\r\n\r\nThe code misses input validation for {{io.mapfile.bloom.error.rate}} which should be strictly within {{{}(0, 1){}}}. With invalid values, the math silently degrades to NaN/0 and fails at runtime.\r\n\r\n*Reproduction*\r\n\r\nInjected values: {{io.mapfile.bloom.error.rate = 0,-1}}\r\n\r\nTest: {{org.apache.hadoop.io.TestBloomMapFile#testBloomMapFileConstructors}}\r\n{code:java}\r\n[INFO] Running org.apache.hadoop.io.TestBloomMapFile\r\n[ERROR] Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 0.358 s <<< FAILURE! - in org.apache.hadoop.io.TestBloomMapFile\r\n[ERROR] org.apache.hadoop.io.TestBloomMapFile.testBloomMapFileConstructors \u00a0Time elapsed: 0.272 s \u00a0<<< FAILURE!\r\njava.lang.AssertionError: testBloomMapFileConstructors error !!!\r\n\u00a0 \u00a0 \u00a0 \u00a0 at org.apache.hadoop.io.TestBloomMapFile.testBloomMapFileConstructors(TestBloomMapFile.java:287{code}", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=AMC-team", "name": "AMC-team", "key": "amc-team", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34058", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"}, "displayName": "AMC-team", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/10002", "description": "A patch for this issue has been uploaded to JIRA by a contributor.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/document.png", "name": "Patch Available", "id": "10002", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/4", "id": 4, "key": "indeterminate", "colorName": "yellow", "name": "In Progress"}}}}