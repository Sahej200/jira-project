{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13630796", "self": "https://issues.apache.org/jira/rest/api/2/issue/13630796", "key": "KAFKA-19759", "fields": {"summary": "Add built-in TTL (Time-to-Live) support for Kafka Streams State Stores", "description": "In business cases Kafka Streams users frequently need *per-key Time-To-Live (TTL)* behavior for state stores such as keyValueStore or kTables , typically to model cache-like or deduplication scenarios.\r\n\r\nToday, achieving this requires *manual handling* using:\r\n * Custom timestamp tracking per key,\r\n\r\n * Punctuators to periodically scan and remove expired entries, and\r\n\r\n * Manual emission of tombstones to maintain changelog consistency.\r\n\r\nThese workarounds are:\r\n * {*}Inconsistent across applications{*}, and\r\n\r\n * {*}Operationally costly{*}, as each developer must reimplement the same logic.\r\n\r\n*Proposal* is to introduce a *built-in TTL mechanism* for Kafka Streams state stores, allowing automatic expiration of records after a configured duration.\r\n\r\nIntroduction to new Api's like :\u00a0\r\n\r\nStoreBuilder<T> withTTL(Duration ttl);\r\nMaterialized<K, V, S> withTtl(Duration ttl);\r\n\r\nWhen configured:\r\n * Each record\u2019s timestamp (from event-time or processing-time) is tracked.\r\n\r\n * Expired keys are automatically evicted by a background task (via ProcessorContext.Schedule()).\r\n\r\n * Corresponding tombstones are flushed to changelog.\r\n\r\nThis feature can provide a *TTL abstraction* that simplifies common use cases as:\r\n * Maintaining cache-like state (e.g., last-seen values with limited lifespan)\r\n\r\n * Automatically purging inactive or stale keys without manual cleanup.\r\n\r\nPoints of Risk and Benifits i considered it can bring :\u00a0\r\n * Consistency as automatic changelog tombstones will preserve correctness across rebalances and restores.\r\n\r\n * Will help to avoid boilerplate punctuator code for manual expiration.\r\n\r\n * TTL is optional and opt-in; existing stores remain unaffected so backward compatibility would be maintaoined.\r\n\r\nExample to StateStore/ kTable inferface :\u00a0\r\n\r\nKTable<String, UserSession> sessions = builder\r\n\u00a0 \u00a0 .table(\"sessions\", Materialized.<String, UserSession, KeyValueStore<Bytes, byte[]>>as(\"session-store\")\r\n\u00a0 \u00a0 \u00a0 \u00a0 .withTtl(Duration.ofHours(1))\r\n\u00a0 \u00a0 \u00a0 \u00a0 .withValueSerde(userSessionSerde));\r\n\r\nHere, session entries older than 1 hour will be automatically expired and deleted from the local RocksDB store and hence a flush ~ tombstone to changelog topic.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ankursinha07", "name": "ankursinha07", "key": "JIRAUSER311142", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34048", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34048", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34048", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34048"}, "displayName": "Ankur Sinha", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13630796/comment/18027879", "id": "18027879", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dhruvardhan", "name": "dhruvardhan", "key": "JIRAUSER311107", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER311107&avatarId=54525", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER311107&avatarId=54525", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER311107&avatarId=54525", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER311107&avatarId=54525"}, "displayName": "Dhruva Vardhan", "active": true, "timeZone": "Etc/UTC"}, "body": "Dear [~ankursinha07] -\r\n * I see the positives in implementing TTL concept since it's augmenting developer's productivity by eliminating repetitive TTL boilerplate and punctuator code.\u00a0\r\n * It ensures changelog consistency with automatic tombstones.\r\n * Opt-in design maintains existing store behavior.\r\n\r\nFew aspects which we should thought about -\u00a0\r\n * Eviction tasks might increase I/O load on RocksDB, especially in large stores.\r\n * For operational needs - A metrics/tracing hooks (e.g., number of expired keys, sweep duration, lag in eviction) to monitor TTL behavior.\r\n * During changelog restoration, TTL-expired records should not be reloaded \u2014 implementation must ensure cleanup consistency across restore cycles.\r\n * Deleting many keys generates tombstones - the compaction strategy must efficiently reclaim disk space.\r\n\r\n\u00a0\r\n\r\noverall, built-in TTL is a meaningful option simplifying state management and improving reliability in long-running Kafka Streams applications. With careful attention to eviction performance and observability, this feature could significantly elevate the developer experience.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dhruvardhan", "name": "dhruvardhan", "key": "JIRAUSER311107", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER311107&avatarId=54525", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER311107&avatarId=54525", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER311107&avatarId=54525", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER311107&avatarId=54525"}, "displayName": "Dhruva Vardhan", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-06T17:54:14.679+0000", "updated": "2025-10-06T17:54:14.679+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630796/comment/18027899", "id": "18027899", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Is there any difference to https://issues.apache.org/jira/browse/KAFKA-4212 \u2013 or is this ticket a duplicate?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-06T19:31:36.431+0000", "updated": "2025-10-06T19:31:36.431+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630796/comment/18027912", "id": "18027912", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ankursinha07", "name": "ankursinha07", "key": "JIRAUSER311142", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34048", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34048", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34048", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34048"}, "displayName": "Ankur Sinha", "active": true, "timeZone": "Etc/UTC"}, "body": "Hello [~mjsax]\u00a0\r\n\r\nThis ticket obviously is relates to KAFKA-4212 and went through the code pushed & discussions, but the concept is not a duplicate. KAFKA-4212 introduced a specific TTL store, whereas with this the proposal is to have\u00a0 *general TTL support for all state stores* with automatic eviction and changelog tombstones.\r\n\r\nCurrently, i implement TTL manually using a timestampedkeyvalstore:\r\n\r\ncontext.schedule(Duration.ofDays(scheduledFrequencyDays), PunctuationType.WALL_CLOCK_TIME, timestamp - > {\r\n\u00a0 \u00a0 try (var iterator = stateStore.all()) {\r\n\u00a0 \u00a0 \u00a0 \u00a0 while (iterator.hasNext()) {\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 var entry = iterator.next();\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if (entry.value.timestamp() + Duration.ofDays(retentionDays).toMillis() <= timestamp)\r\n\r\n{ \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 stateStore.delete(entry.key); \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\r\n\r\n\u00a0 \u00a0 \u00a0 \u00a0 }\r\n\u00a0 \u00a0 }\r\n});\r\n\r\n\u00a0\r\n\r\nRight now i consider wallclocktime only to trigger cleanup at fixed time irrespective of incoming records to puntuate ~ StreAM_tIME, independent of new records.\r\n\r\nWith this idea is to simplify things as below\r\n\r\n{{Stores.persistentKeyValueStore(\"state-store\")\r\n.withTtl(Duration.ofDays(retentionDays));}}\r\n * TTL evictionwould be {*}automatic{*}.\r\n\r\n * expired entries would generate {*}changelog tombstones{*}.\r\n\r\n * no manual scheduling or iteration required.\r\n\r\n * to work consistently for all state stores, not just a specific store type.\r\n\r\n * .withTtl(duration){{{}{}}} is {*}optional at the API level{*}: passing null would mean {*}no TTL is applied{*}, and the store behaves like a normal persistent store.\r\n\r\n * Any store without a TTL set will still function normally, maintaining {*}backward compatibility{*}.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ankursinha07", "name": "ankursinha07", "key": "JIRAUSER311142", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34048", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34048", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34048", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34048"}, "displayName": "Ankur Sinha", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-06T20:39:31.358+0000", "updated": "2025-10-06T20:53:00.466+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630796/comment/18027931", "id": "18027931", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Thanks for clarifying.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-06T22:44:46.198+0000", "updated": "2025-10-06T22:44:46.198+0000"}], "maxResults": 4, "total": 4, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}