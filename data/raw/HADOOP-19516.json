{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13613176", "self": "https://issues.apache.org/jira/rest/api/2/issue/13613176", "key": "HADOOP-19516", "fields": {"summary": "S3A: SDK reads content twice during PUT to S3 Express store.", "description": "The commit on trunk {{60c7d4fea010}} and on branch 3.4 {{f3ec55b}} fixes the logging, but does not\r\naddress the underlying issue.\r\n\r\nh2. problem\r\n\r\nDuring PUT calls, even of 0 byte objects, our UploadContentProver is reporting a recreation of \r\nof the input stream of an UploadContentProvider, as seen by our logging at info of this happening\r\n\r\n{code}\r\n bin/hadoop fs -touchz $v3/4\r\n2025-03-26 13:38:53,377 [main] INFO  impl.UploadContentProviders (UploadContentProviders.java:newStream(289)) - Stream recreated: FileWithOffsetContentProvider{file=/tmp/hadoop-stevel/s3a/s3ablock-0001-659277820991634509.tmp, offset=0} BaseContentProvider{size=0, initiated at 2025-03-26T13:38:53.355, streamCreationCount=2, currentStream=null}\r\n{code}\r\n\r\nThis code was added in HADOOP-19221, S3A: Unable to recover from failure of multipart block upload attempt \"Status Code: 400; Error Code: RequestTimeout\"; it logs at INFO because it is considered both rare and serious enough that we should log it, based on our hypothesis that it was triggered by a transient failure of the S3 service front and and the inability of the SDK to recover from it\r\n\r\nIt turns out that uploading even a zero byte file to S3 triggers the dual creation of the stream, apparently from a dual signing.\r\n\r\nThis *does not* happen on multipart uploads.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org", "name": "stevel@apache.org", "key": "stevel@apache.org", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"}, "displayName": "Steve Loughran", "active": true, "timeZone": "Europe/London"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13613176/comment/17938663", "id": "17938663", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org", "name": "stevel@apache.org", "key": "stevel@apache.org", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"}, "displayName": "Steve Loughran", "active": true, "timeZone": "Europe/London"}, "body": "This exists on older releases; i'd just not noticed. That is why we MUST test  against so many different endpoints.\r\n\r\nA lot of the s3 express code path in the SDK is  different from the S3 standard client, and so needs to be tested independently.\r\n\r\n\r\nFor the SDK upgrade I will downgrade the log to debug and leave it to the SDK team to fix themselves.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org", "name": "stevel@apache.org", "key": "stevel@apache.org", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"}, "displayName": "Steve Loughran", "active": true, "timeZone": "Europe/London"}, "created": "2025-03-26T16:57:35.987+0000", "updated": "2025-03-26T16:57:35.987+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13613176/comment/17955851", "id": "17955851", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org", "name": "stevel@apache.org", "key": "stevel@apache.org", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"}, "displayName": "Steve Loughran", "active": true, "timeZone": "Europe/London"}, "body": "[~iwasakims] not fixed in our code...this appears to be an AWS SDK bug. has it gone away there?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org", "name": "stevel@apache.org", "key": "stevel@apache.org", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"}, "displayName": "Steve Loughran", "active": true, "timeZone": "Europe/London"}, "created": "2025-06-03T10:09:25.079+0000", "updated": "2025-06-03T10:09:25.079+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13613176/comment/17955856", "id": "17955856", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=iwasakims", "name": "iwasakims", "key": "iwasakims", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=iwasakims&avatarId=38403", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=iwasakims&avatarId=38403", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=iwasakims&avatarId=38403", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=iwasakims&avatarId=38403"}, "displayName": "Masatake Iwasaki", "active": true, "timeZone": "Asia/Tokyo"}, "body": "[~stevel@apache.org] oops. I misunderstood by just seeing only the first line of [commit message|https://github.com/apache/hadoop/commit/f3ec55b5911d1e5e7da438c64f614a59a7db62a3].", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=iwasakims", "name": "iwasakims", "key": "iwasakims", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=iwasakims&avatarId=38403", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=iwasakims&avatarId=38403", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=iwasakims&avatarId=38403", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=iwasakims&avatarId=38403"}, "displayName": "Masatake Iwasaki", "active": true, "timeZone": "Asia/Tokyo"}, "created": "2025-06-03T10:58:33.861+0000", "updated": "2025-06-03T10:59:51.854+0000"}], "maxResults": 3, "total": 3, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/4", "description": "This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/reopened.png", "name": "Reopened", "id": "4", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}