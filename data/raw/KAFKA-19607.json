{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13626437", "self": "https://issues.apache.org/jira/rest/api/2/issue/13626437", "key": "KAFKA-19607", "fields": {"summary": "MirrorMaker2 Offset Replication Issue", "description": "I am using *Apache Kafka 4.0*\u00a0with\u00a0*MirrorMaker 2*\u00a0to link the primary cluster ({*}clusterA{*}) to the secondary cluster ({*}clusterB{*}).\r\nThe secondary cluster will not have any producers or consumers until a disaster recovery event occurs, at which point all producers and consumers will switch to it.\r\n\r\n*Setup:*\r\n * Dedicated standalone MirrorMaker 2 node\r\n * {{IdentityReplicationPolicy}}\u00a0(no topic renaming)\r\n * No clients connected to secondary cluster under normal operation\r\n\r\n*MirrorMaker 2 config:*\r\n\u00a0{{# Cluster aliases\r\nclusters = clusterA, clusterB\r\n\r\n# Bootstrap servers\r\nclusterA.bootstrap.servers = serverA-kafka-1:9092\r\nclusterB.bootstrap.servers = serverB-kafka-1:9092\r\n\r\n# Replication policy\r\nreplication.policy.class=org.apache.kafka.connect.mirror.IdentityReplicationPolicy\r\n\r\n# Offset/Checkpoint sync\r\nemit.checkpoints.enabled=true\r\nemit.checkpoints.interval.seconds=5\r\nsync.group.offsets.enabled=true\r\nsync.group.offsets.interval.seconds=5\r\noffset.lag.max=10\r\nrefresh.topics.interval.seconds=5}}\r\n----\r\nh3. Test results:\r\n # *Produce 300 messages when MirrorMaker is running*\r\n*Expected:*\u00a0Topic offset synced within a minute\r\n*Result:*\u00a0\u2705 Passed\r\n\r\n # *Consume 100 messages when MirrorMaker is running, then terminate the consumer*\r\n*Expected:*\u00a0Consumer offset synced\r\n*Result:*\u00a0\u274c Failed \u2014 offset is not synced to clusterB\r\n\r\n # *Restart MirrorMaker after test #2*\r\n*Expected:*\u00a0Consumer offset synced\r\n*Result:*\u00a0\u2705 Passed\r\n\r\n # *Repeat test #2 \u2014 consume 100 messages when MirrorMaker is running, then terminate the consumer*\r\n*Expected:*\u00a0Consumer offset synced\r\n*Result:*\u00a0\u274c Failed \u2014 offset is not synced to clusterB\r\n\r\n # *Restart MirrorMaker after test #4*\r\n*Expected:*\u00a0Consumer offset synced\r\n*Result:*\u00a0\u274c Failed \u2014 offset is not synced to clusterB\r\n\r\n # *Consume messages but keep consumer running*\r\n*Expected:*\u00a0Offset synced\r\n*Result:*\u00a0\u2705 Passed\r\n\r\n----\r\nh3. Problem:\r\n\r\nConsumer offsets appear to only sync in these cases:\r\n # When MirrorMaker is restarted and the consumer offset does\u00a0*not*\u00a0already exist in the secondary cluster (initial sync), or\r\n # When the consumer is still connected at the time of sync,\u00a0*or*\u00a0when the consumer has reached the end of the offset (i.e., consumed all available messages).\r\n\r\nHowever, if the consumer exits immediately after consuming some messages (but\u00a0{*}before reaching the end of the topic{*}), the committed offset is\u00a0*never synced*\u00a0to the target cluster.\r\n----\r\nh3. Additional Context / Related Issues\r\n\r\nThis problem seems related to an open discussion in the Apache Kafka mailing list:\r\n\r\n*MirrorCheckpointConnector does not replicate final batch of offsets*\r\n[https://lists.apache.org/thread/dxn9jyotl00f7ov541299cd8tlcl1z00]", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=geric", "name": "geric", "key": "JIRAUSER310720", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "geric", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13626437/comment/18014142", "id": "18014142", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=gharris1727", "name": "gharris1727", "key": "gharris1727", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg Harris", "active": true, "timeZone": "Etc/UTC"}, "body": "Hi [~geric] Please see the other related tickets in this area:\r\n * https://issues.apache.org/jira/browse/KAFKA-16364\r\n * https://issues.apache.org/jira/browse/KAFKA-16291\u00a0\r\n * https://issues.apache.org/jira/browse/KAFKA-15564\u00a0\r\n * [https://github.com/apache/kafka/pull/15423]\u00a0\r\n\r\nFor a detailed explanation of this behavior, please see this conference talk:\u00a0\r\n\r\n[https://current.confluent.io/2024-sessions/mirrormaker-2s-offset-translation-isnt-exactly-once-and-thats-okay]\u00a0\r\n\r\nFarther from the end of the topic (lag is ~200) the translation is worse (lag can double to ~400). Because you have only 300 messages in the topic, it looks like the offset never gets translated, or translates to 0 or 1.\r\n\r\nWith a larger example (1000 messages produced, 800 messages consumed) I would expect translation to lead to a downstream consumer lag of ~400. Also be aware that resetting the consumer offsets may not be sufficient to clear the MM2 state in the checkpoints topics. Make sure to use a new consumer group for further experiments with the same MM2 instance.\r\n\r\nFor applications, you either need to let your consumers reach 0 lag prior to cut-over, or you need to tolerate some re-delivery on the destination side.\r\n\r\nHope this helps!", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=gharris1727", "name": "gharris1727", "key": "gharris1727", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg Harris", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-15T15:09:47.791+0000", "updated": "2025-08-15T15:09:47.791+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626437/comment/18014482", "id": "18014482", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=geric", "name": "geric", "key": "JIRAUSER310720", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "geric", "active": true, "timeZone": "Etc/UTC"}, "body": "Hi Greg,\u00a0\r\nThanks for replying.\u00a0\r\n\r\nIn a planned flip to DR, is there a way for me to force sync the consumer offsets?\r\n\r\nExample: to delete all the consumers and re-sync the offset?\r\n\r\nThanks\r\n\r\nGeric\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=geric", "name": "geric", "key": "JIRAUSER310720", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "geric", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-18T03:11:36.569+0000", "updated": "2025-08-18T03:11:36.569+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626437/comment/18014666", "id": "18014666", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=gharris1727", "name": "gharris1727", "key": "gharris1727", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg Harris", "active": true, "timeZone": "Etc/UTC"}, "body": "[~geric] I'm not sure exactly what you mean by force-sync. I mentioned in my last message \"you either need to let your consumers reach 0 lag prior to cut-over, or ...\".\r\n\r\nTo be more explicit, If you're planning to flip to the target cluster and want minimum redelivery you should:\r\n1. Stop the source producers\r\n2. Wait for source consumers to reach 0 lag and commit offsets\r\n3. Wait for MM2 to translate the offsets to get 0 lag on the target\r\n4. Alter target ACLs and start target producers\r\n5. Start the target consumers\r\n6. Stop MM2 mirroring\r\n\r\nStep 3 is the synchronization point, because if you perform step (4) early, some of the newly produced data will be dropped (data loss), and if you perform step (5) early, MM2 won't be able to sync offsets into an active group (extra redelivery).", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=gharris1727", "name": "gharris1727", "key": "gharris1727", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg Harris", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-18T16:12:17.476+0000", "updated": "2025-08-18T16:12:17.476+0000"}], "maxResults": 3, "total": 3, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}