{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13626926", "self": "https://issues.apache.org/jira/rest/api/2/issue/13626926", "key": "KAFKA-19629", "fields": {"summary": "Deadlock in Kafka Streams when processing Interactive Queries and state store updates concurrently", "description": "We are using a Kafka Streams topology that continuously writes large volumes of data into a RocksDB state store with stable throughput. In parallel, another thread executes Interactive Query (IQ) requests against the same local state store.\r\n\r\nWhen the number of IQ requests in the queue grows (\u224850+), the application enters a {*}deadlock state{*}.\r\n\r\n*Investigation:*\r\nUsing a thread dump, we discovered a lock inversion between RocksDB operations:\r\n * {{RocksDBStore.put}}\r\n\r\n ** blocked on {{org.apache.kafka.streams.query.Position@4ba00b6c}}\r\n\r\n ** holding {{org.apache.kafka.streams.state.internals.RocksDBStore@414cff0e}}\r\n\r\n * {{RocksDBStore.range}}\r\n\r\n ** blocked on {{org.apache.kafka.streams.state.internals.RocksDBStore@414cff0e}}\r\n\r\n ** holding {{org.apache.kafka.streams.query.Position@4ba00b6c}}\r\n\r\nThis indicates that {*}{{put}} and {{range}} acquire the same locks but in different order{*}, which leads to deadlock under concurrent load.\r\n\r\n*Expected Behavior:*\r\nKafka Streams API should guarantee deadlock-free operation. Store writes ({{{}put{}}}) and IQ reads ({{{}range{}}}) should not block each other in a way that leads to lock inversion.\r\n\r\n*Steps to Reproduce:*\r\n # Create a Kafka Streams topology with a RocksDB state store receiving continuous writes.\r\n\r\n # In a parallel thread, issue a high number of Interactive Query {{range}} requests (\u224850+ queued).\r\n\r\n # Observe that the system eventually enters deadlock.\r\n\r\n * \u00a0\r\n\r\n*Impact:*\r\n * Application stops processing data.\r\n\r\n * Interactive Queries fail indefinitely.\r\n\r\n * Requires manual restart to recover.\r\n\r\n*Notes:*\r\n * Appears to be a lock ordering bug in {{{}RocksDBStore{}}}.\r\n\r\n * Expected the Streams API to coordinate thread-safety and prevent such deadlocks.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=pevgheni", "name": "pevgheni", "key": "JIRAUSER310759", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34055", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"}, "displayName": "Evgheni Popusoi", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13626926/comment/18015527", "id": "18015527", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Thanks for filing this ticket. Seems the changes of KAFKA-15770 introduced this issue. Not 100% sure yet, what the right fix is, but not allocating locks in the same order on all code path is for sure incorrect.\r\n\r\nWe do lock `Position` object inside `StoreQueryUtils#handleBasicQueries(...)` \u2013 maybe we would need to lock the passed in `store`, first?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-08-21T21:56:10.137+0000", "updated": "2025-08-21T21:56:10.137+0000"}], "maxResults": 1, "total": 1, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}