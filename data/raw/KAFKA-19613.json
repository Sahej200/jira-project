{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13626521", "self": "https://issues.apache.org/jira/rest/api/2/issue/13626521", "key": "KAFKA-19613", "fields": {"summary": "Expose consumer CorruptRecordException", "description": "As part of our analysis around KAFKA-19430, we realized it's not possible to handle a {{CorruptRecordException}}\u00a0in Streams because it's not exposed to the client; instead, a generic {{KafkaException}}\u00a0**\u00a0is thrown\r\n\r\nThe proposed solution is to expose {{CorruptRecordException}} with information about affected TopicPartition and offset we're trying read from\r\n\r\nKIP: https://cwiki.apache.org/confluence/x/NQrxFg", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18014998", "id": "18014998", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "body": "[~mjsax]\r\nGood evening. Sorry for ping, but I wasn't sure if you've got a notification.\u00a0\r\nPath is available, it's simple\r\n\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-19T19:57:47.845+0000", "updated": "2025-08-19T19:57:47.845+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18015590", "id": "18015590", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=FliegenKLATSCH", "name": "FliegenKLATSCH", "key": "fliegenklatsch", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "FliegenKLATSCH", "active": true, "timeZone": "Europe/Berlin"}, "body": "Since the clients are supposed to skip a corrupted message, it would also be beneficial if the partition and maybe the offset is added to the `CorruptRecordException`. Parsing the exception message is uncool and currently I don't see another way to get the partition?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=FliegenKLATSCH", "name": "FliegenKLATSCH", "key": "fliegenklatsch", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "FliegenKLATSCH", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-08-22T07:02:21.465+0000", "updated": "2025-08-22T07:02:21.465+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18015606", "id": "18015606", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "body": "Definitely parsing of String message is not a solution. The idea here was just to expose exception, but let me check if more changes for consumer are required\u00a0\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-22T08:26:10.514+0000", "updated": "2025-08-22T08:26:10.514+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18015617", "id": "18015617", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "body": "Okay. We can expose TopicPartition and fetchOffset within CorruptRecordException. This will help us handle original issue in KS (using Consumer#seek for TP and offset from exception)", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-22T08:59:32.106+0000", "updated": "2025-08-22T08:59:32.106+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18015746", "id": "18015746", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "[~lianetm] WDYT?\r\n\r\nExposing partition and offset information seems useful to skip over a corrupted batch IMHO \u2013 but it's a public API change, and will require a KIP.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-08-22T23:20:46.006+0000", "updated": "2025-08-22T23:20:46.006+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18016004", "id": "18016004", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lianetm", "name": "lianetm", "key": "JIRAUSER300183", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER300183&avatarId=52523", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER300183&avatarId=52523", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER300183&avatarId=52523", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER300183&avatarId=52523"}, "displayName": "Lianet Magrans", "active": true, "timeZone": "America/Toronto"}, "body": "Agree it sounds useful to expose a Corrupt error including TP and offset (with KIP), but just to be clear, this info is not passed to the client at the moment, so it's not only about changing the client poll API, we need to sort out if the info is available when generating the error on the broker side? Just to be sure that this is doable, and that we can determine a corrupt/helpful offset to pass back in the error", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lianetm", "name": "lianetm", "key": "JIRAUSER300183", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER300183&avatarId=52523", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER300183&avatarId=52523", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER300183&avatarId=52523", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER300183&avatarId=52523"}, "displayName": "Lianet Magrans", "active": true, "timeZone": "America/Toronto"}, "created": "2025-08-25T13:55:51.016+0000", "updated": "2025-08-25T13:55:51.016+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18016014", "id": "18016014", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "body": "[~lianetm]\u00a0\r\nHello\u00a0\r\nJust today I've got an access to Kafka Confluence. I'll start working on KIP ASAP\r\nRe-think my idea and what I see:\r\nWhat client (FetchCollector#handleInitializeErrors) gives us is not an offset of corrupted message, but message we were trying to fetch. See an example:\r\n!corrupted_records.excalidraw.png!\r\n\r\n\u00a0\r\n\r\nIf consumer is trying to read 512 bytes it will fail, as a response will contain 2 messages and corrupted part. Correct me, if I'm wrong here\r\n\r\nMy proposal was to skip (seek last read offset +1) until we'll read successfully, but this way we can lose the messages.\u00a0\r\nWe can also do something else... return the messages before corruption... and return the corrupted offset from the broker, here I don't know how many afford it will take. I need to analyze it. What do you think?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-25T14:36:16.982+0000", "updated": "2025-08-26T14:14:19.393+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18016512", "id": "18016512", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=FliegenKLATSCH", "name": "FliegenKLATSCH", "key": "fliegenklatsch", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "FliegenKLATSCH", "active": true, "timeZone": "Europe/Berlin"}, "body": "Line ~140:\r\n{code:java}\r\n} catch (KafkaException e) {\r\n    if (fetch.isEmpty())\r\n        throw e;{code}\r\nOn the first poll, the 2 records would be returned. On the next poll, we would throw the CorruptRecordException. If we seek then forward, we would skip only the broken Record(batches).", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=FliegenKLATSCH", "name": "FliegenKLATSCH", "key": "fliegenklatsch", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "FliegenKLATSCH", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-08-27T11:22:58.705+0000", "updated": "2025-08-27T11:23:31.033+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18017196", "id": "18017196", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "body": "[~FliegenKLATSCH] I checked this on unit test, fetch is empty here. I think we need to confirm how broker behaves in this case, and verify if this is a case when broker will send us response with correct and corrupted messages\r\n\r\n[~lianetm] \r\nI check the broker code and have a question:\r\n\r\nAbstractFetcherThread#processFetchRequest has this comment just after catch for corrupted message exception:\r\n//we log the error and continue. This ensures two things\r\n// 1. If there is a corrupt message in a topic partition, it does not bring the fetcher thread\r\n// \u00a0 \u00a0down and cause other topic partition to also lag\r\n\u00a0// 2. If the message is corrupt due to a transient state in the log (truncation, partial writes\r\n// \u00a0 \u00a0can cause this), we simply continue and should get fixed in the subsequent fetches\r\n\r\nCase 2 looks for me as retriable error. Are you sure, this is not retriable? FYI: this comment is from 2018, so I believe it can be outdated, just want to be sure\r\n\r\nUPD: I've analyzed broker behavior and in short:\r\nComment I've mentioned above this is not about reading message from log, but about appending information for followers, not sure if this is related to current ticket, but that's the only place in code where I found connection between CorruptedMessageException\r\nReplicaManager#read looks to me as it's trying to read max bytes and just fail if there is any error, but I couldn't find any uses of CorruptedMessageException in this path\r\nCould you please suggest any broker person to contact with to verify broker behavior?\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-30T17:19:39.413+0000", "updated": "2025-08-30T22:41:43.384+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18017428", "id": "18017428", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=FliegenKLATSCH", "name": "FliegenKLATSCH", "key": "fliegenklatsch", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "FliegenKLATSCH", "active": true, "timeZone": "Europe/Berlin"}, "body": "Correct me, if I am wrong, but not sure which error gets created on the broker side - the client validates the CRC checksum?!\r\n\r\nA follower acts like a normal client(?). So it should also validate the CRC checksum and as long as nobody seeks ahead, it just hangs with an exception - so the behaviour would not change. (And I've seen this behaviour.)\r\n\r\nAnd since I am talking about observations: We have a replica 4 setup, with minISR 2; we've seen cases where the leader has a broken message, but 1 replica is fine, the 2 others are hanging because of the broken record. So another beneficial approach would be to try to read from another available broker. But I guess that is out of scope here. And maybe even partially implemented already with preferred-read-replica.\r\n\r\nAnd regarding the retry: If we're using an example of broken memory, the corruption could be introduced on reading and on another read attempt, with different memory sections being used, could succeed. So there is probably no definite answer to \"should we retry or not\". The client has to decide, like it currently is. We should just expose the information and not change the behaviour.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=FliegenKLATSCH", "name": "FliegenKLATSCH", "key": "fliegenklatsch", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "FliegenKLATSCH", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-09-01T12:08:52.771+0000", "updated": "2025-09-01T12:08:52.771+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18017511", "id": "18017511", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "body": "About CRC checksum validation, that's depend I guess. This issue was created based on original one for Kafka Streams (btw, this is a reason why I'm also thinking / asking about validation) and exception was thrown from FetchCollector#initialize method, so this is not about reading records and fail with CRC check error, but about getting FetchResponse with error from broker. You can check AbstractFetch#handleFetchSuccess method, if I missed something, but I don't see any validation of broker response before FetchCollector#initialize method\r\n\r\nUPD: Checked it one more time and I don't see if we set this error in any place in consumer, we only check it. This means it's already here when we get response from the broker. Correct me if i miss something", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-09-01T16:32:43.904+0000", "updated": "2025-09-01T16:39:10.347+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18017536", "id": "18017536", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=FliegenKLATSCH", "name": "FliegenKLATSCH", "key": "fliegenklatsch", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "FliegenKLATSCH", "active": true, "timeZone": "Europe/Berlin"}, "body": "Indeed the error would probably not be filled in the FetchCollector#initialize method, not sure if this can happen. If the broker would not be able to persist the message, I hope the producer doesn't get an ACK. And on reading the client should validate the CRC checksum and the broker probably doesn't need to care. But it would not hurt to handle it the same way.\r\n\r\nThe CorruptRecordException would be thrown in FetchCollector#fetchRecords, so CompletedFetch#maybeEnsureValid has to be modified to add the information there (2 times and 2 times in ShareCompletedFetch, for the record and the batch each).\r\nIn CompletedFetch#fetchRecords it's still encapsulated in a KafkaException. Not sure if that is good/needed, but it also doesn't hurt, we just need to unwrap on the client side. And the note about seeking makes sense.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=FliegenKLATSCH", "name": "FliegenKLATSCH", "key": "fliegenklatsch", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "FliegenKLATSCH", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-09-01T19:14:42.810+0000", "updated": "2025-09-01T19:14:42.810+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18017538", "id": "18017538", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "body": "I'd separate those cases:\r\n # CorruptMessageException when client validates records e.g. FetchCollector#fetchRecords and CompletedFetch#maybeEnsureValid under the hood. For this case your proposal makes sense, and user can decide how to recover\u00a0\r\n # CorruptMessageException on broker response. This still can be the case (see stack trace [https://github.com/confluentinc/kafka-streams-examples/issues/524] ) and then we need to verify, if there is possibility of loosing messages in case of seeking. Currently it looks to me as if broker can't read the log, partition data on response will be completely empty (as I understand no partial reading, when there is two records and fail at same time)\r\n\r\nUPD: Checked what Lianet wrote about this error in KS ticket:\r\n{quote}I believe so, a fetch request including a partition and offset should fail with CorruptMessage if any record that needs to be included on that response (according to the fetch max bytes limits etc) is found corrupted on the broker when reading the log to generate the fetch response (but to double check on the broker-side handling of fetch in case I'm missing something)\r\n\r\nget it on the consumer path: I expect it means the broker identified the data as corrupted when reading from the log -> I would expect this is not retriable (ex. disk corrupted)\r\n{quote}\r\nMay be it makes sense to even separate those cases (broker can't read and broker can read, but client rejects with CRC validation) and report first one with different exception?\r\n\r\n[~mjsax] [~lianetm] What do you think?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-09-01T19:34:00.804+0000", "updated": "2025-09-01T19:43:44.746+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626521/comment/18023272", "id": "18023272", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "body": "[~lianetm] [~mjsax]\u00a0\r\nHello All,\r\nKIP is already prepared. Could you please take a look?\r\nhttps://cwiki.apache.org/confluence/display/KAFKA/KIP-1218%3A+Expose+consumer+CorruptRecordException", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bloku", "name": "bloku", "key": "JIRAUSER309258", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Uladzislau Blok", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-09-27T10:45:11.829+0000", "updated": "2025-09-27T10:45:40.804+0000"}], "maxResults": 14, "total": 14, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/3", "description": "This issue is being actively worked on at the moment by the assignee.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/inprogress.png", "name": "In Progress", "id": "3", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/4", "id": 4, "key": "indeterminate", "colorName": "yellow", "name": "In Progress"}}}}