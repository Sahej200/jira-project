{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13628209", "self": "https://issues.apache.org/jira/rest/api/2/issue/13628209", "key": "KAFKA-19675", "fields": {"summary": " StreamsOnTasksAssignedCallbackNeededEvent could not be completed ", "description": "In several tests, for example PlaintextAdminIntegrationTest, we see this exception silently triggered when the consumer is closed.\r\n\r\n\u00a0\r\n{code:java}\r\norg.apache.kafka.common.errors.TimeoutException: StreamsOnTasksAssignedCallbackNeededEvent could not be completed before the consumer closed[2025-09-05 14:17:40,972] ERROR [Consumer clientId=consumer-stream_group_id_1-1, groupId=stream_group_id_1] Reconciliation failed: callback invocation failed for tasks LocalAssignment{localEpoch=0, activeTasks={subtopology-0=[0, 1, 2]}, standbyTasks={}, warmupTasks={}} (org.apache.kafka.clients.consumer.internals.StreamsMembershipManager:1077)java.util.concurrent.CompletionException: org.apache.kafka.common.errors.TimeoutException: StreamsOnTasksAssignedCallbackNeededEvent could not be completed before the consumer closed\tat java.base/java.util.concurrent.CompletableFuture.encodeRelay(CompletableFuture.java:368)\tat java.base/java.util.concurrent.CompletableFuture.completeRelay(CompletableFuture.java:377)\tat java.base/java.util.concurrent.CompletableFuture$UniRelay.tryFire(CompletableFuture.java:1097)\tat java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)\tat java.base/java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2162)\tat org.apache.kafka.clients.consumer.internals.events.CompletableEventReaper.completeEventsExceptionallyOnClose(CompletableEventReaper.java:202)\tat org.apache.kafka.clients.consumer.internals.events.CompletableEventReaper.reap(CompletableEventReaper.java:149)\tat org.apache.kafka.clients.consumer.internals.AsyncKafkaConsumer.close(AsyncKafkaConsumer.java:1493) {code}", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lucasbru", "name": "lucasbru", "key": "JIRAUSER302322", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER302322&avatarId=53242", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER302322&avatarId=53242", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER302322&avatarId=53242", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER302322&avatarId=53242"}, "displayName": "Lucas Brutschy", "active": true, "timeZone": "Europe/Berlin"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13628209/comment/18018380", "id": "18018380", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lianetm", "name": "lianetm", "key": "JIRAUSER300183", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER300183&avatarId=52523", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER300183&avatarId=52523", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER300183&avatarId=52523", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER300183&avatarId=52523"}, "displayName": "Lianet Magrans", "active": true, "timeZone": "America/Toronto"}, "body": "Hey, in case it helps, assuming the contract for onTaskAssigned is the same as onPartitionsAssigned, it should only be triggered within a call to poll, so we don't want it triggered on close even if there is a pending event for it (so this log you shared would be expected, in the case where close happens when there is a callback needed event in the queue but no poll before closing)\u00a0\r\n\r\nNote that on the consumer there is no processing of background events on close, intentionally, as we don't want to be triggering all callbacks or processing more errors. On close it's just the onPartitionsREvoked/Lost that are expected, so they are simply triggered directly on the app thread ([https://github.com/apache/kafka/blob/b92d47d48791dc379d67239489fcf1bf8016b6b1/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1481] )\r\n\r\nNot sure about the contract regarding streams callbacks, but if it's the same as with the consumer callbacks, we probably just need to ensure that the streamsTaskRevoked/Lost are triggered on close I would expect.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lianetm", "name": "lianetm", "key": "JIRAUSER300183", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER300183&avatarId=52523", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER300183&avatarId=52523", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER300183&avatarId=52523", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER300183&avatarId=52523"}, "displayName": "Lianet Magrans", "active": true, "timeZone": "America/Toronto"}, "created": "2025-09-05T13:20:18.409+0000", "updated": "2025-09-05T13:20:18.409+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13628209/comment/18019374", "id": "18019374", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lucasbru", "name": "lucasbru", "key": "JIRAUSER302322", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER302322&avatarId=53242", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER302322&avatarId=53242", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER302322&avatarId=53242", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER302322&avatarId=53242"}, "displayName": "Lucas Brutschy", "active": true, "timeZone": "Europe/Berlin"}, "body": "I'm closing this, since it's noise and as disucssed wih Lianet, the noise is hard avoid", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lucasbru", "name": "lucasbru", "key": "JIRAUSER302322", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER302322&avatarId=53242", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER302322&avatarId=53242", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER302322&avatarId=53242", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER302322&avatarId=53242"}, "displayName": "Lucas Brutschy", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-09-10T14:50:27.488+0000", "updated": "2025-09-10T14:50:27.488+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/5", "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png", "name": "Resolved", "id": "5", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}}}