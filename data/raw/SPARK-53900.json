{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13631511", "self": "https://issues.apache.org/jira/rest/api/2/issue/13631511", "key": "SPARK-53900", "fields": {"summary": "Thread.wait(0) unintentionally called under rare conditions in ExecuteGrpcResponseSender", "description": "\u00a0\r\n\r\nA bug in ExecuteGrpcResponseSender causes RPC streams to hang indefinitely when the configured deadline passes. The bug was introduced in [[PR|https://github.com/apache/spark/pull/49003/files#diff-d4629281431427e41afd6d3db6630bcfdbfdbf77ba74cf7e48a988c1b66c13f1L244-L253]|https://github.com/apache/spark/pull/49003/files#diff-d4629281431427e41afd6d3db6630bcfdbfdbf77ba74cf7e48a988c1b66c13f1L244-L253]\u00a0during migration from System.currentTimeMillis() to System.nanoTime(), where an integer division error converts sub-millisecond timeout values to 0, triggering Java's wait(0) behavior (infinite wait).\r\nh2. Root Cause\r\nexecutionObserver.responseLock.wait(timeoutNs / NANOS_PER_MILLIS) \u00a0// \u2190 BUG\r\n{*}The Problem{*}: When deadlineTimeNs < System.nanoTime() (deadline has passed):\r\n # Math.max(1, negative_value) clamps to 1 nanosecond\r\n\r\n # Math.min(progressInterval_ns, 1) remains 1 nanosecond\r\n\r\n # Integer division: 1 / 1,000,000 = 0 milliseconds\r\n\r\n # wait(0) in Java means *wait indefinitely until notified*\r\n\r\n # No notification arrives (execution already completed), thread hangs forever\r\n\r\nWhile one the loop conditions\u00a0guards against deadlineTimeNs < System.nanoTime(), it isn\u2019t sufficient as the deadline can elapse while inside the loop (the time is freshly fetched in the latter timeout calculation). The probability of occurence can exacerbated by GC pauses\r\nh2. Conditions Required for Bug to Trigger\r\n\r\nThe bug manifests when *all* of the following conditions are met:\r\n # *Reattachable execution enabled* (CONNECT_EXECUTE_REATTACHABLE_ENABLED = true)\r\n\r\n # *Execution completes prior* to the deadline within the inner loop\r\n\r\n # (all responses sent before deadline)\r\n\r\n # *Deadline passes* within the inner loop\r\n\r\nh2. Proposed fix\r\n\r\nHave timeoutNs always contain a positive value.\r\nexecutionObserver.responseLock.wait(Math.max(1, timeoutNs / NANOS_PER_MILLIS))", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=vicennial", "name": "vicennial", "key": "vicennial", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34050", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"}, "displayName": "Venkata Sai Akhil Gudesa", "active": true, "timeZone": "Europe/Amsterdam"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13631511/comment/18029817", "id": "18029817", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=hvanhovell", "name": "hvanhovell", "key": "hvanhovell", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Herman van H\u00f6vell", "active": true, "timeZone": "Europe/Amsterdam"}, "body": "Issue resolved by pull request 52609\n[https://github.com/apache/spark/pull/52609]", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=hvanhovell", "name": "hvanhovell", "key": "hvanhovell", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Herman van H\u00f6vell", "active": true, "timeZone": "Europe/Amsterdam"}, "created": "2025-10-14T16:05:14.475+0000", "updated": "2025-10-14T16:05:14.475+0000"}], "maxResults": 1, "total": 1, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/5", "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png", "name": "Resolved", "id": "5", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}}}