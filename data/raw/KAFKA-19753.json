{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13630537", "self": "https://issues.apache.org/jira/rest/api/2/issue/13630537", "key": "KAFKA-19753", "fields": {"summary": "Metrics from FetchMetricsManager containing a topic tag are duplicated", "description": "Hello,\r\n\r\nSince Kafka 4.1.0, we're experiencing an issue with Kafka Streams metrics for topics containing dots in their names. (I think the problem is also for simple usage of consumers not only kstream)\r\n\r\nIn FetchMetricsManager, methods like {{recordRecordsFetched()}} now create duplicate sensors for the same topic if they contain dot in their name:\u00a0\r\n{code:java}\r\nvoid recordRecordsFetched(String topic, int records) { \r\n\r\n\r\n String name = topicRecordsFetchedMetricName(topic); \r\n\r\n\r\n maybeRecordDeprecatedRecordsFetched(name, topic, records); <-- here we create another sensor if the topic name contains dot\r\n\r\n\r\n\r\n\r\n Sensor recordsFetched = new SensorBuilder(metrics, name, () -> Map.of(\"topic\", topic)) \r\n\r\n\r\n .withAvg(metricsRegistry.topicRecordsPerRequestAvg) \r\n\r\n\r\n .withMeter(metricsRegistry.topicRecordsConsumedRate, metricsRegistry.topicRecordsConsumedTotal) \r\n\r\n\r\n .build(); \r\n\r\n\r\n recordsFetched.record(records); \r\n\r\n\r\n }  {code}\r\nIt currently record two sensors, one with my original topic name, one time with a topic name with dots replaced by underscore.\u00a0\r\n\r\n-While we can work around this by reversing the transformation in our case (replacing underscores back to dots in Micrometer filters) or by removing this specific list of metrics, this does not feel like a long-term solution for us.-\r\n\r\nCurrently using spring-boot and micrometer, it's really hard to remove one of those duplicated metrics.\u00a0\r\n\r\nCould a configuration option be added to disable one of the two sensor to avoid having duplicated metrics?\r\n\r\nThanks in advance", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024284", "id": "18024284", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chia7712", "name": "chia7712", "key": "chia7712", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=chia7712&avatarId=46815", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chia7712&avatarId=46815", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chia7712&avatarId=46815", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chia7712&avatarId=46815"}, "displayName": "Chia-Ping Tsai", "active": true, "timeZone": "Asia/Taipei"}, "body": "[~chosante] Thanks for the report. Out of curiosity, why are the underscores being replaced with dots? I would have assumed you could simply focus on the new sensor and ignore the deprecated one", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chia7712", "name": "chia7712", "key": "chia7712", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=chia7712&avatarId=46815", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chia7712&avatarId=46815", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chia7712&avatarId=46815", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chia7712&avatarId=46815"}, "displayName": "Chia-Ping Tsai", "active": true, "timeZone": "Asia/Taipei"}, "created": "2025-10-02T14:17:38.753+0000", "updated": "2025-10-02T14:17:38.753+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024333", "id": "18024333", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "body": "Hey you are right, it is not clear, but in our case if we put the same name and tags, under the hood they are considered duplicates when registered and one of them will be discarded. (like we want)\r\n\r\n\u00a0\r\n\r\nEDIT: after doing tests, what's above does not work, the metrics are merged instead of being deduplicated and therefore each increment of one of them is incrementing the same counter", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "created": "2025-10-02T19:02:01.970+0000", "updated": "2025-10-03T08:44:53.800+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024408", "id": "18024408", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chia7712", "name": "chia7712", "key": "chia7712", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=chia7712&avatarId=46815", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chia7712&avatarId=46815", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chia7712&avatarId=46815", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chia7712&avatarId=46815"}, "displayName": "Chia-Ping Tsai", "active": true, "timeZone": "Asia/Taipei"}, "body": "Excuse me. I don\u2019t get the point of the issue. Kafka now create two sensor and then why the deprecated one makes trouble on your application? The deprecated one is kept for the compatibility, and so it means it exists for a while already.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chia7712", "name": "chia7712", "key": "chia7712", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=chia7712&avatarId=46815", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chia7712&avatarId=46815", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chia7712&avatarId=46815", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chia7712&avatarId=46815"}, "displayName": "Chia-Ping Tsai", "active": true, "timeZone": "Asia/Taipei"}, "created": "2025-10-03T07:18:58.792+0000", "updated": "2025-10-03T07:18:58.792+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024416", "id": "18024416", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "body": "Because it means now that I have two metrics reporting the same number so if I want to know the number of records fetched, my number is now multiplied by 2 in my dashboards reading those metrics.\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "created": "2025-10-03T07:40:58.728+0000", "updated": "2025-10-03T07:40:58.728+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024417", "id": "18024417", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "body": "An example in some app using 4.1.0:\u00a0\r\n!Screenshot 2025-10-03 at 09.44.11.png!\r\n\r\nand another using 3.9.1:\u00a0\r\n\r\n!Screenshot 2025-10-03 at 09.46.42.png!\r\n\r\n\u00a0\r\n\r\ntell me if that's not clear enough, I'll try to explain myself better...", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "created": "2025-10-03T07:47:36.424+0000", "updated": "2025-10-03T07:47:36.424+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024427", "id": "18024427", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=apoorvmittal10", "name": "apoorvmittal10", "key": "apoorvmittal10", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=apoorvmittal10&avatarId=52944", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=apoorvmittal10&avatarId=52944", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=apoorvmittal10&avatarId=52944", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=apoorvmittal10&avatarId=52944"}, "displayName": "Apoorv Mittal", "active": true, "timeZone": "Etc/UTC"}, "body": "Hi [~chosante], yes that's a downside for a deprecated metric and the expectation is to filter the incorrect metric i.e. one which do not preserve the original topic name, dots replaced with underscore. The reason there exists the deprecated metric is because of backward compatibility, what [~chia7712] also mentioned.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=apoorvmittal10", "name": "apoorvmittal10", "key": "apoorvmittal10", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=apoorvmittal10&avatarId=52944", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=apoorvmittal10&avatarId=52944", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=apoorvmittal10&avatarId=52944", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=apoorvmittal10&avatarId=52944"}, "displayName": "Apoorv Mittal", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-03T08:45:48.730+0000", "updated": "2025-10-03T08:45:48.730+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024436", "id": "18024436", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "body": "I understand, so I should bring this issue to micrometer instead? Since I cannot easily filter out those metrics myself in the end. I tried multiple hours to find an elegant solution to filter out the new or the deprecated one but currently it is not that easy as everything is auto-configured in spring. I would love to being able to not create them in the first place. I believe that this issue will arise in many projects not only mine as the only thing to do is to use kafka 4.1.0 with spring-boot and spring-kafka and there you go you have duplicated metrics.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "created": "2025-10-03T09:41:26.814+0000", "updated": "2025-10-03T09:41:26.814+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024562", "id": "18024562", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "I agree with [~chosante] \u2013 I think the thing that is missing (from the KIP?), is just an (internal?) config, to allow people to _disable_ double reporting? We obviously need to double report by default, to not break anybody, but not having a way to opt-out of double reporting, and only getting the new metrics (or maybe even also only getting the old metrics) seems to be something we should support?\r\n\r\nGiven that the KIP is already shipped, it might be simplest to add an internal config, to close this gap? Or would we want to alter the KIP and add a public config for it?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-03T17:42:05.573+0000", "updated": "2025-10-03T17:42:05.573+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024579", "id": "18024579", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chia7712", "name": "chia7712", "key": "chia7712", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=chia7712&avatarId=46815", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chia7712&avatarId=46815", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chia7712&avatarId=46815", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chia7712&avatarId=46815"}, "displayName": "Chia-Ping Tsai", "active": true, "timeZone": "Asia/Taipei"}, "body": "Have you considered using metrics.jmx.exclude to prevent JmxReporter from exposing deprecated metrics?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chia7712", "name": "chia7712", "key": "chia7712", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=chia7712&avatarId=46815", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chia7712&avatarId=46815", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chia7712&avatarId=46815", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chia7712&avatarId=46815"}, "displayName": "Chia-Ping Tsai", "active": true, "timeZone": "Asia/Taipei"}, "created": "2025-10-03T19:02:29.594+0000", "updated": "2025-10-03T19:02:29.594+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024773", "id": "18024773", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "body": "I could do that, though I am not using Jmx to export kafka metrics, currently using KafkaConsumer.metrics(), KafkaStreams.metrics(), etc... under the hood. As all the apps using spring-kafka.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chosante", "name": "chosante", "key": "JIRAUSER301644", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Charles-Eddy", "active": true, "timeZone": "Europe/Paris"}, "created": "2025-10-05T11:51:52.922+0000", "updated": "2025-10-05T11:52:10.957+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13630537/comment/18024794", "id": "18024794", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chia7712", "name": "chia7712", "key": "chia7712", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=chia7712&avatarId=46815", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chia7712&avatarId=46815", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chia7712&avatarId=46815", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chia7712&avatarId=46815"}, "displayName": "Chia-Ping Tsai", "active": true, "timeZone": "Asia/Taipei"}, "body": "I'm thinking about the scope of the internal confg. Since the consumer is not the only component with deprecated metrics, perhaps this config should be applied to other components as well?\r\n\r\nWhat do you think?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=chia7712", "name": "chia7712", "key": "chia7712", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=chia7712&avatarId=46815", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chia7712&avatarId=46815", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chia7712&avatarId=46815", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chia7712&avatarId=46815"}, "displayName": "Chia-Ping Tsai", "active": true, "timeZone": "Asia/Taipei"}, "created": "2025-10-05T16:17:23.379+0000", "updated": "2025-10-05T16:17:23.379+0000"}], "maxResults": 11, "total": 11, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}