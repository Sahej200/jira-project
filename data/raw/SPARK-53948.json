{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13631941", "self": "https://issues.apache.org/jira/rest/api/2/issue/13631941", "key": "SPARK-53948", "fields": {"summary": "Fix deadlock in Observation", "description": "Observation class has been evolved a few times during Spark 3.5 to Spark 4.0.0. Previously it uses locking mechanism (synchronized) between get and onFinish methods to coordinate metrics update and retrieval.\r\n\r\nBut it has a potential deadlocking bug. If get is called before ObservationListener is triggered to call onFinish, get will forever be waiting for metrics because it locks the observation object by synchronized so later onFinish call is locked out from updating the metrics.\r\n\r\nThis locking mechanism was replaced by a promise by SPARK-49423 which is a large refactoring on the observation feature. But in the PR, I don\u2019t see the deadlock bug was mentioned, and there is no bug fix PR proposed to earlier versions. So I think that the bug was not known and the fix is unintentional in Spark 4.0.0. The bug is still in Spark 3.5 branch.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=viirya", "name": "viirya", "key": "viirya", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=viirya&avatarId=40656", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=viirya&avatarId=40656", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=viirya&avatarId=40656", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=viirya&avatarId=40656"}, "displayName": "L. C. Hsieh", "active": true, "timeZone": "Asia/Shanghai"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13631941/comment/18031214", "id": "18031214", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=Gengliang.Wang", "name": "Gengliang.Wang", "key": "gengliang.wang", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=gengliang.wang&avatarId=36477", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gengliang.wang&avatarId=36477", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gengliang.wang&avatarId=36477", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gengliang.wang&avatarId=36477"}, "displayName": "Gengliang Wang", "active": true, "timeZone": "Asia/Hong_Kong"}, "body": "Issue resolved by pull request 52657\n[https://github.com/apache/spark/pull/52657]", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=Gengliang.Wang", "name": "Gengliang.Wang", "key": "gengliang.wang", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=gengliang.wang&avatarId=36477", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gengliang.wang&avatarId=36477", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gengliang.wang&avatarId=36477", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gengliang.wang&avatarId=36477"}, "displayName": "Gengliang Wang", "active": true, "timeZone": "Asia/Hong_Kong"}, "created": "2025-10-20T16:45:17.721+0000", "updated": "2025-10-20T16:45:17.721+0000"}], "maxResults": 1, "total": 1, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/5", "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png", "name": "Resolved", "id": "5", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}}}