{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13627085", "self": "https://issues.apache.org/jira/rest/api/2/issue/13627085", "key": "KAFKA-19638", "fields": {"summary": "NPE in `Processor#init()` accessing state store", "description": "As reported on the dev mailing list, we introduced a regression bug via https://issues.apache.org/jira/browse/KAFKA-13722 in 4.1 branch. We did revert the commit ([https://github.com/apache/kafka/commit/f13a22af0b3a48a4ca1bf2ece5b58f31e3b26b7d]) for 4.1 release, and want to fix-forward for 4.2 release.\r\n\r\nStacktrace:\r\n{code:java}\r\n15:29:05 ERROR [STREAMS] KafkaStreams - stream-client [app1] Encountered the following exception during processing and the registered exception handler opted to SHUTDOWN_CLIENT. The streams client is going to shut down now.\r\norg.apache.kafka.streams.errors.StreamsException: failed to initialize processor random-value-processor\r\n        at org.apache.kafka.streams.processor.internals.ProcessorNode.init(ProcessorNode.java:132) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.ProcessorNode.init(ProcessorNode.java:141) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.StreamTask.initializeTopology(StreamTask.java:1109) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.StreamTask.completeRestoration(StreamTask.java:297) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.TaskManager.tryToCompleteRestoration(TaskManager.java:955) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.StreamThread.initializeAndRestorePhase(StreamThread.java:1417) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.StreamThread.runOnceWithoutProcessingThreads(StreamThread.java:1219) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:934) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:894) [kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\nCaused by: java.lang.NullPointerException: Cannot invoke \"org.apache.kafka.streams.processor.internals.ProcessorRecordContext.timestamp()\" because the return value of \"org.apache.kafka.streams.processor.internals.InternalProcessorContext.recordContext()\" is null\r\n        at org.apache.kafka.streams.state.internals.ChangeLoggingKeyValueBytesStore.put(ChangeLoggingKeyValueBytesStore.java:69) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.state.internals.ChangeLoggingKeyValueBytesStore.put(ChangeLoggingKeyValueBytesStore.java:32) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.state.internals.MeteredKeyValueStore.lambda$put$6(MeteredKeyValueStore.java:303) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.maybeMeasureLatency(StreamsMetricsImpl.java:901) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.state.internals.MeteredKeyValueStore.put(MeteredKeyValueStore.java:303) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.AbstractReadWriteDecorator$KeyValueStoreReadWriteDecorator.put(AbstractReadWriteDecorator.java:123) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        at io.littlehorse.simulations.stateful.app.RandomValueProcessor.init(RandomValueProcessor.java:21) ~[kafka-streams-stateful-unspecified.jar:?]\r\n        at org.apache.kafka.streams.processor.internals.ProcessorNode.init(ProcessorNode.java:124) ~[kafka-streams-4.2.0-SNAPSHOT.jar:?]\r\n        ... 8 more {code}\r\nThanks [~eduwerc] for reporting the issue.\r\n\r\nWe clearly have a testing gap, not trying to use a state store within `Processor#init()`. \u2013 We need to close this gap.\r\n\r\nHowever, there is also the question if using zero as surrogate ts for this case (as the old code does), is a good solution or not? \u2013 We could try to use stream-time, but for the very first startup of an application, we also do not have stream-time established yet, so we kinda push the can down the road.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13627085/comment/18017528", "id": "18017528", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ancjainil", "name": "ancjainil", "key": "JIRAUSER310849", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Jainil Rana", "active": true, "timeZone": "Etc/UTC"}, "body": "Hi @mjsax, I\u2019d like to work on this issue and submit a patch, can you please assign it to me?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ancjainil", "name": "ancjainil", "key": "JIRAUSER310849", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Jainil Rana", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-09-01T17:48:09.511+0000", "updated": "2025-09-01T17:48:09.511+0000"}], "maxResults": 1, "total": 1, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/1", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/blocker.svg", "name": "Blocker", "id": "1"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/10002", "description": "A patch for this issue has been uploaded to JIRA by a contributor.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/document.png", "name": "Patch Available", "id": "10002", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/4", "id": 4, "key": "indeterminate", "colorName": "yellow", "name": "In Progress"}}}}