{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13632223", "self": "https://issues.apache.org/jira/rest/api/2/issue/13632223", "key": "SPARK-53982", "fields": {"summary": "Spark aggregation is incorrect (floating point error)", "description": "\u00a0\r\n{code:java}\r\nList<Row> data = Arrays.asList(\r\nRowFactory.create(\"2021-01-01T00:00:00.000+0000\", \"pod123\", 99.95),\r\nRowFactory.create(\"2021-01-01T00:00:00.000+0000\", \"pod123\", 99.95),\r\nRowFactory.create(\"2021-01-01T00:00:00.000+0000\", \"pod123\", 99.95),\r\nRowFactory.create(\"2021-01-01T00:00:00.000+0000\", \"pod123\", 99.95),\r\nRowFactory.create(\"2021-01-01T00:00:00.000+0000\", \"pod123\", 99.95),\r\nRowFactory.create(\"2021-01-01T00:00:00.000+0000\", \"pod123\", 99.95),\r\nRowFactory.create(\"2021-01-01T00:00:00.000+0000\", \"pod123\", 99.95),\r\nRowFactory.create(\"2021-01-01T00:00:00.000+0000\", \"pod123\", 99.95)\r\n);\r\n\u00a0\r\nStructType schema = DataTypes.createStructType(new StructField[] {\r\nDataTypes.createStructField(\"timestamp\", DataTypes.StringType, false),\r\nDataTypes.createStructField(\"id\", DataTypes.StringType, false),\r\nDataTypes.createStructField(\"value\", DataTypes.DoubleType, false)\r\n});\r\n\u00a0\r\nDataset<Row> df = spark.createDataFrame(data, schema);\r\n\u00a0\r\n// Show the input data\r\nSystem.out.println(\"Input data:\");\r\ndf.show();\r\n\u00a0\r\n// Perform the aggregation\r\nDataset<Row> result = df.groupBy(\"id\")\r\n.agg(\r\navg(\"value\").as(METADATA_COL_METRICVALUE),\r\nsum(\"value\").as(METADATA_COL_SUM_VALUE)\r\n);\r\n\u00a0\r\n// Show the results\r\nSystem.out.println(\"Aggregation results:\");\r\nresult.show();\r\n\u00a0\r\n// Collect the results\r\nList<Row> results = result.collectAsList();\r\n\u00a0\r\n// Print the results\r\nSystem.out.println(\"Number of results: \" + results.size());\r\nfor (Row row : results) {\r\nSystem.out.println(\"Metric value: \" + row.getDouble(row.fieldIndex(METADATA_COL_METRICVALUE)));\r\nSystem.out.println(\"Sum value: \" + row.getDouble(row.fieldIndex(METADATA_COL_SUM_VALUE)));\r\n}\r\n\u00a0\r\n// Verify the results\r\nassertEquals(1, results.size(), \"Expected 1 aggregated result\");\r\n\u00a0\r\nRow resultRow = results.get(0);\r\ndoublesumValue = resultRow.getDouble(resultRow.fieldIndex(METADATA_COL_SUM_VALUE));\r\ndoubleexpectedSum = 799.6; // 8 * 99.95\r\n\u00a0\r\nSystem.out.println(\"Expected sum: \" + expectedSum);\r\nSystem.out.println(\"Actual sum: \" + sumValue);\r\nSystem.out.println(\"Difference: \" + Math.abs(expectedSum - sumValue));\r\n\u00a0\r\n// Check if the sum is close to the expected value\r\nassertTrue(Math.abs(expectedSum - sumValue) < 0.001,\r\n\"Sum value should be close to \" + expectedSum + \" but was \" + sumValue);\r\n{code}\r\n\r\n\r\n\r\n{code:java}\r\nInput data:\r\n+--------------------+------+-----+\r\n|           timestamp|    id|value|\r\n+--------------------+------+-----+\r\n|2021-01-01T00:00:...|pod123|99.95|\r\n|2021-01-01T00:00:...|pod123|99.95|\r\n|2021-01-01T00:00:...|pod123|99.95|\r\n|2021-01-01T00:00:...|pod123|99.95|\r\n|2021-01-01T00:00:...|pod123|99.95|\r\n|2021-01-01T00:00:...|pod123|99.95|\r\n|2021-01-01T00:00:...|pod123|99.95|\r\n|2021-01-01T00:00:...|pod123|99.95|\r\n+--------------------+------+-----+\r\n\r\nAggregation results:\r\n+------+-----------------+-----------------+\r\n|    id|     metric_value|        sum_value|\r\n+------+-----------------+-----------------+\r\n|pod123|99.95000000000002|799.6000000000001|\r\n+------+-----------------+-----------------+\r\n\r\nNumber of results: 1\r\nMetric value: 99.95000000000002\r\nSum value: 799.6000000000001\r\nExpected sum: 799.6\r\nActual sum: 799.6000000000001\r\nDifference: 1.1368683772161603E-13{code}", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ianmanning", "name": "ianmanning", "key": "JIRAUSER287942", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"}, "displayName": "Ian Manning", "active": true, "timeZone": "Europe/Dublin"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13632223/comment/18032149", "id": "18032149", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ianmanning", "name": "ianmanning", "key": "JIRAUSER287942", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"}, "displayName": "Ian Manning", "active": true, "timeZone": "Europe/Dublin"}, "body": "This does work with DecimalType - but I am not sure why it should not work with DoubleType given the level of precision of 2 digits.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ianmanning", "name": "ianmanning", "key": "JIRAUSER287942", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34045", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"}, "displayName": "Ian Manning", "active": true, "timeZone": "Europe/Dublin"}, "created": "2025-10-22T15:35:49.689+0000", "updated": "2025-10-22T15:35:49.689+0000"}], "maxResults": 1, "total": 1, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}