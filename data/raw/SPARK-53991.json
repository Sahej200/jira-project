{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13632250", "self": "https://issues.apache.org/jira/rest/api/2/issue/13632250", "key": "SPARK-53991", "fields": {"summary": "Add support for KLL quantiles functions based on DataSketches", "description": "Documentation reference: [https://datasketches.apache.org/docs/KLL/KLLSketch.html].\r\n\r\nDataSketches code API reference: [https://apache.github.io/datasketches-java/6.1.0/org/apache/datasketches/kll/KllLongsSketch.html]\u00a0\r\n\r\nReference PR for recently adding Theta sketches: [https://github.com/apache/spark/pull/51298]", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dtenedor", "name": "dtenedor", "key": "JIRAUSER285772", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER285772&avatarId=49526", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER285772&avatarId=49526", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER285772&avatarId=49526", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER285772&avatarId=49526"}, "displayName": "Daniel Tenedorio", "active": true, "timeZone": "America/Los_Angeles"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13632250/comment/18032269", "id": "18032269", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dtenedor", "name": "dtenedor", "key": "JIRAUSER285772", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER285772&avatarId=49526", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER285772&avatarId=49526", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER285772&avatarId=49526", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER285772&avatarId=49526"}, "displayName": "Daniel Tenedorio", "active": true, "timeZone": "America/Los_Angeles"}, "body": "We can use the following function names. For each category, we can support long integer, single-precision floating-point, and double-precision floating-point variants (it is necessary to specify which one we are using since the representation of the sketch buffers is different for different input value data types).\r\n\r\n\u00a0\r\n\r\nAggregate functions to consume input values and return a sketch buffer:\r\n\r\n{{kll_sketch_agg_bigint(col)}}\r\n\r\n{{kll_sketch_agg_float(col)}}\r\n\r\n{{kll_sketch_agg_double(col)}}\r\n\r\n\u00a0\r\n\r\nScalar functions to merge two sketch buffers together into another sketch buffer:\r\n\r\n{{kll_sketch_merge_bigint(sketch1, sketch2)}}\r\n\r\n{{kll_sketch_merge_float(sketch1, sketch2)}}\r\n\r\n{{kll_sketch_merge_double(sketch1, sketch2)}}\r\n\r\n\u00a0\r\n\r\nScalar functions to extract a single value from the quantiles sketch representing the desired quantile given the input rank (for example, \"float median = sketch.getQuantile(0.5)\"). We can also implement the functions in this category to also support accepting an array of input ranks and return an array of result quantiles.\r\n\r\n{{kll_sketch_get_quantile_bigint(sketch, rank)}}\r\n\r\n{{kll_sketch_get_quantile_float(sketch, rank)}}\r\n\r\n{{kll_sketch_get_quantile_double(sketch, rank)}}\r\n\r\n\u00a0\r\n\r\nScalar functions to extract a single value from the quantiles sketch representing the desired rank given the input quantile (for example, \"double rankOf1000 = sketch.getRank(1000)\"). We can also implement the functions in this category to also support accepting an array of input quantiles and return an array of result ranks.\r\n\r\n{{kll_sketch_get_rank_bigint(sketch, quantile)}}\r\n\r\n{{kll_sketch_get_rank_float(sketch, quantile)}}\r\n\r\n{{kll_sketch_get_rank_double(sketch, quantile)}}\r\n\r\n\u00a0\r\n\r\nOptional, scalar functions to return a string representation of a sketch buffer:\r\n\r\n{{kll_sketch_to_string_bigint(sketch)}}\r\n\r\n{{kll_sketch_to_string_float(sketch)}}\r\n\r\n{{kll_sketch_to_string_double(sketch)}}", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dtenedor", "name": "dtenedor", "key": "JIRAUSER285772", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER285772&avatarId=49526", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER285772&avatarId=49526", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER285772&avatarId=49526", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER285772&avatarId=49526"}, "displayName": "Daniel Tenedorio", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-22T21:55:04.517+0000", "updated": "2025-10-22T21:59:16.078+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632250/comment/18034249", "id": "18034249", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dtenedor", "name": "dtenedor", "key": "JIRAUSER285772", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER285772&avatarId=49526", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER285772&avatarId=49526", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER285772&avatarId=49526", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER285772&avatarId=49526"}, "displayName": "Daniel Tenedorio", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Here is a pull request to implement the functionality: [https://github.com/apache/spark/pull/52800|https://github.com/apache/spark/pull/52800]", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=dtenedor", "name": "dtenedor", "key": "JIRAUSER285772", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=JIRAUSER285772&avatarId=49526", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=JIRAUSER285772&avatarId=49526", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=JIRAUSER285772&avatarId=49526", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=JIRAUSER285772&avatarId=49526"}, "displayName": "Daniel Tenedorio", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-30T19:49:23.213+0000", "updated": "2025-10-30T20:03:05.149+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/3", "description": "This issue is being actively worked on at the moment by the assignee.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/inprogress.png", "name": "In Progress", "id": "3", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/4", "id": 4, "key": "indeterminate", "colorName": "yellow", "name": "In Progress"}}}}