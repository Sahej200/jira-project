{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13625785", "self": "https://issues.apache.org/jira/rest/api/2/issue/13625785", "key": "KAFKA-19586", "fields": {"summary": "Kafka broker freezes and gets fenced during rolling restart with KRaft mode", "description": "After upgrading our Kafka clusters to *Kafka 3.9.0* with *KRaft mode enabled* in production, we started observing strange behavior during rolling restarts of broker nodes \u2014 behavior we had never seen before.\r\n\r\nWhen a broker is {*}gracefully shut down by the KRaft controller{*}, it immediately restarts. Shortly afterward, while it is busy {*}replicating missing data{*}, the broker suddenly {*}freezes for approximately 20\u201350 seconds{*}. During this time, it produces {*}no logs, no metrics{*}, and *no heartbeat messages* to the controllers (see the timestamps below).\r\n\r\n\u00a0\r\n{code:java}\r\n2025-07-30 09:21:27,224 INFO [Broker id=8] Skipped the become-follower state change for my-topic-215 with topic id Some(yO4CQayIRbyESrHHVPdOrQ) and partition state LeaderAndIsrPartitionState(topicName='my-topic', partitionIndex=215, controllerEpoch=-1, leader=4, leaderEpoch=54, isr=[4, 8], partitionEpoch=102, replicas=[4, 8], addingReplicas=[], removingReplicas=[], isNew=false, leaderRecoveryState=0) since it is already a follower with leader epoch 54. (state.change.logger) [kafka-8-metadata-loader-event-handler]\r\n\r\n2025-07-30 09:21:51,887 INFO [Broker id=8] Transitioning 427 partition(s) to local followers. (state.change.logger) [kafka-8-metadata-loader-event-handler] \u00a0 \u00a0  \u00a0{code}\r\n\u00a0\r\n\r\nAfter this \u201changing\u201d period, the broker *resumes normal operation* without emitting any error or warning messages \u2014 as if nothing happened. However, during this gap, because the broker fails to send heartbeats to the KRaft controllers, it gets *fenced out of the cluster* ([9s timeout|https://kafka.apache.org/documentation/#brokerconfigs_broker.session.timeout.ms]), which leads to {*}partitions going offline and, ultimately, data loss{*}.\r\n{code:java}\r\n2025-07-30 09:21:40,325 INFO [QuorumController id=300] Fencing broker 8 because its session has timed out. (org.apache.kafka.controller.ReplicationControlManager) [quorum-controller-300-event-handler]{code}\r\n\u00a0\r\n\r\nWe were able to re-produce this behaviour when provisioning clusters with high disk utilization.\u00a0\r\n\r\nOur primary suspicion is that the Kafka broker process might be *\u201cchoking\u201d under the load* \u2014 trying to replicate a large amount of data while also taking over leadership for many partitions. This may cause the JVM to stall, leading to the observed freeze.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=talasulin", "name": "talasulin", "key": "JIRAUSER310397", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Tal Asulin", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13625785/comment/18013993", "id": "18013993", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=talasulin", "name": "talasulin", "key": "JIRAUSER310397", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Tal Asulin", "active": true, "timeZone": "Etc/UTC"}, "body": "Sharing a 5m Flame graph profiling snapshot that was taken after a broker restart that experienced this exact issue - [^flame3.html].\r\n\r\nThe Kafka cluster spec during the simulation was:\r\n * 12 Broker nodes\r\n * Using 8 vCPUs, 32G of RAM & 3.7TB local volume (im4gn.2xlarge AWS instances)\r\n * Disk utilization reached 60% during the simulation\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=talasulin", "name": "talasulin", "key": "JIRAUSER310397", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Tal Asulin", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-14T19:58:05.227+0000", "updated": "2025-08-14T20:02:12.595+0000"}], "maxResults": 1, "total": 1, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/1", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/blocker.svg", "name": "Blocker", "id": "1"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}