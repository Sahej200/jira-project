{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13631476", "self": "https://issues.apache.org/jira/rest/api/2/issue/13631476", "key": "KAFKA-19788", "fields": {"summary": "kafka server ClusterAuthorization don't support acks=-1 for kafka-client version>3.1.0", "description": "* \u00a0kafka server version is 2.5.1\r\n * \u00a0kafka-client version bigger than 3.1.1\u00a0\r\n\r\n\u00a0\r\n{code:java}\r\nimport org.apache.kafka.clients.producer.KafkaProducer;\r\nimport org.apache.kafka.clients.producer.Producer;\r\nimport org.apache.kafka.clients.producer.ProducerRecord;\r\n\r\nimport java.util.Properties;\r\n\r\n\r\npublic class KafkaSendTest {\r\n\r\n  public static void main(String[] args) {\r\n    Properties props = new Properties();\r\n    props.put(\"bootstrap.servers\", \"xxx:9092,xxxx:9092\");\r\n    props.put(\"key.serializer\", \"org.apache.kafka.common.serialization.ByteArraySerializer\");\r\n    props.put(\"value.serializer\", \"org.apache.kafka.common.serialization.ByteArraySerializer\");\r\n    props.put(\"transaction.timeout.ms\", \"300000\");\r\n    props.put(\"acks\", \"-1\"); // If acks=1 or acks=0 it will send successfully\r\n    props.put(\"compression.type\", \"lz4\");\r\n    props.put(\"security.protocol\", \"SASL_PLAINTEXT\");\r\n    props.put(\"sasl.mechanism\", \"SCRAM-SHA-256\");\r\n    props.put(\"sasl.jaas.config\", \"org.apache.kafka.common.security.scram.ScramLoginModule required username=\\\"xxx\\\" password=\\\"xxxx\\\";\");\r\n\r\n    Producer<byte[], byte[]> producer = new KafkaProducer<>(props);\r\n\r\n    try {\r\n      String topic = \"topic1\";\r\n      byte[] value = new byte[]{1,2}; // example\r\n      ProducerRecord<byte[], byte[]> record = new ProducerRecord<>(topic, null, value);\r\n      producer.send(record, (metadata, exception) -> {\r\n        if (exception == null) {\r\n          System.out.printf(\"Sent record(key=%s value=%s) meta(partition=%d, offset=%d)\\n\",\r\n                  record.key(), new String(record.value()), metadata.partition(), metadata.offset());\r\n        } else {\r\n          exception.printStackTrace();\r\n        }\r\n      });\r\n      producer.close();\r\n    } catch (Exception e) {\r\n      e.printStackTrace();\r\n    }\r\n  }\r\n} {code}\r\npom.xml config\r\n{code:java}\r\n<dependency>\r\n  <groupId>org.apache.kafka</groupId>\r\n  <artifactId>kafka-clients</artifactId>\r\n  <version>3.4.0</version>\r\n</dependency> {code}\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0When kafka producer acks=-1, It will throw exception.\r\n\r\n\u00a0\r\n{code:java}\r\norg.apache.kafka.common.KafkaException: Cannot execute transactional method because we are in an error state\tat org.apache.kafka.clients.producer.internals.TransactionManager.maybeFailWithError(TransactionManager.java:1010)\tat org.apache.kafka.clients.producer.internals.TransactionManager.maybeAddPartition(TransactionManager.java:328)\tat org.apache.kafka.clients.producer.KafkaProducer.doSend(KafkaProducer.java:1061)\tat org.apache.kafka.clients.producer.KafkaProducer.send(KafkaProducer.java:962)\tat com.mvad.realtime.show.converter.DataEntryToRTLogConverterTest.main(DataEntryToRTLogConverterTest.java:34)Caused by: org.apache.kafka.common.errors.ClusterAuthorizationException: Cluster authorization failed. {code}\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 If acks=1 or acks=0 it will send successfully\r\n{code:java}\r\nSent record(key=null ) meta(partition=6, offset=321496) {code}\r\n\u00a0 \u00a0 acks=-1 is just a param, How it effects ClusterAuthorization of kafka producer.\r\n\u00a0 \u00a0 Is this a bug or a mechanism in itself?\r\n\r\n\u00a0\r\n\r\nIf change kafka-client verison to 3.1.0. When kafka producer acks=-1, It will send successfully\r\n{code:java}\r\n<dependency>\r\n  <groupId>org.apache.kafka</groupId>\r\n  <artifactId>kafka-clients</artifactId>\r\n  <version>3.1.0</version>\r\n</dependency> {code}\r\n\u00a0", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=zhumingustc", "name": "zhumingustc", "key": "JIRAUSER303290", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34043", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34043", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34043", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34043"}, "displayName": "zhuming", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13631476/comment/18029730", "id": "18029730", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=naveenthuvana", "name": "naveenthuvana", "key": "JIRAUSER311196", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34050", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"}, "displayName": "Naveen", "active": true, "timeZone": "Etc/UTC"}, "body": "Hi\u00a0[~zhumingustc] I tried to replicate this with acks: -1. I am able to send the record, could you share your server setup?\r\n\r\n\u00a0\r\n{code:java}\r\n14:28:31.273 [main] INFO org.apache.kafka.clients.producer.KafkaProducer -- [Producer clientId=producer-1] Closing the Kafka producer with timeoutMillis = 9223372036854775807 ms.\r\nSent record(key=null ){code}", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=naveenthuvana", "name": "naveenthuvana", "key": "JIRAUSER311196", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34050", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"}, "displayName": "Naveen", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-14T09:40:30.942+0000", "updated": "2025-10-14T09:40:30.942+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631476/comment/18029980", "id": "18029980", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=zhumingustc", "name": "zhumingustc", "key": "JIRAUSER303290", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34043", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34043", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34043", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34043"}, "displayName": "zhuming", "active": true, "timeZone": "Etc/UTC"}, "body": "Thanks. I find the reason of this \u00a0ClusterAuthorizationException. It\u00a0 involves the config of idempotence.\r\n\r\nhttps://issues.apache.org/jira/browse/KAFKA-13673\u00a0 \u00a0\r\n\r\nIn this kafka-client 3.1.1 issue \u00a0{color:#de350b}b. enable.idempotence unset && acks=all => enable idempotence .{color}\r\n\r\nSo Idempotence is set to true based on the producer properties\u00a0 However, the Kafka server has not enabled the idempotence right for admin. Finally it throws such ClusterAuthorizationException.\r\n\r\nAfter following command executed in kafka server.\u00a0 Producer can send record\u00a0 successfully with acks: -1\u00a0\r\n\r\n\u00a0\r\n{code:java}\r\nsh kafka-acls.sh --authorizer-properties \u00a0zookeeper.connect=xxxx:2191/xxx --add --allow-principal User:admin --allow-host \"*\" --operation IdempotentWrite --cluster {code}\r\n\u00a0\r\n\r\n\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=zhumingustc", "name": "zhumingustc", "key": "JIRAUSER303290", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34043", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34043", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34043", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34043"}, "displayName": "zhuming", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-15T06:43:26.014+0000", "updated": "2025-10-15T06:44:37.842+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/5", "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png", "name": "Resolved", "id": "5", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}}}