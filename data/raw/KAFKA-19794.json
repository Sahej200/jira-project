{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13631669", "self": "https://issues.apache.org/jira/rest/api/2/issue/13631669", "key": "KAFKA-19794", "fields": {"summary": "MirrorCheckpointTask causes consumers on target cluster to rewind offsets or skip messages due to erroneous offset commits", "description": "h2. *Description*\r\n\r\nThe MirrorCheckpointTask in Mirror Maker 2 commits offsets for active consumer groups on the target cluster, causing consumers to rewind their offsets or skip messages. Typically brokers prevent committing offsets for consumer groups that are not in `EMPTY` state by throwing {{{}UnknownMemberIdException{}}}. In addition, {{MirrorCheckpointTask}} has logic in place to prevent committing offsets older than target for {{EMPTY}} consumer groups. However, due to a bug in {{MirrorCheckpointTask}} code, this prevention check is not enforced and it attempts to commit offsets for {{STABLE}} consumers. These calls can go through if consumers were momentarily disconnected moving the group state to {{{}EMPTY{}}}. This results in consumers' offsets getting reset to older values. If the offset is not available on the target broker (due to retention), the consumers can get reset to \"{{{}earliest\"{}}} or \"{{{}latest\"{}}}, thus reading duplicates or skipping messages.\u00a0\r\nh2. *Bug location*\r\n\r\n1. In [MirrorCheckpointTask|#L305], we only update the latest target cluster offsets ({{{}idleConsumerGroupsOffset{}}})\u00a0 if target consumer group state is {{{}EMPTY{}}}.\r\n\r\n2. When {{syncGroupOffset}} is called, we check if the target consumer group is present in\u00a0\u00a0\r\n\r\n{{{}idleConsumerGroupsOffset{}}}. The consumer group won't be present as it's an active group. We assume that this is a new group and start syncing consumer group offsets to target. These calls fail with {_}{{{{{}Unable to sync offsets for consumer group XYZ. This is likely caused by consumers currently using this group in the target cluster. (org.apache.kafka.connect.mirror.MirrorCheckpointTask{}}}}}{_}. When consumers have failed over, the logs typically contain a lot of these messages. These calls can succeed if consumer is momentarily disconnected due to restarts. The code should not assume the lack of consumer group in {{idleConsumerGroupsOffset}} map as a new consumer group.\r\n\r\n3. These erroneous behavior can also be triggered calls to {{describeConsumerGroups}} or {{listConsumerGroupOffsets}} fail in {{refreshIdleConsumerGroupOffset}} method due to transient timeouts.\r\nh2. *Fix*\r\n\r\nPotential fix would be to add an explicit check to only sync offsets for EMPTY consumer group. We should also skip offset syncing for consumer groups for which we couldn't refresh the offsets.\u00a0\r\n\r\n\u00a0\r\n{code:java}\r\n// Fixed code adds state checking:\r\nConsumerGroupState groupStateOnTarget = targetConsumerGroupStates.get(consumerGroupId);\r\nif (!isGroupPresentOnTarget || groupStateOnTarget == ConsumerGroupState.DEAD)\r\n{ \u00a0 \u00a0 // Safe to sync - new or dead group \u00a0 \u00a0 syncGroupOffset(consumerGroupId, convertedUpstreamOffset); }\r\nelse if (groupStateOnTarget == ConsumerGroupState.EMPTY)\r\n{ \u00a0 \u00a0 // Safe to sync - idle group \u00a0 \u00a0 // ... existing offset comparison logic }\r\nelse {\r\n\u00a0 \u00a0 // Skip active groups (STABLE, PREPARING_REBALANCE, COMPLETING_REBALANCE)\r\n\u00a0 \u00a0 log.info(\"Consumer group: {} with state: {} is being actively consumed on the target, skipping sync.\",\r\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0consumerGroupId, groupStateOnTarget);\r\n}\r\n{code}\r\n\u00a0\r\n\r\n\u00a0", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=blacktooth", "name": "blacktooth", "key": "blacktooth", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=blacktooth&avatarId=44862", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=blacktooth&avatarId=44862", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=blacktooth&avatarId=44862", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=blacktooth&avatarId=44862"}, "displayName": "Ravindranath Kakarla", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}