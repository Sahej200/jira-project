{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13632285", "self": "https://issues.apache.org/jira/rest/api/2/issue/13632285", "key": "SPARK-54000", "fields": {"summary": "Complex sql with expand operator and code gen enabled, very slow", "description": "Complex sql with expand operator and code gen enabled, very slow\r\n\r\nsql format like select keya,keyb,count(distinct case when),...,count(distinct case when),sum(a),sum(b) from x group by keya,keyb\r\n\r\nwhen disable whole stage code gen, run will speed up 20x times\r\n\r\nwhen add executor jvm parameter -XX:-TieredCompilation, run will speed up 20x times\r\n\r\nreduce select column count, such as 28 -> 27, can speed up 10x times", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lifulong", "name": "lifulong", "key": "lifulong", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "lifulong", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13632285/comment/18032413", "id": "18032413", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lifulong", "name": "lifulong", "key": "lifulong", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "lifulong", "active": true, "timeZone": "Etc/UTC"}, "body": "!https://wiki.in.zhihu.com/download/attachments/640447372/image2025-10-2_13-32-26.png?version=1&modificationDate=1759383146774&api=v2!\r\n\r\nfrom flame graph we can see, most time cost is setNullAt call when enable whole stage code gen and not add -XX:-TieredCompilation jvm parameter", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=lifulong", "name": "lifulong", "key": "lifulong", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "lifulong", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-23T08:47:50.193+0000", "updated": "2025-10-23T08:51:49.455+0000"}], "maxResults": 1, "total": 1, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}