{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13632263", "self": "https://issues.apache.org/jira/rest/api/2/issue/13632263", "key": "KAFKA-19828", "fields": {"summary": "Intermittent test failures when using chained emit strategy on window close", "description": "Hi,\r\n\r\nI have a test case that contains a topology with 2 time windows and chained emitStrategy calls. The standalone reproduction use case is attached to this issue\r\nThe problem is that about 25% of the time the test fails. About 75% of the time the test succeeds. I followed the conclusions of\u00a0\r\n!https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype|width=16,height=16! KAFKA-19810\r\nto make sure that I am sending events at the correct times (at least I think my calculations are correct). I really need to get to the bottom of why the test fails intermittently, as the test somewhat reflects a real life topology of a project I am working on, and we cannot have an intermittently failing test in our build pipeline.\u00a0\r\nGreg\r\n\u00a0", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13632263/comment/18032321", "id": "18032321", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Most of the time I run the test, I see this:\r\n[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.880 s \u2013 in com.k8sflowprocessor.ChainedEmitStrategyTopologyTest3\r\n[INFO]\u00a0\r\n[INFO] Results:\r\n[INFO]\u00a0\r\n[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0\r\n[INFO]\u00a0\r\n\r\nHowever, like I mentioned, every once in a while I see this:\r\n\r\n[ERROR] Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 1.058 s <<< FAILURE! \u2013 in com.k8sflowprocessor.ChainedEmitStrategyTopologyTest3\r\n[ERROR] com.k8sflowprocessor.ChainedEmitStrategyTopologyTest3.testChainedWindowedAggregationsWithDifferentGracePeriods \u2013 Time elapsed: 1.049 s <<< FAILURE!\r\njava.lang.AssertionError: expected:<1> but was:<0>\r\n\u00a0 \u00a0 at org.junit.Assert.fail(Assert.java:89)\r\n\u00a0 \u00a0 at org.junit.Assert.failNotEquals(Assert.java:835)\r\n\u00a0 \u00a0 at org.junit.Assert.assertEquals(Assert.java:647)\r\n\u00a0 \u00a0 at org.junit.Assert.assertEquals(Assert.java:633)\r\n\u00a0 \u00a0 at com.k8sflowprocessor.ChainedEmitStrategyTopologyTest3.testChainedWindowedAggregationsWithDifferentGracePeriods(ChainedEmitStrategyTopologyTest3.java:116)\r\n\r\nWhat that means, most of the time a record passes from input to output topic in the time expected, but every once in a while it does not.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-23T01:00:21.304+0000", "updated": "2025-10-23T01:02:50.669+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632263/comment/18032322", "id": "18032322", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "body": "the goal, of course, is to have unit test that is reliable, i.e. doesn't fail intermittently. I need to understand whether the issue is in my test code (attached) or elsewhere in kafka test framework.\u00a0", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-23T01:01:56.167+0000", "updated": "2025-10-23T01:01:56.167+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632263/comment/18032324", "id": "18032324", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "body": "I run the test in a loop in a shell script like this:\r\n\r\n#!/bin/bash\r\nset -e\r\n\r\nfor i in \\{1..100}; do\r\n\u00a0 echo ========================================================\r\n\u00a0 echo ======================== $i ============================\r\n\u00a0 echo ========================================================\r\n\u00a0 mvn surefire:test -Dtest=ChainedEmitStrategyTopologyTest3\r\ndone\r\n\r\nI am attaching output of one such run, where first 5 iterations succeeded, but the 6th one failed", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-23T01:16:48.842+0000", "updated": "2025-10-23T01:16:48.842+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632263/comment/18032580", "id": "18032580", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "body": "@[~mjsax] ^^^^", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-23T19:42:00.664+0000", "updated": "2025-10-23T19:42:00.664+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632263/comment/18032959", "id": "18032959", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "body": "I am not sure \u2013 did spend some time but don't understand yet what's happening. It could be a bug in Kafka Streams. Needs more investigation.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=mjsax", "name": "mjsax", "key": "mjsax", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mjsax&avatarId=29314", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mjsax&avatarId=29314", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mjsax&avatarId=29314", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mjsax&avatarId=29314"}, "displayName": "Matthias J. Sax", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-25T23:36:11.615+0000", "updated": "2025-10-25T23:36:11.615+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632263/comment/18032960", "id": "18032960", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Thanks. Good you were able to reproduce it. I've been banging my head at it for a week now. Keep me posted. Thanks", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-25T23:40:43.435+0000", "updated": "2025-10-25T23:40:43.435+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632263/comment/18033980", "id": "18033980", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=nikita-shupletsov", "name": "nikita-shupletsov", "key": "JIRAUSER306158", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Nikita Shupletsov", "active": true, "timeZone": "America/Vancouver"}, "body": "Looks like it's because you use real time in the test.\r\n\r\nif you replace it with something like {{Instant flowTime = Instant.ofEpochMilli(0);, }}it should fix it", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=nikita-shupletsov", "name": "nikita-shupletsov", "key": "JIRAUSER306158", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Nikita Shupletsov", "active": true, "timeZone": "America/Vancouver"}, "created": "2025-10-29T23:23:15.368+0000", "updated": "2025-10-29T23:23:27.859+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13632263/comment/18033986", "id": "18033986", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "body": "Could you please elaborate why using the real time in the test is a problem as opposed to what you are suggesting.\r\nThanks.\r\n\r\nI have two windows - one 30 secs, another one 1 hr, 10 min grace\r\n\r\nI thought by starting my flows 3 hours behind the current real time and sending flows every few seconds I would be ok. Why does my strategy not work?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=bayareagreg", "name": "bayareagreg", "key": "JIRAUSER311223", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg F", "active": true, "timeZone": "America/Los_Angeles"}, "created": "2025-10-30T00:11:21.348+0000", "updated": "2025-10-30T00:11:21.348+0000"}], "maxResults": 8, "total": 8, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}