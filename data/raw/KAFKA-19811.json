{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13631917", "self": "https://issues.apache.org/jira/rest/api/2/issue/13631917", "key": "KAFKA-19811", "fields": {"summary": "Acked record on new topic not immediately visible to consumer", "description": "h2. Steps to reproduce\r\n * program uses a single broker (we see the issue with an in-JVM embedded kafka server)\r\n * create a new topic with 1 partition\r\n * produce a record with {{acks=all}}\r\n * await acknowledgement from the broker\r\n * start a consumer (configured to read from beginning of topic)\r\n * spuriously, _the consumer never sees the record_\r\n\r\nThe problem seems to occur more on a very busy server (e.g. a build server running many tests in parallel). We have not seen it on a modern laptop.\r\n\r\nA delay of 10ms after receiving the acknowledgement, and before starting the consumer, makes the record always visible.\r\n\r\nWe observe this problem in ~1 in 6 runs of [zio-kafka|https://github.com/zio/zio-kafka]'s test suite, when run from a GitHub action. Since we run the test-suite for 3 different JVM versions, more than half of the zio-kafka builds fails due to this issue.\r\nh2. Expected behavior\r\n\r\nA record, produced with {{{}acks=all{}}}, of which producing was acknowledged, should be immediately visible for all consumers.\r\n\r\n\u00a0", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13631917/comment/18030966", "id": "18030966", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "body": "Addition: when the consumer misses the just produced record, it will also not see any record produced thereafter either (I didn't wait until a rebalance happened).", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-10-19T15:39:42.424+0000", "updated": "2025-10-19T15:40:48.195+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631917/comment/18031097", "id": "18031097", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=schofielaj", "name": "schofielaj", "key": "schofielaj", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Andrew Schofield", "active": true, "timeZone": "Etc/UTC"}, "body": "[~erikvanoosten] Can you provide the code for the consumer application? I am pretty confident that the problem as described in the issue would have been caught by automated tests. I wonder whether the consuming application design is making this occur.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=schofielaj", "name": "schofielaj", "key": "schofielaj", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Andrew Schofield", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-20T09:08:36.434+0000", "updated": "2025-10-20T09:08:36.434+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631917/comment/18031103", "id": "18031103", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "body": "Yes! The problem happens in the unit test of the open source zio-kafka library. Here are some pointer to tests that sometimes fail to consume any record (they time-out after 2 minutes):\r\n * [https://github.com/zio/zio-kafka/blob/7a97a9a197223dcdc5841c6313ebb486f55cc816/zio-kafka-test/src/test/scala/zio/kafka/consumer/SubscriptionsSpec.scala#L22-L54]\r\n * [https://github.com/zio/zio-kafka/blob/7a97a9a197223dcdc5841c6313ebb486f55cc816/zio-kafka-test/src/test/scala/zio/kafka/consumer/ConsumerSpec.scala#L170-L203]\r\n * [https://github.com/zio/zio-kafka/blob/7a97a9a197223dcdc5841c6313ebb486f55cc816/zio-kafka-test/src/test/scala/zio/kafka/consumer/ConsumerSpec.scala#L250-L289]\r\n\r\n(there are a few more)\r\n\r\nThese test have in common that they follow the steps described in this issue.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-10-20T09:34:21.916+0000", "updated": "2025-10-20T09:34:21.916+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631917/comment/18031109", "id": "18031109", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "body": "Please let me know if you need help interpreting the code.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-10-20T09:42:03.906+0000", "updated": "2025-10-20T09:42:03.906+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631917/comment/18031159", "id": "18031159", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=schofielaj", "name": "schofielaj", "key": "schofielaj", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Andrew Schofield", "active": true, "timeZone": "Etc/UTC"}, "body": "I've had a quick look at the code, but I must admit that I'm a bit of a Scala amateur.\r\n\r\nI suggest using a ConsumerRebalanceListener to ensure that your test has been assigned partitions to consume. Given the symptom about a test failing to receive the first record fails to receive any of them, it sounds like its not been assigned the partition to subscribe from. If this has occurred since the move to Apache Kafka 4.x, it may be related to the difference in behaviour of the `poll(long)` method which was removed and its replacement with `poll(Duration)`.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=schofielaj", "name": "schofielaj", "key": "schofielaj", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Andrew Schofield", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-10-20T13:58:36.361+0000", "updated": "2025-10-20T13:58:36.361+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631917/comment/18031197", "id": "18031197", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "body": "The problem has been around for some time (before 4.x) although anecdotally it did start to occur more in this year.\r\n\r\nI will add some debug logging that triggers when no partitions were assigned.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-10-20T16:02:46.705+0000", "updated": "2025-10-20T16:02:46.705+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631917/comment/18032442", "id": "18032442", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "body": "We just had a consumer lockup, where even the 10ms delay after producing was not enough.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-10-23T10:35:05.556+0000", "updated": "2025-10-23T10:35:05.556+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13631917/comment/18032475", "id": "18032475", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "body": "[~schofielaj] Under what circumstances could no partition be assigned, even though there is only one broker and one consumer?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=erikvanoosten", "name": "erikvanoosten", "key": "erikvanoosten", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Erik van Oosten", "active": true, "timeZone": "Europe/Berlin"}, "created": "2025-10-23T13:05:28.181+0000", "updated": "2025-10-23T13:05:53.011+0000"}], "maxResults": 8, "total": 8, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/4", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/minor.svg", "name": "Minor", "id": "4"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}