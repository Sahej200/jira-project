{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13626101", "self": "https://issues.apache.org/jira/rest/api/2/issue/13626101", "key": "KAFKA-19596", "fields": {"summary": "Log auto topic creation failures more visibly", "description": "Hi, I was playing with Share groups on the 4.1.0-rc2 and found it a little opaque to detect a failure to auto create the `__share_group_state` topic due to the replication factor not being satisfiable.\r\n\r\nI start up a cluster like this (taken from the dockerhub instructions):\r\n{code:java}\r\npodman run --rm \\\r\n\u00a0 -p 9092:9092 \\\r\n\u00a0 -e KAFKA_NODE_ID=1 \\\r\n\u00a0 -e KAFKA_PROCESS_ROLES=broker,controller \\\r\n\u00a0 -e KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093 \\\r\n\u00a0 -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 \\\r\n\u00a0 -e KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER \\\r\n\u00a0 -e KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT \\\r\n\u00a0 -e KAFKA_CONTROLLER_QUORUM_VOTERS=1@localhost:9093 \\\r\n\u00a0 -e KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \\\r\n\u00a0 -e KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1 \\\r\n\u00a0 -e KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1 \\\r\n\u00a0 -e KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0 \\\r\n\u00a0 -e KAFKA_NUM_PARTITIONS=3 \\\r\n\u00a0 apache/kafka:4.1.0-rc2{code}\r\nand then run the commands:\r\n{code:java}\r\nrobeyoun:kafka_2.13-4.1.0$ bin/kafka-features.sh --bootstrap-server localhost:9092 upgrade --feature share.version=1\r\nshare.version was upgraded to 1.\r\nrobeyoun:kafka_2.13-4.1.0$ bin/kafka-topics.sh --create --topic my_topic --bootstrap-server localhost:9092\r\nWARNING: Due to limitations in metric names, topics with a period ('.') or underscore ('_') could collide. To avoid issues it is best to use either, but not both.\r\nCreated topic my_topic.\r\nrobeyoun:kafka_2.13-4.1.0$ bin/kafka-console-share-consumer.sh --bootstrap-server localhost:9092 --topic quickstart-events\r\n[2025-08-12 09:50:13,130] WARN Share groups and KafkaShareConsumer are part of a preview feature introduced by KIP-932, and are not recommended for use in production. (org.apache.kafka.clients.consumer.internals.ShareConsumerDelegateCreator)\r\n[2025-08-12 09:50:13,357] WARN [ShareConsumer clientId=console-share-consumer, groupId=console-share-consumer] The metadata response from the cluster reported a recoverable issue with correlation id 20 : {quickstart-events=UNKNOWN_TOPIC_OR_PARTITION} (org.apache.kafka.clients.NetworkClient)\r\n{code}\r\nthe consumer now sits there, appearing to be consuming happily, but the broker is emitting a stream of logs like:\r\n{code:java}\r\n[2025-08-11 21:51:03,648] INFO Sent auto-creation request for Set(__share_group_state) to the active controller. (kafka.server.DefaultAutoTopicCreationManager)\r\n[2025-08-11 21:51:03,648] WARN Received retriable error in find coordinator for InitializeStateHandler using key SharePartitionKey{groupId=console-share-consumer, topicIdPartition=sI9vYBBGSKW_3BfG9ZJWhg:null-1}: The coordinator is not available. (org.apache.kafka.server.share.persister.PersisterStateManager$InitializeStateHandler){code}\r\nSo there's a clue there that it's repeatedly trying to auto-create the topic.\r\n\r\nthe underlying problem is the default replication factor of 3 for the __share_group_state topic, but I have to crank up the log level to DEBUG (setting -e KAFKA_LOG4J_LOGGERS=\"kafka=DEBUG\") to see the cause:\r\n{code:java}\r\n[2025-08-11 21:53:58,343] INFO Sent auto-creation request for Set(__share_group_state) to the active controller. (kafka.server.DefaultAutoTopicCreationManager)\r\n[2025-08-11 21:53:58,343] WARN Received retriable error in find coordinator for InitializeStateHandler using key SharePartitionKey{groupId=console-share-consumer, topicIdPartition=8kjLkvNzSCy7geIIriJVCQ:null-2}: The coordinator is not available. (org.apache.kafka.server.share.persister.PersisterStateManager$InitializeStateHandler)\r\n[2025-08-11 21:53:58,345] DEBUG [broker-1-to-controller-forwarding-channel-manager]: Request CreateTopicsRequestData(topics=[CreatableTopic(name='__share_group_state', numPartitions=50, replicationFactor=3, assignments=[], configs=[CreatableTopicConfig(name='compression.type', value='producer'), CreatableTopicConfig(name='cleanup.policy', value='delete'), CreatableTopicConfig(name='min.insync.replicas', value='2'), CreatableTopicConfig(name='segment.bytes', value='104857600'), CreatableTopicConfig(name='retention.ms', value='-1')])], timeoutMs=30000, validateOnly=false) received ClientResponse(receivedTimeMs=1754949238345, latencyMs=2, disconnected=false, timedOut=false, requestHeader=RequestHeader(apiKey=CREATE_TOPICS, apiVersion=7, clientId=1, correlationId=22, headerVersion=2), responseBody=CreateTopicsResponseData(throttleTimeMs=0, topics=[CreatableTopicResult(name='__share_group_state', topicId=AAAAAAAAAAAAAAAAAAAAAA, errorCode=38, errorMessage='Unable to replicate the partition 3 time(s): The target replication factor of 3 cannot be reached because only 1 broker(s) are registered.', topicConfigErrorCode=0, numPartitions=-1, replicationFactor=-1, configs=[])])) (kafka.server.NodeToControllerRequestThread)\r\n[2025-08-11 21:53:58,345] DEBUG Cleared inflight topic creation state for HashMap(__share_group_state -> CreatableTopic(name='__share_group_state', numPartitions=50, replicationFactor=3, assignments=[], configs=[CreatableTopicConfig(name='compression.type', value='producer'), CreatableTopicConfig(name='cleanup.policy', value='delete'), CreatableTopicConfig(name='min.insync.replicas', value='2'), CreatableTopicConfig(name='segment.bytes', value='104857600'), CreatableTopicConfig(name='retention.ms', value='-1')])) (kafka.server.DefaultAutoTopicCreationManager)\r\n[2025-08-11 21:53:58,345] DEBUG Auto topic creation completed for Set(__share_group_state) with response CreateTopicsResponseData(throttleTimeMs=0, topics=[CreatableTopicResult(name='__share_group_state', topicId=AAAAAAAAAAAAAAAAAAAAAA, errorCode=38, errorMessage='Unable to replicate the partition 3 time(s): The target replication factor of 3 cannot be reached because only 1 broker(s) are registered.', topicConfigErrorCode=0, numPartitions=-1, replicationFactor=-1, configs=[])]). (kafka.server.DefaultAutoTopicCreationManager)\r\n {code}\r\nThe point where we log the auto creation outcome has two cases where it warn logs, but then this case is being handled by a catch all debug log. [https://github.com/apache/kafka/blob/18045c6ac30921503deffbef1744bb365dc599fb/core/src/main/scala/kafka/server/AutoTopicCreationManager.scala#L141]\r\n\r\nIf there's an error code set, maybe it should log at warn like the other cases? I'm happy to be assigned to this.", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=robyoung", "name": "robyoung", "key": "JIRAUSER298079", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Rob Young", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13626101/comment/18013446", "id": "18013446", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=schofielaj", "name": "schofielaj", "key": "schofielaj", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Andrew Schofield", "active": true, "timeZone": "Etc/UTC"}, "body": "[~robyoung] Thanks for this issue. It would be good to improve this area. I think we should also improve the instructions you followed, probably when share groups are enabled by default (AK 4.2, I hope). After all, we have specific configs in the config/server.properties that ship with AK to reflect the single-broker config requirements, and that's appropriate for what you did with Docker too I think.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=schofielaj", "name": "schofielaj", "key": "schofielaj", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Andrew Schofield", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-12T14:19:03.957+0000", "updated": "2025-08-12T14:19:03.957+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13626101/comment/18013522", "id": "18013522", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=robyoung", "name": "robyoung", "key": "JIRAUSER298079", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Rob Young", "active": true, "timeZone": "Etc/UTC"}, "body": "Hi [~schofielaj]. Yes the docker images work smoothly when you don't set any of the configuration environment variables, as the default configuration file tunes the replication factors/isrs down to 1. The docs make it pretty clear that if you are using environment variable configuration that you are responsible for configuring {_}everything{_}.\r\n\r\nI guess the examples of environment variable configuration [https://hub.docker.com/r/apache/kafka#overriding-the-default-broker-configuration] could be updated since they already contain the equivalent settings for the transaction state topic. I imagine these examples should represent a working single-node configuration that users can then modify.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=robyoung", "name": "robyoung", "key": "JIRAUSER298079", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34044", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34044", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34044", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34044"}, "displayName": "Rob Young", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-12T21:26:02.528+0000", "updated": "2025-08-12T21:32:05.944+0000"}], "maxResults": 2, "total": 2, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/5", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/trivial.svg", "name": "Trivial", "id": "5"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/5", "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png", "name": "Resolved", "id": "5", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}}}