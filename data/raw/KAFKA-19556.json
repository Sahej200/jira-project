{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13624787", "self": "https://issues.apache.org/jira/rest/api/2/issue/13624787", "key": "KAFKA-19556", "fields": {"summary": "[Connect] Provide a configuration to disable SNI required and SNI host checking for the REST API", "description": "h3. Summary\r\n\r\nThe upgrade to Jetty 12 in Kafka 4.0 enables a strict SNI host check by default for the Connect REST API. This change breaks HTTPS request forwarding between Connect workers when they connect via IP address, causing requests to fail with a 400: Invalid SNI error.\r\nh3. The Problem\r\n\r\nPrior to Kafka 4.0, the Jetty server used for the Connect REST API did not enforce a strict match between the TLS SNI hostname and the HTTP Host header.\r\n\r\nWith the upgrade to Jetty 12, this check is now enabled by default at the HTTP level. This causes legitimate HTTPS requests to fail in environments where the client connects using an IP address or a hostname that is not listed in the server's TLS certificate.\r\n\r\nThis results in the following error:\r\n{code:java}\r\norg.eclipse.jetty.http.BadMessageException: 400: Invalid SNI\r\n{code}\r\nh3. Impacted Use Case: Inter-Node Request Forwarding\r\n\r\nThis change specifically breaks the request forwarding mechanism between Connect workers in a common deployment scenario:\r\n # A follower Connect instance needs to forward a REST request to the leader.\r\n # The follower connects directly to the leader's IP address over HTTPS.\r\n # Security is handled by mTLS certificates, often managed by a custom certificate provider.\r\n\r\nThis setup worked flawlessly before Kafka 4.0. Now, because the follower connects via IP, the SNI check fails, and the forwarding mechanism is broken.\r\nh3. Proposed Solution\r\n\r\nThis behavior cannot be disabled through any existing Kafka Connect configuration. To restore the previous functionality, a SecureRequestCustomizer must be programmatically configured in RestServer.java to disable the SNI required and the SNI host check flags. This should be driven by a configuration value that allows disabling these SNI related settings.\r\n{code:java}\r\n// In RestServer.java, when building the HTTPS connector\r\nSecureRequestCustomizer customizer = new SecureRequestCustomizer();\r\ncustomizer.setSniRequired(false);\r\ncustomizer.setSniHostCheck(false);\r\nHttpConfiguration https = new HttpConfiguration();\r\nhttps.addCustomizer(customizer);\r\nconnector = new ServerConnector(jettyServer, ssl, new HttpConnectionFactory(https)); {code}", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=tkornai", "name": "tkornai", "key": "tkornai", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Tamas Kornai", "active": true, "timeZone": "Etc/UTC"}, "comment": {"comments": [{"self": "https://issues.apache.org/jira/rest/api/2/issue/13624787/comment/18013566", "id": "18013566", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=iamoshione", "name": "iamoshione", "key": "JIRAUSER308823", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "oshione gabriel esiemokhai", "active": true, "timeZone": "America/Toronto"}, "body": "if you disable sni how then can you locate different host names in the same web server ?", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=iamoshione", "name": "iamoshione", "key": "JIRAUSER308823", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "oshione gabriel esiemokhai", "active": true, "timeZone": "America/Toronto"}, "created": "2025-08-13T01:56:06.403+0000", "updated": "2025-08-13T01:56:06.403+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13624787/comment/18013597", "id": "18013597", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=tkornai", "name": "tkornai", "key": "tkornai", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Tamas Kornai", "active": true, "timeZone": "Etc/UTC"}, "body": "We are routing by IP.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=tkornai", "name": "tkornai", "key": "tkornai", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Tamas Kornai", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-13T07:18:59.067+0000", "updated": "2025-08-13T07:18:59.067+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13624787/comment/18013762", "id": "18013762", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=iamoshione", "name": "iamoshione", "key": "JIRAUSER308823", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "oshione gabriel esiemokhai", "active": true, "timeZone": "America/Toronto"}, "body": "Yes exactly so if there are multiple host names on the web server , without an sni it is possible you can get an error if the web server does not know what ssl to handshake you with. so there are some draw backs disabling this I think .", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=iamoshione", "name": "iamoshione", "key": "JIRAUSER308823", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "oshione gabriel esiemokhai", "active": true, "timeZone": "America/Toronto"}, "created": "2025-08-13T19:06:49.372+0000", "updated": "2025-08-13T19:06:49.372+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13624787/comment/18014100", "id": "18014100", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=tkornai", "name": "tkornai", "key": "tkornai", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Tamas Kornai", "active": true, "timeZone": "Etc/UTC"}, "body": "I'm not advocating to turning it off for everyone, I just hope to get a configuration setting exposed so it can be turned off for installations where it is causing issues.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=tkornai", "name": "tkornai", "key": "tkornai", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Tamas Kornai", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-15T12:30:19.095+0000", "updated": "2025-08-15T12:30:19.095+0000"}, {"self": "https://issues.apache.org/jira/rest/api/2/issue/13624787/comment/18014150", "id": "18014150", "author": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=gharris1727", "name": "gharris1727", "key": "gharris1727", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg Harris", "active": true, "timeZone": "Etc/UTC"}, "body": "[~tkornai] Thanks for the ticket!\r\n\r\nI believe this would require a new configuration, and so is subject to our KIP process: [https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Improvement+Proposals]\u00a0\r\n\r\nThis is a large time investment overall, and would only be possible to fix in a new minor version of Connect. To avoid falling behind new versions, I would recommend finding another workaround that does not involve code changes.\r\n\r\nPersonally, I'm not very familiar with SNI host checking, but I assume that Jetty has enabled it by default as part of encouraging security \"best practices.\" Perhaps it is best to conform to the new default, rather than invest effort in returning to the old behavior. We can also see from other users how important this functionality is.", "updateAuthor": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=gharris1727", "name": "gharris1727", "key": "gharris1727", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Greg Harris", "active": true, "timeZone": "Etc/UTC"}, "created": "2025-08-15T15:26:53.864+0000", "updated": "2025-08-15T15:26:53.864+0000"}], "maxResults": 5, "total": 5, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/1", "description": "The issue is open and ready for the assignee to start work on it.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png", "name": "Open", "id": "1", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2", "id": 2, "key": "new", "colorName": "blue-gray", "name": "To Do"}}}}