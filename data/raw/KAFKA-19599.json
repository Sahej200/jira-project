{"expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations", "id": "13626185", "self": "https://issues.apache.org/jira/rest/api/2/issue/13626185", "key": "KAFKA-19599", "fields": {"summary": "Reduce the frequency of ReplicaNotAvailableException thrown to clients when RLMM is not ready", "description": "During broker restarts, the topic-based RemoteLogMetadataManager constructs the state by reading the internal {{__remote_log_metadata}} topic. When the partition is not ready to perform remote storage operations, then [ReplicaNotAvailableException|https://sourcegraph.com/github.com/apache/kafka/-/blob/storage/src/main/java/org/apache/kafka/server/log/remote/metadata/storage/RemotePartitionMetadataStore.java?L127] thrown back to the consumer. The clients retries the request immediately.\u00a0\r\n\r\nThis result in lot of FetchConsumer requests on the broker and utilizes the request handler threads. Using CountdownLatch the frequency of ReplicaNotAvailableException thrown back to the clients can be reduced. This will improve the request handler thread usage on the broker.\r\n\r\nReproducer:\u00a0\r\n# Standalone one node cluster with LocalTieredStorage setup.\u00a0\r\n# Create a topic with remote storage enabled. RF = 1 and partitionCount = 2\r\n# Produce few message and ensure that the segments are uploaded to remote storage.\u00a0\r\n# Use console-consumer to read the produced messages from the beginning of the topic.\r\n# Update [RemoteLogMetadataPartitionStore|https://sourcegraph.com/github.com/apache/kafka/-/blob/storage/src/main/java/org/apache/kafka/server/log/remote/metadata/storage/RemotePartitionMetadataStore.java?L166] to micmic that the partition is not ready.\r\n# Replace the kafka-storage module jar and restart the broker.\u00a0\r\n# Start the console-consumer to read from the beginning of the topic.\u00a0\u00a0\r\n\r\n~9K FetchConsumer requests per second are received on the broker for one consumer [1107088 / (60 * 2) = ~9225 requests / sec per partition]:\r\n{code:java}\r\n% sh kafka-topics.sh --bootstrap-server localhost:9092  --topic apple --replication-factor 1 --partitions 2 --create  --config segment.bytes=1048576 --config local.retention.ms=60000 --config remote.storage.enable=true\r\n% sh kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic apple --from-beginning --property print.key=false --property print.value=false\r\n# broker logs\r\n % less nohup.out | grep \u00a0\"Error occurred while reading the remote data for 4ChgxqKOTPakBikyo0Thjw\" \u00a0| grep -c \"2025-08-12 21:18\" \r\n1107088\r\n{code}", "reporter": {"self": "https://issues.apache.org/jira/rest/api/2/user?username=ckamal", "name": "ckamal", "key": "ckamal", "avatarUrls": {"48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452", "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452", "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452", "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"}, "displayName": "Kamal Chandraprakash", "active": true, "timeZone": "Asia/Kolkata"}, "comment": {"comments": [], "maxResults": 0, "total": 0, "startAt": 0}, "priority": {"self": "https://issues.apache.org/jira/rest/api/2/priority/3", "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg", "name": "Major", "id": "3"}, "status": {"self": "https://issues.apache.org/jira/rest/api/2/status/5", "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.", "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png", "name": "Resolved", "id": "5", "statusCategory": {"self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3", "id": 3, "key": "done", "colorName": "green", "name": "Done"}}}}